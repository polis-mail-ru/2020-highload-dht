# Асинхронный клиент
Переключаем внутреннее взаимодействие узлов на асинхронный java.net.http.HttpClient. Параллельно отправляем запросы 
репликам и собираем подтверждения на CompletableFuture.
## Параметры машины

<b>CPU:</b> 1,2 GHz 4‑ядерный процессор Intel Core i7

<b>System:</b> Mac OS X (10.15.7)

<b>Architecture:</b> x86_64 64bit


## PUT
Запускаю wrk c такими параметрами:
+ 4 threads send requests
+ keeping 64 HTTP connections open
+ 30 seconds
+ constant throughput of 60000 requests per second

Результаты с async profiler-а (CPU):
![Flame graph from async profiler](put-cpu-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты с async profiler-а (ALLOC):
![Flame graph from async profiler](put-alloc-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты с async profiler-а (LOCK):
![Flame graph from async profiler](put-lock-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 4750.581ms, rate sampling interval: 17514ms
  Thread calibration: mean lat.: 4417.918ms, rate sampling interval: 16097ms
  Thread calibration: mean lat.: 4751.461ms, rate sampling interval: 17629ms
  Thread calibration: mean lat.: 4685.374ms, rate sampling interval: 17612ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    19.55s     5.71s   29.84s    58.06%
    Req/Sec    44.75      0.43    45.00    100.00%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   19.48s 
 75.000%   24.46s 
 90.000%   27.57s 
 99.000%   29.56s 
 99.900%   29.82s 
 99.990%   29.85s 
 99.999%   29.85s 
100.000%   29.85s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

    9093.119     0.000000            1         1.00
   11722.751     0.100000          359         1.11
   13664.255     0.200000          719         1.25
   15597.567     0.300000         1076         1.43
   17514.495     0.400000         1435         1.67
   19480.575     0.500000         1793         2.00
   20496.383     0.550000         1974         2.22
   21430.271     0.600000         2154         2.50
   22413.311     0.650000         2330         2.86
   23429.119     0.700000         2509         3.33
   24461.311     0.750000         2688         4.00
   25001.983     0.775000         2778         4.44
   25477.119     0.800000         2868         5.00
   26001.407     0.825000         2959         5.71
   26542.079     0.850000         3050         6.67
   27049.983     0.875000         3141         8.00
   27312.127     0.887500         3184         8.89
   27574.271     0.900000         3228        10.00
   27787.263     0.912500         3271        11.43
   28016.639     0.925000         3316        13.33
   28278.783     0.937500         3361        16.00
   28426.239     0.943750         3383        17.78
   28590.079     0.950000         3405        20.00
   28721.151     0.956250         3434        22.86
   28786.687     0.962500         3450        26.67
   28917.759     0.968750         3472        32.00
   28999.679     0.971875         3486        35.56
   29081.599     0.975000         3496        40.00
   29212.671     0.978125         3506        45.71
   29294.591     0.981250         3518        53.33
   29376.511     0.984375         3530        64.00
   29425.663     0.985938         3534        71.11
   29507.583     0.987500         3540        80.00
   29540.351     0.989062         3545        91.43
   29573.119     0.990625         3551       106.67
   29605.887     0.992188         3556       128.00
   29638.655     0.992969         3562       142.22
   29638.655     0.993750         3562       160.00
   29671.423     0.994531         3565       182.86
   29687.807     0.995313         3568       213.33
   29704.191     0.996094         3572       256.00
   29704.191     0.996484         3572       284.44
   29720.575     0.996875         3573       320.00
   29786.111     0.997266         3575       365.71
   29802.495     0.997656         3578       426.67
   29802.495     0.998047         3578       512.00
   29802.495     0.998242         3578       568.89
   29818.879     0.998437         3580       640.00
   29818.879     0.998633         3580       731.43
   29818.879     0.998828         3580       853.33
   29835.263     0.999023         3582      1024.00
   29835.263     0.999121         3582      1137.78
   29835.263     0.999219         3582      1280.00
   29835.263     0.999316         3582      1462.86
   29835.263     0.999414         3582      1706.67
   29851.647     0.999512         3584      2048.00
   29851.647     1.000000         3584          inf
#[Mean    =    19551.567, StdDeviation   =     5711.144]
#[Max     =    29835.264, Total count    =         3584]
#[Buckets =           27, SubBuckets     =         2048]
```


Итоги:
* обработали всего 624830 запросов
* прочитали 39.92MB данных 
* сервер обрабатывал 20828.75 запросов в секунду 



## GET
Запускаю wrk c такими параметрами:
+ 4 threads send requests
+ keeping 64 HTTP connections open
+ 30 seconds
+ constant throughput of 60000 requests per second

Результаты с async profiler-а (CPU):
![Flame graph from async profiler](get-cpu-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты с async profiler-а (ALLOC):
![Flame graph from async profiler](get-alloc-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты с async profiler-а (LOCK):
![Flame graph from async profiler](get-lock-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 4750.581ms, rate sampling interval: 17514ms
  Thread calibration: mean lat.: 4417.918ms, rate sampling interval: 16097ms
  Thread calibration: mean lat.: 4751.461ms, rate sampling interval: 17629ms
  Thread calibration: mean lat.: 4685.374ms, rate sampling interval: 17612ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    19.55s     5.71s   29.84s    58.06%
    Req/Sec    44.75      0.43    45.00    100.00%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   19.48s 
 75.000%   24.46s 
 90.000%   27.57s 
 99.000%   29.56s 
 99.900%   29.82s 
 99.990%   29.85s 
 99.999%   29.85s 
100.000%   29.85s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

    9093.119     0.000000            1         1.00
   11722.751     0.100000          359         1.11
   13664.255     0.200000          719         1.25
   15597.567     0.300000         1076         1.43
   17514.495     0.400000         1435         1.67
   19480.575     0.500000         1793         2.00
   20496.383     0.550000         1974         2.22
   21430.271     0.600000         2154         2.50
   22413.311     0.650000         2330         2.86
   23429.119     0.700000         2509         3.33
   24461.311     0.750000         2688         4.00
   25001.983     0.775000         2778         4.44
   25477.119     0.800000         2868         5.00
   26001.407     0.825000         2959         5.71
   26542.079     0.850000         3050         6.67
   27049.983     0.875000         3141         8.00
   27312.127     0.887500         3184         8.89
   27574.271     0.900000         3228        10.00
   27787.263     0.912500         3271        11.43
   28016.639     0.925000         3316        13.33
   28278.783     0.937500         3361        16.00
   28426.239     0.943750         3383        17.78
   28590.079     0.950000         3405        20.00
   28721.151     0.956250         3434        22.86
   28786.687     0.962500         3450        26.67
   28917.759     0.968750         3472        32.00
   28999.679     0.971875         3486        35.56
   29081.599     0.975000         3496        40.00
   29212.671     0.978125         3506        45.71
   29294.591     0.981250         3518        53.33
   29376.511     0.984375         3530        64.00
   29425.663     0.985938         3534        71.11
   29507.583     0.987500         3540        80.00
   29540.351     0.989062         3545        91.43
   29573.119     0.990625         3551       106.67
   29605.887     0.992188         3556       128.00
   29638.655     0.992969         3562       142.22
   29638.655     0.993750         3562       160.00
   29671.423     0.994531         3565       182.86
   29687.807     0.995313         3568       213.33
   29704.191     0.996094         3572       256.00
   29704.191     0.996484         3572       284.44
   29720.575     0.996875         3573       320.00
   29786.111     0.997266         3575       365.71
   29802.495     0.997656         3578       426.67
   29802.495     0.998047         3578       512.00
   29802.495     0.998242         3578       568.89
   29818.879     0.998437         3580       640.00
   29818.879     0.998633         3580       731.43
   29818.879     0.998828         3580       853.33
   29835.263     0.999023         3582      1024.00
   29835.263     0.999121         3582      1137.78
   29835.263     0.999219         3582      1280.00
   29835.263     0.999316         3582      1462.86
   29835.263     0.999414         3582      1706.67
   29851.647     0.999512         3584      2048.00
   29851.647     1.000000         3584          inf
#[Mean    =    19551.567, StdDeviation   =     5711.144]
#[Max     =    29835.264, Total count    =         3584]
#[Buckets =           27, SubBuckets     =         2048]
```

Итоги:
* обработали всего 623839 запросов
* прочитали 40.03MB данных 
* сервер обрабатывал 20795.12 запросов в секунду 

## Вывод.
Время обработки запроса возросло, но число таймаутов снизилось, по сравнению с предыдущей версией. 
