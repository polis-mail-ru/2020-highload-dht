Для нагрузочного тестирования сервера, а также измерения параметров была использована программа wrk, а также профайлер под названием async-profiler. 
Запросы были сделаны на локальный хост по адресу http://127.0.0.1:8080.

Сначала база была заполнена данными, а после мы отправляли запросы на получение этих данных.

На третьем этапе, а именно после реализации асинхронной обработки запросов, мы сравним результаты второго и третьего этапа, а если быть точнее, то обработку запросов синхронным сервером (когда селектор, кроме работы с сокетами, также занимается обработкой запросов, что плохо сказывается на произ-сти, т.к. в это время поток селектора занят обработкой и не может работать с сокетами) и асинхронным сервером(когда задачи по обработке запросов мы выносим в отдельный пул потоков, затем поток заканчивая работы записывает данные в сокет, у синхронного же сервера вся эта работа делается потоком селектора).

Посмотрим на Put-запросы асинхронного сервера. Зададим 64 соединения, 4 потока и кол-во запросов зададим 2к. 
wrk -t4 -c64 -d1m -s wrk/put.lua -R2000 --latency http://127.0.0.1:8080

wrk -t4 -c64 -d1m -s wrk/put.lua -R2000 --latency http://127.0.0.1:8080
Running 1m test @ http://127.0.0.1:8080
  
  
  Thread Stats   Avg      Stdev     Max   +/- Stdev
  
    Latency   155.80ms  248.00ms   1.18s    82.48%
    
    Req/Sec   499.82    184.84     1.11k    73.48%
    
  Latency Distribution (HdrHistogram - Recorded Latency)
  
 50.000%    2.53ms
 
 75.000%  279.81ms
 
 90.000%  543.74ms
 
 99.000%  952.83ms
 
 99.900%    1.11s 
 
 99.990%    1.16s 
 
 99.999%    1.18s 
 
100.000%    1.18s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.134     0.000000            1         1.00
       0.976     0.100000         9927         1.11
       1.339     0.200000        19859         1.25
       1.658     0.300000        29767         1.43
       2.013     0.400000        39669         1.67
       2.529     0.500000        49590         2.00
       2.993     0.550000        54538         2.22
       4.707     0.600000        59495         2.50
      84.095     0.650000        64450         2.86
     186.623     0.700000        69411         3.33
     279.807     0.750000        74369         4.00
     324.095     0.775000        76853         4.44
     365.311     0.800000        79324         5.00
     404.479     0.825000        81808         5.71
     446.207     0.850000        84299         6.67
     485.631     0.875000        86762         8.00
     506.879     0.887500        88000         8.89
     543.743     0.900000        89245        10.00
     582.655     0.912500        90482        11.43
     624.639     0.925000        91728        13.33
     665.599     0.937500        92957        16.00
     686.079     0.943750        93583        17.78
     706.559     0.950000        94204        20.00
     730.111     0.956250        94817        22.86
     758.783     0.962500        95442        26.67
     790.527     0.968750        96063        32.00
     808.447     0.971875        96368        35.56
     825.343     0.975000        96676        40.00
     847.871     0.978125        96985        45.71
     874.495     0.981250        97293        53.33
     900.095     0.984375        97605        64.00
     912.383     0.985938        97764        71.11
     926.719     0.987500        97913        80.00
     944.127     0.989062        98070        91.43
     961.535     0.990625        98225       106.67
     977.407     0.992188        98378       128.00
     989.183     0.992969        98461       142.22
    1001.983     0.993750        98535       160.00
    1014.271     0.994531        98610       182.86
    1030.143     0.995313        98690       213.33
    1041.919     0.996094        98765       256.00
    1050.623     0.996484        98808       284.44
    1055.743     0.996875        98848       320.00
    1061.887     0.997266        98885       365.71
    1070.079     0.997656        98923       426.67
    1080.319     0.998047        98960       512.00
    1087.487     0.998242        98978       568.89
    1094.655     0.998437        99001       640.00
    1099.775     0.998633        99018       731.43
    1106.943     0.998828        99039       853.33
    1114.111     0.999023        99058      1024.00
    1116.159     0.999121        99065      1137.78
    1121.279     0.999219        99075      1280.00
    1124.351     0.999316        99085      1462.86
    1128.447     0.999414        99096      1706.67
    1132.543     0.999512        99104      2048.00
    1135.615     0.999561        99111      2275.56
    1138.687     0.999609        99117      2560.00
    1140.735     0.999658        99119      2925.71
    1143.807     0.999707        99125      3413.33
    1147.903     0.999756        99129      4096.00
    1148.927     0.999780        99133      4551.11
    1148.927     0.999805        99133      5120.00
    1154.047     0.999829        99136      5851.43
    1155.071     0.999854        99138      6826.67
    1157.119     0.999878        99140      8192.00
    1159.167     0.999890        99142      9102.22
    1160.191     0.999902        99145     10240.00
    1160.191     0.999915        99145     11702.86
    1160.191     0.999927        99145     13653.33
    1162.239     0.999939        99146     16384.00
    1165.311     0.999945        99147     18204.44
    1168.383     0.999951        99149     20480.00
    1168.383     0.999957        99149     23405.71
    1168.383     0.999963        99149     27306.67
    1168.383     0.999969        99149     32768.00
    1176.575     0.999973        99150     36408.89
    1176.575     0.999976        99150     40960.00
    1176.575     0.999979        99150     46811.43
    1177.599     0.999982        99151     54613.33
    1177.599     0.999985        99151     65536.00
    1177.599     0.999986        99151     72817.78
    1177.599     0.999988        99151     81920.00
    1177.599     0.999989        99151     93622.86
    1178.623     0.999991        99152    109226.67
    1178.623     1.000000        99152          inf


  119262 requests in 1.00m, 10.58MB read
  
Requests/sec:   1981.52

Transfer/sec:    179.96KB

Сервер держит обработку 2к запросов в секунду.

Посмотрим на Put-запросы синхронного сервера. Зададим 16 соединений, 4 потока и кол-во запросов зададим 2к. 
wrk -t4 -c16 -d1m -s wrk/put.lua -R2000 --latency http://127.0.0.1:8080


wrk -t4 -c16 -d1m -s wrk/put.lua -R2000 --latency http://127.0.0.1:8080
Running 1m test @ http://127.0.0.1:8080
  4 threads and 16 connections
 
  Thread Stats   Avg      Stdev     Max   +/- Stdev
  
    Latency    55.62ms  143.98ms   1.10s    88.89%
    
    Req/Sec   509.41    182.63     1.50k    82.90%
    
  Latency Distribution (HdrHistogram - Recorded Latency)
  
 50.000%    1.93ms
 
 75.000%    3.51ms
 
 90.000%  237.57ms
 
 99.000%  691.20ms
 
 99.900%  978.43ms
 
 99.990%    1.08s 
 
 99.999%    1.10s 
 
100.000%    1.10s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.095     0.000000            1         1.00
       0.896     0.100000         9999         1.11
       1.198     0.200000        20001         1.25
       1.440     0.300000        30032         1.43
       1.671     0.400000        40000         1.67
       1.932     0.500000        49994         2.00
       2.089     0.550000        55030         2.22
       2.277     0.600000        60001         2.50
       2.515     0.650000        64981         2.86
       2.865     0.700000        69974         3.33
       3.509     0.750000        74967         4.00
       4.215     0.775000        77469         4.44
       6.387     0.800000        79969         5.00
      23.999     0.825000        82463         5.71
      91.519     0.850000        84961         6.67
     158.207     0.875000        87467         8.00
     195.071     0.887500        88714         8.89
     237.567     0.900000        89960        10.00
     280.319     0.912500        91209        11.43
     321.791     0.925000        92466        13.33
     366.335     0.937500        93707        16.00
     390.143     0.943750        94337        17.78
     413.695     0.950000        94959        20.00
     436.479     0.956250        95586        22.86
     457.727     0.962500        96212        26.67
     479.231     0.968750        96839        32.00
     488.959     0.971875        97143        35.56
     498.687     0.975000        97461        40.00
     514.303     0.978125        97769        45.71
     556.543     0.981250        98080        53.33
     597.503     0.984375        98394        64.00
     619.007     0.985938        98551        71.11
     644.607     0.987500        98706        80.00
     672.767     0.989062        98861        91.43
     705.535     0.990625        99019       106.67
     735.743     0.992188        99175       128.00
     751.103     0.992969        99255       142.22
     765.439     0.993750        99332       160.00
     780.287     0.994531        99409       182.86
     793.599     0.995313        99488       213.33
     809.471     0.996094        99565       256.00
     823.295     0.996484        99604       284.44
     836.095     0.996875        99642       320.00
     849.407     0.997266        99681       365.71
     865.791     0.997656        99720       426.67
     887.295     0.998047        99759       512.00
     905.215     0.998242        99779       568.89
     921.599     0.998437        99798       640.00
     933.375     0.998633        99818       731.43
     956.415     0.998828        99837       853.33
     979.967     0.999023        99857      1024.00
     988.159     0.999121        99868      1137.78
     993.279     0.999219        99876      1280.00
    1001.471     0.999316        99889      1462.86
    1007.103     0.999414        99896      1706.67
    1017.343     0.999512        99907      2048.00
    1020.415     0.999561        99912      2275.56
    1023.487     0.999609        99915      2560.00
    1029.631     0.999658        99920      2925.71
    1036.287     0.999707        99925      3413.33
    1042.943     0.999756        99930      4096.00
    1047.551     0.999780        99933      4551.11
    1050.623     0.999805        99935      5120.00
    1051.647     0.999829        99937      5851.43
    1055.743     0.999854        99940      6826.67
    1067.007     0.999878        99942      8192.00
    1075.199     0.999890        99944      9102.22
    1079.295     0.999902        99945     10240.00
    1084.415     0.999915        99946     11702.86
    1086.463     0.999927        99947     13653.33
    1092.607     0.999939        99948     16384.00
    1094.655     0.999945        99949     18204.44
    1097.727     0.999951        99951     20480.00
    1097.727     0.999957        99951     23405.71
    1097.727     0.999963        99951     27306.67
    1097.727     0.999969        99951     32768.00
    1098.751     0.999973        99952     36408.89
    1098.751     0.999976        99952     40960.00
    1098.751     0.999979        99952     46811.43
    1101.823     0.999982        99953     54613.33
    1101.823     0.999985        99953     65536.00
    1101.823     0.999986        99953     72817.78
    1101.823     0.999988        99953     81920.00
    1101.823     0.999989        99953     93622.86
    1103.871     0.999991        99954    109226.67
    1103.871     1.000000        99954          inf
    
  119988 requests in 1.00m, 10.64MB read
  
Requests/sec:   1999.78

Transfer/sec:    181.62KB

Как видим, у асинхронного сервера 99% запросов выполняется за 952.83ms, у синхронного сервера за 691.20ms.

Проведем профилирование с помощью async-profiler.

CpuPut async
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Async/CPUPut.svg)
Видно, что считывание данных(а также парсинг и т.п.) из сокета и обработка запросов выполняются разными потоками. А именно селекторами и воркерами.

CpuPut sync
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Sync/CpuPut.svg)
здесь видно как сначала селектор считывает и парсит из сокета данные, а затем этот же поток выполняет обработку запроса.

Как видно, теперь за обработку запросов (put, get and etc) отвечает наш пул потоков, который мы выделили, таким образом вы разгружаем наши селекторы. На рисунке CpuPut sync видно, что операция вставки выполняется основным потоком, а у асинхронного сервера основной поток передает работу в отдельный поток, а сам занимается работой с своими сокетами.

AllocPut Async
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Async/AllocPut.svg)

Здесь сохраняется та же самая картина, теперь выделение памяти в куче происходит как селекторами, так и ворверками. Воркеры больше аллоцируют память, обычно один воркер
занимает около 18% на графике, а селектор около 5%

AllocPut Sync
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Sync/AllocPut.svg)
У синхронного сервера память выделяется только потокома селектора соответственно.

LockPut Async
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Async/LockPut.svg)

LockPut Sync
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Sync/LockPut.svg)

В отличие от синхронного сервера, асинхронный при запросе put имеет критические секции, т.к. экзекьютор сервис имеет в себе ArrayBlockingQueue, в котором содержатся запросы для обработки.

Далее рассмотрим Put-запросы.

Для этого выполним аналогичные команды, что были выполнены выше, но теперь вызываем скрипт для отправки запроса get.

Результаты работы wrk на асинхронном сервере с 64 соединениями, 4 потоками и 2к запросами.

wrk -t4 -c64 -d1m -s wrk/get.lua -R2000 --latency http://127.0.0.1:8080

  Latency Distribution (HdrHistogram - Recorded Latency)
  
 50.000%    1.69ms
 
 75.000%    2.47ms
 
 90.000%  162.82ms
 
 99.000%  613.89ms
 
 99.900%  893.44ms
 
 99.990%  955.39ms
 
 99.999%  969.73ms
 
100.000%  988.16ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.131     0.000000            1         1.00
       0.797     0.100000         9990         1.11
       1.071     0.200000        19994         1.25
       1.293     0.300000        29989         1.43
       1.492     0.400000        39958         1.67
       1.692     0.500000        49938         2.00
       1.801     0.550000        54947         2.22
       1.918     0.600000        59946         2.50
       2.055     0.650000        64914         2.86
       2.227     0.700000        69929         3.33
       2.471     0.750000        74898         4.00
       2.661     0.775000        77398         4.44
       2.945     0.800000        79878         5.00
       3.539     0.825000        82368         5.71
       7.659     0.850000        84864         6.67
      74.303     0.875000        87362         8.00
     117.311     0.887500        88608         8.89
     162.815     0.900000        89860        10.00
     208.511     0.912500        91105        11.43
     257.919     0.925000        92354        13.33
     307.967     0.937500        93600        16.00
     333.567     0.943750        94226        17.78
     358.911     0.950000        94855        20.00
     385.279     0.956250        95475        22.86
     411.903     0.962500        96096        26.67
     436.991     0.968750        96728        32.00
     449.279     0.971875        97039        35.56
     460.287     0.975000        97346        40.00
     473.087     0.978125        97659        45.71
     482.815     0.981250        97974        53.33
     496.639     0.984375        98282        64.00
     503.807     0.985938        98438        71.11
     538.623     0.987500        98593        80.00
     585.215     0.989062        98748        91.43
     632.831     0.990625        98905       106.67
     678.911     0.992188        99060       128.00
     702.463     0.992969        99138       142.22
     726.527     0.993750        99216       160.00
     751.103     0.994531        99295       182.86
     776.703     0.995313        99372       213.33
     801.791     0.996094        99450       256.00
     815.615     0.996484        99489       284.44
     827.903     0.996875        99529       320.00
     840.191     0.997266        99571       365.71
     852.479     0.997656        99606       426.67
     864.767     0.998047        99646       512.00
     870.399     0.998242        99666       568.89
     876.543     0.998437        99684       640.00
     883.711     0.998633        99704       731.43
     889.343     0.998828        99724       853.33
     894.975     0.999023        99745      1024.00
     898.559     0.999121        99755      1137.78
     903.167     0.999219        99762      1280.00
     907.263     0.999316        99772      1462.86
     911.359     0.999414        99783      1706.67
     916.991     0.999512        99792      2048.00
     919.551     0.999561        99798      2275.56
     922.111     0.999609        99801      2560.00
     928.255     0.999658        99806      2925.71
     931.839     0.999707        99811      3413.33
     936.959     0.999756        99816      4096.00
     940.031     0.999780        99819      4551.11
     941.055     0.999805        99821      5120.00
     942.079     0.999829        99823      5851.43
     946.687     0.999854        99826      6826.67
     949.247     0.999878        99828      8192.00
     955.391     0.999890        99830      9102.22
     957.439     0.999902        99831     10240.00
     958.975     0.999915        99832     11702.86
     959.999     0.999927        99833     13653.33
     962.047     0.999939        99834     16384.00
     965.119     0.999945        99836     18204.44
     965.119     0.999951        99836     20480.00
     965.119     0.999957        99836     23405.71
     965.631     0.999963        99837     27306.67
     965.631     0.999969        99837     32768.00
     967.679     0.999973        99838     36408.89
     967.679     0.999976        99838     40960.00
     967.679     0.999979        99838     46811.43
     969.727     0.999982        99839     54613.33
     969.727     0.999985        99839     65536.00
     969.727     0.999986        99839     72817.78
     969.727     0.999988        99839     81920.00
     969.727     0.999989        99839     93622.86
     988.159     0.999991        99840    109226.67
     988.159     1.000000        99840          inf

  119952 requests in 1.00m, 11.23MB read
  
  Non-2xx or 3xx responses: 589
  
Requests/sec:   1999.16

Transfer/sec:    191.62KB


Выполним ту же команду только теперь используя 16 соединений для синхронного сервера.

wrk -t4 -c16 -d1m -s wrk/get.lua -R2000 --latency http://127.0.0.1:8080

  
  Latency Distribution (HdrHistogram - Recorded Latency)
  
 50.000%    1.45ms
 
 75.000%    1.99ms
 
 90.000%    2.64ms
 
 99.000%  316.93ms
 
 99.900%  494.59ms
 
 99.990%  514.30ms
 
 99.999%  523.26ms
 
100.000%  524.80ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.097     0.000000            1         1.00
       0.653     0.100000         9995         1.11
       0.899     0.200000        19937         1.25
       1.094     0.300000        29915         1.43
       1.271     0.400000        39857         1.67
       1.453     0.500000        49848         2.00
       1.547     0.550000        54822         2.22
       1.644     0.600000        59799         2.50
       1.748     0.650000        64768         2.86
       1.862     0.700000        69769         3.33
       1.988     0.750000        74760         4.00
       2.059     0.775000        77277         4.44
       2.139     0.800000        79766         5.00
       2.229     0.825000        82208         5.71
       2.339     0.850000        84710         6.67
       2.471     0.875000        87203         8.00
       2.547     0.887500        88433         8.89
       2.637     0.900000        89692        10.00
       2.741     0.912500        90932        11.43
       2.871     0.925000        92179        13.33
       3.059     0.937500        93416        16.00
       3.197     0.943750        94042        17.78
       3.401     0.950000        94659        20.00
       3.753     0.956250        95284        22.86
       4.551     0.962500        95905        26.67
       7.015     0.968750        96527        32.00
       9.879     0.971875        96838        35.56
      17.455     0.975000        97149        40.00
      39.711     0.978125        97461        45.71
     115.583     0.981250        97772        53.33
     191.871     0.984375        98085        64.00
     226.943     0.985938        98239        71.11
     262.399     0.987500        98397        80.00
     297.215     0.989062        98553        91.43
     331.519     0.990625        98706       106.67
     365.055     0.992188        98862       128.00
     380.159     0.992969        98940       142.22
     396.287     0.993750        99018       160.00
     412.415     0.994531        99097       182.86
     428.543     0.995313        99175       213.33
     446.463     0.996094        99251       256.00
     455.423     0.996484        99290       284.44
     462.591     0.996875        99330       320.00
     468.991     0.997266        99369       365.71
     474.879     0.997656        99408       426.67
     480.767     0.998047        99446       512.00
     483.583     0.998242        99465       568.89
     486.399     0.998437        99485       640.00
     489.471     0.998633        99505       731.43
     491.775     0.998828        99524       853.33
     494.847     0.999023        99543      1024.00
     496.127     0.999121        99555      1137.78
     497.663     0.999219        99563      1280.00
     498.687     0.999316        99572      1462.86
     500.479     0.999414        99583      1706.67
     502.271     0.999512        99592      2048.00
     503.039     0.999561        99597      2275.56
     504.063     0.999609        99602      2560.00
     505.087     0.999658        99606      2925.71
     505.855     0.999707        99611      3413.33
     508.415     0.999756        99616      4096.00
     509.951     0.999780        99621      4551.11
     509.951     0.999805        99621      5120.00
     511.487     0.999829        99623      5851.43
     511.999     0.999854        99626      6826.67
     512.511     0.999878        99628      8192.00
     514.303     0.999890        99630      9102.22
     515.071     0.999902        99631     10240.00
     516.095     0.999915        99632     11702.86
     516.863     0.999927        99633     13653.33
     517.375     0.999939        99634     16384.00
     518.655     0.999945        99635     18204.44
     518.911     0.999951        99637     20480.00
     518.911     0.999957        99637     23405.71
     518.911     0.999963        99637     27306.67
     518.911     0.999969        99637     32768.00
     520.703     0.999973        99638     36408.89
     520.703     0.999976        99638     40960.00
     520.703     0.999979        99638     46811.43
     523.263     0.999982        99639     54613.33
     523.263     0.999985        99639     65536.00
     523.263     0.999986        99639     72817.78
     523.263     0.999988        99639     81920.00
     523.263     0.999989        99639     93622.86
     524.799     0.999991        99640    109226.67
     524.799     1.000000        99640          inf


  119370 requests in 1.00m, 11.19MB read
  
Requests/sec:   1989.49

Transfer/sec:    190.97KB

Как видно синхронный сервер обрабатывает 99.000% запросов за 316.93ms, а асинхронный обрабатывае 99.000% запросов за 613.89ms


Далее проведем профилирование с помощью async-profiler.

CpuGet Async
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Async/CPUGet.svg)

CpuGet Sync 
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Sync/CpuGet.svg)

Если раньше(тобишь у синхронного сервера) чтение из сокета и обработка запроса выполнялось одним потоком, то теперь обработкой запросов заняты воркеры, что позволяет освободить
наши селекторы, тем самым избегая блокировок при чтение данных их сокета, т.к. раньше они могли быть заняты обработкой запроса и не иметь возможности обслуживать сокеты.

AllocGet Async
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Async/AllocGet.svg)
Как видно по графику при запросе get один воркер занимает около 13% графика, а селектор 8%, что говорит о том, что воркеры аллоцируют больше памяти.

AllocGet Sync
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Sync/AllocGet.svg)

LockGet Async
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Async/LockGet.svg)
Как видно воркеры имеют критические секции, что обусловлено реализацией RocksDB, селекторы же блокируются, т.к. не имееют никого отношения в методам RocksDB.

LockGet Sync
![](https://github.com/Basta123/2020-highload-dht/blob/stage-3/profiling/Stage3/Sync/LockGet.svg)
Селекторы у синхронного сервера блокируются, т.к. именно они обрабатывают запросы get, который блокируется в связи с реализацией RocksDB.


 

