# Анализ результатов

## Параметры машины

<b>CPU:</b> 1,2 GHz 4‑ядерный процессор Intel Core i7

<b>System:</b> Mac OS X (10.15.7)

<b>Architecture:</b> x86_64 64bit

## VisualVM
#### Вкладка Threads:
![Screen from visual vm threads](visual-vm-threads.png?raw=true "Screen from visual vm threads")
8 новых потоков-воркеров (в работе)

#### Вкладка Monitor:
![Screen from visual vm monitor](visual-vm-monitor.png?raw=true "Screen from visual vm monitor")
- Количество потоков увеличилось на нижнем правом графике.
- На графике CPU:
  - 3 башенки путов (40%)
  - 4 гетов (25%)
  - далее - профилирование под предельной нагрузкой (50%)

## PUT
### 1
Запускаю wrk c такими параметрами:
+ 4 threads (worker) send requests
+ keeping 16 HTTP connections open
+ 30 seconds
+ constant throughput of 32000 requests per second

Результаты с async profiler-а (CPU):
![Flame graph from async profiler](put-cpu-4-16-30-32000.svg?raw=true "Flame graph from async profiler")
Каждая "стопочка" worker-а (примерно 10% общей памяти на каждый поток) делится на 3 "башенки":
- примерно 1% - LinkedBlockingQueue
- примерно 1% - HttpSession
- примерно 98% - DAO

Результаты с async profiler-а (ALLOC):
![Flame graph from async profiler](put-alloc-4-16-30-32000.svg?raw=true "Flame graph from async profiler")
Для каждого отдельного воркера картинка не отличается от предыдущих этапов, но самих
 воркеров теперь стало 8. Селекторы отдельно занимаются чтением из сокета и парсингом запросов.

Результаты с async profiler-а (LOCK):
![Flame graph from async profiler](put-lock-4-16-30-32000.svg?raw=true "Flame graph from async profiler")


Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 2.114ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.049ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.990ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.055ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.18ms    9.85ms  80.13ms   92.14%
    Req/Sec     8.45k     1.08k   16.20k    76.77%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.29ms
 75.000%    1.97ms
 90.000%    7.14ms
 99.000%   54.01ms
 99.900%   68.99ms
 99.990%   78.91ms
 99.999%   80.00ms
100.000%   80.19ms
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)
       0.067     0.000000            2         1.00
       0.462     0.100000        64088         1.11
       0.690     0.200000       128051         1.25
       0.903     0.300000       191899         1.43
       1.101     0.400000       255816         1.67
       1.292     0.500000       319816         2.00
       1.394     0.550000       351939         2.22
       1.503     0.600000       383697         2.50
       1.628     0.650000       415739         2.86
       1.776     0.700000       447672         3.33
       1.965     0.750000       479603         4.00
       2.087     0.775000       495708         4.44
       2.239     0.800000       511489         5.00
       2.461     0.825000       527562         5.71
       2.891     0.850000       543457         6.67
       4.207     0.875000       559440         8.00
       5.339     0.887500       567430         8.89
       7.135     0.900000       575410        10.00
      10.255     0.912500       583405        11.43
      15.799     0.925000       591396        13.33
      21.855     0.937500       599389        16.00
      24.991     0.943750       603396        17.78
      27.679     0.950000       607381        20.00
      30.719     0.956250       611376        22.86
      33.471     0.962500       615384        26.67
      36.383     0.968750       619396        32.00
      37.919     0.971875       621375        35.56
      39.647     0.975000       623398        40.00
      41.375     0.978125       625393        45.71
      43.359     0.981250       627372        53.33
      46.079     0.984375       629375        64.00
      47.807     0.985938       630365        71.11
      50.047     0.987500       631360        80.00
      52.575     0.989062       632352        91.43
      54.975     0.990625       633362       106.67
      56.575     0.992188       634366       128.00
      57.567     0.992969       634848       142.22
      58.399     0.993750       635364       160.00
      59.071     0.994531       635848       182.86
      59.903     0.995313       636360       213.33
      60.639     0.996094       636858       256.00
      60.991     0.996484       637107       284.44
      61.631     0.996875       637353       320.00
      62.559     0.997266       637600       365.71
      63.967     0.997656       637853       426.67
      65.023     0.998047       638096       512.00
      65.599     0.998242       638234       568.89
      66.239     0.998437       638345       640.00
      67.327     0.998633       638474       731.43
      68.351     0.998828       638603       853.33
      69.183     0.999023       638728      1024.00
      69.503     0.999121       638787      1137.78
      69.887     0.999219       638851      1280.00
      71.039     0.999316       638907      1462.86
      72.511     0.999414       638970      1706.67
      73.919     0.999512       639033      2048.00
      74.431     0.999561       639062      2275.56
      75.199     0.999609       639093      2560.00
      76.095     0.999658       639124      2925.71
      76.479     0.999707       639159      3413.33
      77.119     0.999756       639186      4096.00
      77.631     0.999780       639202      4551.11
      77.887     0.999805       639221      5120.00
      78.143     0.999829       639237      5851.43
      78.463     0.999854       639253      6826.67
      78.719     0.999878       639266      8192.00
      78.847     0.999890       639275      9102.22
      78.975     0.999902       639291     10240.00
      78.975     0.999915       639291     11702.86
      79.103     0.999927       639299     13653.33
      79.231     0.999939       639310     16384.00
      79.231     0.999945       639310     18204.44
      79.295     0.999951       639312     20480.00
      79.423     0.999957       639317     23405.71
      79.487     0.999963       639320     27306.67
      79.551     0.999969       639324     32768.00
      79.615     0.999973       639325     36408.89
      79.743     0.999976       639327     40960.00
      79.807     0.999979       639330     46811.43
      79.871     0.999982       639333     54613.33
      79.871     0.999985       639333     65536.00
      79.935     0.999986       639335     72817.78
      79.935     0.999988       639335     81920.00
      79.999     0.999989       639336     93622.86
      80.063     0.999991       639337    109226.67
      80.127     0.999992       639340    131072.00
      80.127     0.999993       639340    145635.56
      80.127     0.999994       639340    163840.00
      80.127     0.999995       639340    187245.71
      80.127     0.999995       639340    218453.33
      80.127     0.999996       639340    262144.00
      80.127     0.999997       639340    291271.11
      80.191     0.999997       639342    327680.00
      80.191     1.000000       639342          inf
#[Mean    =        4.177, StdDeviation   =        9.855]
#[Max     =       80.128, Total count    =       639342]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  959704 requests in 30.00s, 61.32MB read
Requests/sec:  31991.33
Transfer/sec:      2.04MB
```

Итоги:
* обработали всего 959704 запросов
* прочитали 61.32MB данных 
* за 0.067 миллисекунд обработали 1ый запрос
* за 80.191  миллисекунд обработали 639342 запросов
* сервер обрабатывал 31991.33 запросов в секунду 

### С большим количеством соединений
Запускаю wrk c такими параметрами:
+ 4 threads (worker) send requests
+ keeping 64 HTTP connections open
+ 30 seconds
+ constant throughput of 10000 requests per second

Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 1979.550ms, rate sampling interval: 7475ms
  Thread calibration: mean lat.: 1978.948ms, rate sampling interval: 7475ms
  Thread calibration: mean lat.: 1979.569ms, rate sampling interval: 7475ms
  Thread calibration: mean lat.: 1979.892ms, rate sampling interval: 7475ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     9.15s     3.09s   15.43s    59.77%
    Req/Sec    11.84k   673.01    12.52k    62.50%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    8.90s 
 75.000%   11.54s 
 90.000%   13.71s 
 99.000%   15.26s 
 99.900%   15.39s 
 99.990%   15.42s 
 99.999%   15.43s 
100.000%   15.43s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

    4313.087     0.000000            3         1.00
    5099.519     0.100000        88408         1.11
    5992.447     0.200000       176883         1.25
    7008.255     0.300000       265378         1.43
    7880.703     0.400000       353642         1.67
    8896.511     0.500000       442292         2.00
    9445.375     0.550000       486423         2.22
    9986.047     0.600000       530960         2.50
   10518.527     0.650000       575125         2.86
   11018.239     0.700000       619478         3.33
   11542.527     0.750000       663154         4.00
   11886.591     0.775000       685235         4.44
   12181.503     0.800000       707144         5.00
   12525.567     0.825000       729468         5.71
   12951.551     0.850000       751508         6.67
   13352.959     0.875000       773768         8.00
   13524.991     0.887500       784594         8.89
   13705.215     0.900000       795591        10.00
   13828.095     0.912500       806707        11.43
   14041.087     0.925000       817653        13.33
   14286.847     0.937500       828989        16.00
   14401.535     0.943750       834264        17.78
   14508.031     0.950000       839723        20.00
   14630.911     0.956250       845344        22.86
   14745.599     0.962500       850730        26.67
   14868.479     0.968750       856266        32.00
   14925.823     0.971875       859105        35.56
   14983.167     0.975000       862031        40.00
   15056.895     0.978125       864750        45.71
   15114.239     0.981250       867616        53.33
   15163.391     0.984375       870103        64.00
   15187.967     0.985938       871485        71.11
   15212.543     0.987500       872852        80.00
   15245.311     0.989062       874256        91.43
   15278.079     0.990625       875959       106.67
   15302.655     0.992188       877433       128.00
   15310.847     0.992969       877973       142.22
   15319.039     0.993750       878515       160.00
   15327.231     0.994531       879076       182.86
   15343.615     0.995313       880156       213.33
   15351.807     0.996094       880691       256.00
   15359.999     0.996484       881210       284.44
   15359.999     0.996875       881210       320.00
   15368.191     0.997266       881720       365.71
   15376.383     0.997656       882180       426.67
   15376.383     0.998047       882180       512.00
   15384.575     0.998242       882664       568.89
   15384.575     0.998437       882664       640.00
   15392.767     0.998633       883078       731.43
   15392.767     0.998828       883078       853.33
   15392.767     0.999023       883078      1024.00
   15400.959     0.999121       883421      1137.78
   15400.959     0.999219       883421      1280.00
   15400.959     0.999316       883421      1462.86
   15400.959     0.999414       883421      1706.67
   15409.151     0.999512       883691      2048.00
   15409.151     0.999561       883691      2275.56
   15409.151     0.999609       883691      2560.00
   15409.151     0.999658       883691      2925.71
   15409.151     0.999707       883691      3413.33
   15409.151     0.999756       883691      4096.00
   15409.151     0.999780       883691      4551.11
   15417.343     0.999805       883832      5120.00
   15417.343     0.999829       883832      5851.43
   15417.343     0.999854       883832      6826.67
   15417.343     0.999878       883832      8192.00
   15417.343     0.999890       883832      9102.22
   15417.343     0.999902       883832     10240.00
   15417.343     0.999915       883832     11702.86
   15417.343     0.999927       883832     13653.33
   15417.343     0.999939       883832     16384.00
   15417.343     0.999945       883832     18204.44
   15417.343     0.999951       883832     20480.00
   15425.535     0.999957       883873     23405.71
   15425.535     0.999963       883873     27306.67
   15425.535     0.999969       883873     32768.00
   15425.535     0.999973       883873     36408.89
   15425.535     0.999976       883873     40960.00
   15425.535     0.999979       883873     46811.43
   15425.535     0.999982       883873     54613.33
   15425.535     0.999985       883873     65536.00
   15425.535     0.999986       883873     72817.78
   15425.535     0.999988       883873     81920.00
   15425.535     0.999989       883873     93622.86
   15425.535     0.999991       883873    109226.67
   15425.535     0.999992       883873    131072.00
   15425.535     0.999993       883873    145635.56
   15425.535     0.999994       883873    163840.00
   15425.535     0.999995       883873    187245.71
   15425.535     0.999995       883873    218453.33
   15425.535     0.999996       883873    262144.00
   15425.535     0.999997       883873    291271.11
   15425.535     0.999997       883873    327680.00
   15425.535     0.999997       883873    374491.43
   15425.535     0.999998       883873    436906.67
   15425.535     0.999998       883873    524288.00
   15425.535     0.999998       883873    582542.22
   15425.535     0.999998       883873    655360.00
   15425.535     0.999999       883873    748982.86
   15425.535     0.999999       883873    873813.33
   15433.727     0.999999       883874   1048576.00
   15433.727     1.000000       883874          inf
#[Mean    =     9150.670, StdDeviation   =     3090.058]
#[Max     =    15425.536, Total count    =       883874]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1455901 requests in 30.00s, 93.03MB read
Requests/sec:  48530.46
Transfer/sec:      3.10MB
```

Итоги:
* обработали всего 1455901 запросов
* прочитали 93.03MB данных 
* сервер обрабатывал 48530.46 запросов в секунду 

Чуть улучшили результат по сравнению с блокирующей реализацией.


## GET
### 1
Запускаю wrk c такими параметрами:
+ 4 threads (worker) send requests
+ keeping 16 HTTP connections open
+ 30 seconds
+ constant throughput of 32000 requests per second

Результаты с async profiler-а (CPU):
![Flame graph from async profiler](get-cpu-4-16-30-32000.svg?raw=true "Flame graph from async profiler")
Воркеры занимают чуть меньше памяти (примерно 7 процентов).

Результаты с async profiler-а (ALLOC):
![Flame graph from async profiler](get-alloc-4-16-30-32000.svg?raw=true "Flame graph from async profiler")
Аналогично. 

Результаты с async profiler-а (LOCK):
![Flame graph from async profiler](get-lock-4-16-30-32000.svg?raw=true "Flame graph from async profiler")
Аналогично.

Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.241ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.229ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.238ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.245ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.50ms    2.33ms  38.46ms   97.88%
    Req/Sec     8.46k     1.03k   17.22k    80.24%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.22ms
 75.000%    1.70ms
 90.000%    2.17ms
 99.000%   10.43ms
 99.900%   33.06ms
 99.990%   37.06ms
 99.999%   38.17ms
100.000%   38.49ms
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)
       0.033     0.000000            1         1.00
       0.415     0.100000        64144         1.11
       0.663     0.200000       128002         1.25
       0.879     0.300000       192127         1.43
       1.058     0.400000       255806         1.67
       1.220     0.500000       319785         2.00
       1.301     0.550000       351640         2.22
       1.387     0.600000       383917         2.50
       1.480     0.650000       415746         2.86
       1.583     0.700000       447642         3.33
       1.698     0.750000       479486         4.00
       1.763     0.775000       495653         4.44
       1.832     0.800000       511644         5.00
       1.905     0.825000       527485         5.71
       1.985     0.850000       543405         6.67
       2.073     0.875000       559628         8.00
       2.121     0.887500       567412         8.89
       2.175     0.900000       575602        10.00
       2.231     0.912500       583502        11.43
       2.297     0.925000       591549        13.33
       2.375     0.937500       599414        16.00
       2.421     0.943750       603392        17.78
       2.475     0.950000       607335        20.00
       2.543     0.956250       611364        22.86
       2.629     0.962500       615345        26.67
       2.763     0.968750       619314        32.00
       2.879     0.971875       621308        35.56
       3.093     0.975000       623304        40.00
       3.649     0.978125       625297        45.71
       4.703     0.981250       627294        53.33
       6.067     0.984375       629292        64.00
       6.787     0.985938       630292        71.11
       7.775     0.987500       631295        80.00
       9.255     0.989062       632288        91.43
      11.375     0.990625       633289       106.67
      13.647     0.992188       634286       128.00
      15.023     0.992969       634787       142.22
      16.783     0.993750       635288       160.00
      19.119     0.994531       635785       182.86
      21.823     0.995313       636287       213.33
      24.591     0.996094       636785       256.00
      25.823     0.996484       637033       284.44
      27.023     0.996875       637285       320.00
      28.079     0.997266       637532       365.71
      28.927     0.997656       637782       426.67
      29.855     0.998047       638032       512.00
      30.383     0.998242       638159       568.89
      30.991     0.998437       638284       640.00
      31.695     0.998633       638406       731.43
      32.479     0.998828       638532       853.33
      33.087     0.999023       638657      1024.00
      33.407     0.999121       638725      1137.78
      33.695     0.999219       638781      1280.00
      34.047     0.999316       638844      1462.86
      34.559     0.999414       638908      1706.67
      35.007     0.999512       638971      2048.00
      35.231     0.999561       639005      2275.56
      35.455     0.999609       639034      2560.00
      35.679     0.999658       639063      2925.71
      35.967     0.999707       639095      3413.33
      36.191     0.999756       639126      4096.00
      36.319     0.999780       639140      4551.11
      36.447     0.999805       639157      5120.00
      36.575     0.999829       639173      5851.43
      36.735     0.999854       639189      6826.67
      36.863     0.999878       639204      8192.00
      36.991     0.999890       639215      9102.22
      37.055     0.999902       639218     10240.00
      37.151     0.999915       639226     11702.86
      37.343     0.999927       639235     13653.33
      37.407     0.999939       639242     16384.00
      37.471     0.999945       639247     18204.44
      37.535     0.999951       639249     20480.00
      37.599     0.999957       639253     23405.71
      37.663     0.999963       639258     27306.67
      37.759     0.999969       639261     32768.00
      37.791     0.999973       639263     36408.89
      37.919     0.999976       639267     40960.00
      37.919     0.999979       639267     46811.43
      38.015     0.999982       639269     54613.33
      38.047     0.999985       639272     65536.00
      38.047     0.999986       639272     72817.78
      38.079     0.999988       639273     81920.00
      38.175     0.999989       639275     93622.86
      38.175     0.999991       639275    109226.67
      38.207     0.999992       639276    131072.00
      38.207     0.999993       639276    145635.56
      38.303     0.999994       639278    163840.00
      38.303     0.999995       639278    187245.71
      38.303     0.999995       639278    218453.33
      38.303     0.999996       639278    262144.00
      38.303     0.999997       639278    291271.11
      38.367     0.999997       639279    327680.00
      38.367     0.999997       639279    374491.43
      38.367     0.999998       639279    436906.67
      38.367     0.999998       639279    524288.00
      38.367     0.999998       639279    582542.22
      38.495     0.999998       639280    655360.00
      38.495     1.000000       639280          inf
#[Mean    =        1.500, StdDeviation   =        2.332]
#[Max     =       38.464, Total count    =       639280]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  959642 requests in 30.00s, 61.81MB read
Requests/sec:  31989.78
Transfer/sec:      2.06MB
```

Итоги:
* обработали всего 959642 запросов
* прочитали 61.81MB данных 
* сервер обрабатывал 31989.78 запросов в секунду 

### Предельная нагрузка
Методом подбора определили, что сервис может обрабатывать примерно 50-60 тысяч запросов в секунду.

Запускаю wrk c такими параметрами:
+ 8 threads (worker) send requests
+ keeping 16 HTTP connections open
+ 30 seconds
+ constant throughput of 60000 requests per second

Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  8 threads and 16 connections
  Thread calibration: mean lat.: 3.933ms, rate sampling interval: 24ms
  Thread calibration: mean lat.: 7.813ms, rate sampling interval: 45ms
  Thread calibration: mean lat.: 3.681ms, rate sampling interval: 20ms
  Thread calibration: mean lat.: 3.940ms, rate sampling interval: 24ms
  Thread calibration: mean lat.: 4.162ms, rate sampling interval: 25ms
  Thread calibration: mean lat.: 3.579ms, rate sampling interval: 19ms
  Thread calibration: mean lat.: 4.039ms, rate sampling interval: 24ms
  Thread calibration: mean lat.: 4.304ms, rate sampling interval: 27ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   268.04ms  310.50ms   1.44s    85.54%
    Req/Sec     7.19k     1.01k    9.87k    78.32%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  150.01ms
 75.000%  347.14ms
 90.000%  802.82ms
 99.000%    1.23s 
 99.900%    1.35s 
 99.990%    1.43s 
 99.999%    1.44s 
100.000%    1.44s 
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)
       0.085     0.000000            1         1.00
      21.727     0.100000       112509         1.11
      45.247     0.200000       225010         1.25
      72.959     0.300000       337468         1.43
     110.015     0.400000       450010         1.67
     150.015     0.500000       562180         2.00
     164.351     0.550000       618718         2.22
     179.327     0.600000       674800         2.50
     217.855     0.650000       730843         2.86
     256.895     0.700000       787105         3.33
     347.135     0.750000       843428         4.00
     395.263     0.775000       871509         4.44
     444.927     0.800000       899507         5.00
     494.591     0.825000       927624         5.71
     562.687     0.850000       955839         6.67
     677.887     0.875000       983816         8.00
     728.575     0.887500       997958         8.89
     803.327     0.900000      1011990        10.00
     866.303     0.912500      1026051        11.43
     920.575     0.925000      1040150        13.33
     973.311     0.937500      1054109        16.00
    1006.591     0.943750      1061120        17.78
    1038.335     0.950000      1068181        20.00
    1060.863     0.956250      1075246        22.86
    1088.511     0.962500      1082255        26.67
    1114.111     0.968750      1089371        32.00
    1125.375     0.971875      1092836        35.56
    1138.687     0.975000      1096289        40.00
    1150.975     0.978125      1099835        45.71
    1167.359     0.981250      1103348        53.33
    1185.791     0.984375      1106789        64.00
    1195.007     0.985938      1108596        71.11
    1207.295     0.987500      1110303        80.00
    1224.703     0.989062      1112065        91.43
    1238.015     0.990625      1113822       106.67
    1253.375     0.992188      1115621       128.00
    1264.639     0.992969      1116490       142.22
    1272.831     0.993750      1117405       160.00
    1284.095     0.994531      1118272       182.86
    1290.239     0.995313      1119407       213.33
    1294.335     0.996094      1120040       256.00
    1299.455     0.996484      1120403       284.44
    1305.599     0.996875      1120966       320.00
    1308.671     0.997266      1121495       365.71
    1311.743     0.997656      1121811       426.67
    1317.887     0.998047      1122161       512.00
    1323.007     0.998242      1122377       568.89
    1325.055     0.998437      1122620       640.00
    1332.223     0.998633      1122823       731.43
    1343.487     0.998828      1123036       853.33
    1355.775     0.999023      1123256      1024.00
    1363.967     0.999121      1123364      1137.78
    1375.231     0.999219      1123485      1280.00
    1382.399     0.999316      1123590      1462.86
    1390.591     0.999414      1123693      1706.67
    1398.783     0.999512      1123807      2048.00
    1402.879     0.999561      1123861      2275.56
    1406.975     0.999609      1123919      2560.00
    1410.047     0.999658      1123967      2925.71
    1414.143     0.999707      1124026      3413.33
    1417.215     0.999756      1124078      4096.00
    1419.263     0.999780      1124105      4551.11
    1421.311     0.999805      1124145      5120.00
    1422.335     0.999829      1124160      5851.43
    1423.359     0.999854      1124185      6826.67
    1426.431     0.999878      1124220      8192.00
    1427.455     0.999890      1124235      9102.22
    1428.479     0.999902      1124241     10240.00
    1431.551     0.999915      1124258     11702.86
    1433.599     0.999927      1124281     13653.33
    1433.599     0.999939      1124281     16384.00
    1434.623     0.999945      1124296     18204.44
    1434.623     0.999951      1124296     20480.00
    1435.647     0.999957      1124305     23405.71
    1436.671     0.999963      1124318     27306.67
    1436.671     0.999969      1124318     32768.00
    1437.695     0.999973      1124326     36408.89
    1437.695     0.999976      1124326     40960.00
    1437.695     0.999979      1124326     46811.43
    1438.719     0.999982      1124333     54613.33
    1438.719     0.999985      1124333     65536.00
    1439.743     0.999986      1124344     72817.78
    1439.743     0.999988      1124344     81920.00
    1439.743     0.999989      1124344     93622.86
    1439.743     0.999991      1124344    109226.67
    1439.743     0.999992      1124344    131072.00
    1439.743     0.999993      1124344    145635.56
    1439.743     0.999994      1124344    163840.00
    1439.743     0.999995      1124344    187245.71
    1439.743     0.999995      1124344    218453.33
    1440.767     0.999996      1124349    262144.00
    1440.767     1.000000      1124349          inf
#[Mean    =      268.041, StdDeviation   =      310.495]
#[Max     =     1439.744, Total count    =      1124349]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1724218 requests in 30.00s, 110.97MB read
Requests/sec:  57479.45
Transfer/sec:      3.70MB
```

Итоги:
* обработали всего 1724218 запросов
* прочитали  110.97MB данных 
* сервер обрабатывал 57479.45 запросов в секунду 

Не сильно изменились результаты с прошлой блокирующей реализацией.

### С большим количеством соединений

Запускаю wrk c такими параметрами:
+ 4 threads (worker) send requests
+ keeping 64 HTTP connections open
+ 30 seconds
+ constant throughput of 100000 requests per second

Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 602.921ms, rate sampling interval: 2488ms
  Thread calibration: mean lat.: 590.567ms, rate sampling interval: 2488ms
  Thread calibration: mean lat.: 599.488ms, rate sampling interval: 2500ms
  Thread calibration: mean lat.: 610.483ms, rate sampling interval: 2494ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.42s     1.74s    7.89s    60.24%
    Req/Sec    17.30k     1.40k   20.05k    73.33%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    4.15s 
 75.000%    5.83s 
 90.000%    7.03s 
 99.000%    7.66s 
 99.900%    7.81s 
 99.990%    7.87s 
 99.999%    7.89s 
100.000%    7.89s 
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)
    1501.183     0.000000            1         1.00
    2330.623     0.100000       138113         1.11
    2709.503     0.200000       275666         1.25
    3121.151     0.300000       413341         1.43
    3651.583     0.400000       551091         1.67
    4153.343     0.500000       688294         2.00
    4513.791     0.550000       757316         2.22
    4861.951     0.600000       826060         2.50
    5210.111     0.650000       894792         2.86
    5517.311     0.700000       964415         3.33
    5828.607     0.750000      1032762         4.00
    6012.927     0.775000      1067314         4.44
    6217.727     0.800000      1101141         5.00
    6459.391     0.825000      1135667         5.71
    6701.055     0.850000      1169921         6.67
    6877.183     0.875000      1204649         8.00
    6950.911     0.887500      1221686         8.89
    7032.831     0.900000      1239294        10.00
    7118.847     0.912500      1256427        11.43
    7208.959     0.925000      1273194        13.33
    7299.071     0.937500      1290353        16.00
    7344.127     0.943750      1299584        17.78
    7385.087     0.950000      1307967        20.00
    7430.143     0.956250      1316682        22.86
    7475.199     0.962500      1325174        26.67
    7516.159     0.968750      1333420        32.00
    7536.639     0.971875      1337757        35.56
    7557.119     0.975000      1342414        40.00
    7577.599     0.978125      1347151        45.71
    7593.983     0.981250      1350790        53.33
    7614.463     0.984375      1355005        64.00
    7626.751     0.985938      1357363        71.11
    7639.039     0.987500      1359701        80.00
    7651.327     0.989062      1361743        91.43
    7663.615     0.990625      1363480       106.67
    7679.999     0.992188      1365624       128.00
    7692.287     0.992969      1366995       142.22
    7700.479     0.993750      1367835       160.00
    7712.767     0.994531      1369001       182.86
    7725.055     0.995313      1370101       213.33
    7737.343     0.996094      1371055       256.00
    7745.535     0.996484      1371587       284.44
    7753.727     0.996875      1372113       320.00
    7761.919     0.997266      1372674       365.71
    7774.207     0.997656      1373398       426.67
    7782.399     0.998047      1373814       512.00
    7786.495     0.998242      1374048       568.89
    7790.591     0.998437      1374230       640.00
    7798.783     0.998633      1374627       731.43
    7802.879     0.998828      1374787       853.33
    7811.071     0.999023      1375111      1024.00
    7815.167     0.999121      1375225      1137.78
    7819.263     0.999219      1375351      1280.00
    7823.359     0.999316      1375457      1462.86
    7827.455     0.999414      1375547      1706.67
    7835.647     0.999512      1375729      2048.00
    7839.743     0.999561      1375798      2275.56
    7843.839     0.999609      1375868      2560.00
    7847.935     0.999658      1375952      2925.71
    7847.935     0.999707      1375952      3413.33
    7852.031     0.999756      1376024      4096.00
    7856.127     0.999780      1376076      4551.11
    7860.223     0.999805      1376138      5120.00
    7860.223     0.999829      1376138      5851.43
    7864.319     0.999854      1376198      6826.67
    7864.319     0.999878      1376198      8192.00
    7864.319     0.999890      1376198      9102.22
    7868.415     0.999902      1376241     10240.00
    7868.415     0.999915      1376241     11702.86
    7872.511     0.999927      1376269     13653.33
    7872.511     0.999939      1376269     16384.00
    7876.607     0.999945      1376285     18204.44
    7876.607     0.999951      1376285     20480.00
    7880.703     0.999957      1376300     23405.71
    7880.703     0.999963      1376300     27306.67
    7884.799     0.999969      1376319     32768.00
    7884.799     0.999973      1376319     36408.89
    7884.799     0.999976      1376319     40960.00
    7884.799     0.999979      1376319     46811.43
    7888.895     0.999982      1376339     54613.33
    7888.895     0.999985      1376339     65536.00
    7888.895     0.999986      1376339     72817.78
    7888.895     0.999988      1376339     81920.00
    7888.895     0.999989      1376339     93622.86
    7888.895     0.999991      1376339    109226.67
    7888.895     0.999992      1376339    131072.00
    7888.895     0.999993      1376339    145635.56
    7892.991     0.999994      1376348    163840.00
    7892.991     1.000000      1376348          inf
#[Mean    =     4421.658, StdDeviation   =     1739.107]
#[Max     =     7888.896, Total count    =      1376348]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2227101 requests in 30.00s, 144.00MB read
Requests/sec:  74238.05
Transfer/sec:      4.80MB
```

Итоги:
* обработали всего 2227101 запросов
* прочитали  144.00MB данных 
* сервер обрабатывал 74238.05 запросов в секунду 

Результат улучшился в полтора раза.

