# Репликация
Реализуем поддержку хранения нескольких реплик данных в кластере для обеспечения отказоустойчивости.

## Параметры машины

<b>CPU:</b> 1,2 GHz 4‑ядерный процессор Intel Core i7

<b>System:</b> Mac OS X (10.15.7)

<b>Architecture:</b> x86_64 64bit

## VisualVM
#### Вкладка Threads:
![Screen from visual vm threads](visual-vm-threads-1.png?raw=true "Screen from visual vm threads")
![Screen from visual vm threads](visual-vm-threads-2.png?raw=true "Screen from visual vm threads")

#### Вкладка Monitor:
![Screen from visual vm monitor](visual-vm-monitor.png?raw=true "Screen from visual vm monitor")
<b>Картина на CPU usage: </b>
2 раза нагрузка put-ами, 2 get-ами. Put-ы занимают в районе 50 процентов CPU, get-ы при тех же параметрах
40 процентов. Подробные результаты представлены ниже.


## PUT
Запускаю wrk c такими параметрами:
+ 4 threads send requests
+ keeping 64 HTTP connections open
+ 30 seconds
+ constant throughput of 60000 requests per second

Результаты с async profiler-а (CPU):
![Flame graph from async profiler](put-cpu-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты с async profiler-а (ALLOC):
![Flame graph from async profiler](put-alloc-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты с async profiler-а (LOCK):
![Flame graph from async profiler](put-lock-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 3037.238ms, rate sampling interval: 11517ms
  Thread calibration: mean lat.: 2523.794ms, rate sampling interval: 9854ms
  Thread calibration: mean lat.: 2890.918ms, rate sampling interval: 10739ms
  Thread calibration: mean lat.: 2591.623ms, rate sampling interval: 9748ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.03s     4.27s   25.35s    63.66%
    Req/Sec     5.15k   536.14     5.70k    50.00%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   11.68s 
 75.000%   15.16s 
 90.000%   17.92s 
 99.000%   22.46s 
 99.900%   24.54s 
 99.990%   25.21s 
 99.999%   25.33s 
100.000%   25.36s 
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)
    3846.143     0.000000            2         1.00
    6651.903     0.100000        39249         1.11
    7942.143     0.200000        78534         1.25
    9183.231     0.300000       117789         1.43
   10412.031     0.400000       156916         1.67
   11681.791     0.500000       196260         2.00
   12320.767     0.550000       215828         2.22
   12984.319     0.600000       235446         2.50
   13680.639     0.650000       254950         2.86
   14426.111     0.700000       274597         3.33
   15155.199     0.750000       294119         4.00
   15540.223     0.775000       303935         4.44
   15917.055     0.800000       313810         5.00
   16367.615     0.825000       323493         5.71
   16875.519     0.850000       333365         6.67
   17399.807     0.875000       343197         8.00
   17661.951     0.887500       348069         8.89
   17924.095     0.900000       353117        10.00
   18219.007     0.912500       357873        11.43
   18579.455     0.925000       362754        13.33
   18989.055     0.937500       367760        16.00
   19169.279     0.943750       370115        17.78
   19349.503     0.950000       372527        20.00
   19546.111     0.956250       375017        22.86
   19922.943     0.962500       377400        26.67
   20283.391     0.968750       379887        32.00
   20463.615     0.971875       381077        35.56
   20660.223     0.975000       382373        40.00
   20955.135     0.978125       383566        45.71
   21299.199     0.981250       384792        53.33
   21643.263     0.984375       386011        64.00
   21839.871     0.985938       386583        71.11
   22085.631     0.987500       387188        80.00
   22315.007     0.989062       387802        91.43
   22560.767     0.990625       388434       106.67
   22790.143     0.992188       389043       128.00
   22904.831     0.992969       389350       142.22
   23035.903     0.993750       389638       160.00
   23232.511     0.994531       389957       182.86
   23429.119     0.995313       390278       213.33
   23609.343     0.996094       390579       256.00
   23707.647     0.996484       390720       284.44
   23805.951     0.996875       390867       320.00
   23904.255     0.997266       391034       365.71
   24002.559     0.997656       391191       426.67
   24150.015     0.998047       391329       512.00
   24231.935     0.998242       391406       568.89
   24330.239     0.998437       391488       640.00
   24395.775     0.998633       391553       731.43
   24477.695     0.998828       391637       853.33
   24559.615     0.999023       391719      1024.00
   24592.383     0.999121       391753      1137.78
   24625.151     0.999219       391787      1280.00
   24657.919     0.999316       391820      1462.86
   24707.071     0.999414       391867      1706.67
   24756.223     0.999512       391907      2048.00
   24788.991     0.999561       391918      2275.56
   24854.527     0.999609       391939      2560.00
   24903.679     0.999658       391955      2925.71
   24969.215     0.999707       391975      3413.33
   25034.751     0.999756       391995      4096.00
   25067.519     0.999780       392005      4551.11
   25100.287     0.999805       392015      5120.00
   25116.671     0.999829       392021      5851.43
   25149.439     0.999854       392031      6826.67
   25182.207     0.999878       392041      8192.00
   25198.591     0.999890       392047      9102.22
   25214.975     0.999902       392051     10240.00
   25231.359     0.999915       392056     11702.86
   25247.743     0.999927       392061     13653.33
   25264.127     0.999939       392067     16384.00
   25264.127     0.999945       392067     18204.44
   25280.511     0.999951       392071     20480.00
   25296.895     0.999957       392077     23405.71
   25296.895     0.999963       392077     27306.67
   25296.895     0.999969       392077     32768.00
   25313.279     0.999973       392081     36408.89
   25313.279     0.999976       392081     40960.00
   25313.279     0.999979       392081     46811.43
   25313.279     0.999982       392081     54613.33
   25329.663     0.999985       392085     65536.00
   25329.663     0.999986       392085     72817.78
   25329.663     0.999988       392085     81920.00
   25329.663     0.999989       392085     93622.86
   25329.663     0.999991       392085    109226.67
   25346.047     0.999992       392087    131072.00
   25346.047     0.999993       392087    145635.56
   25346.047     0.999994       392087    163840.00
   25346.047     0.999995       392087    187245.71
   25346.047     0.999995       392087    218453.33
   25346.047     0.999996       392087    262144.00
   25346.047     0.999997       392087    291271.11
   25346.047     0.999997       392087    327680.00
   25346.047     0.999997       392087    374491.43
   25362.431     0.999998       392088    436906.67
   25362.431     1.000000       392088          inf
#[Mean    =    12026.893, StdDeviation   =     4270.114]
#[Max     =    25346.048, Total count    =       392088]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  624830 requests in 30.00s, 39.92MB read
Requests/sec:  20828.75
Transfer/sec:      1.33MB
```

Итоги:
* обработали всего 624830 запросов
* прочитали 39.92MB данных 
* сервер обрабатывал 20828.75 запросов в секунду 



## GET
Запускаю wrk c такими параметрами:
+ 4 threads send requests
+ keeping 64 HTTP connections open
+ 30 seconds
+ constant throughput of 60000 requests per second

Результаты с async profiler-а (CPU):
![Flame graph from async profiler](get-cpu-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты с async profiler-а (ALLOC):
![Flame graph from async profiler](get-alloc-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты с async profiler-а (LOCK):
![Flame graph from async profiler](get-lock-4-64-30-60000.svg?raw=true "Flame graph from async profiler")

Результаты wrk2:
```
Running 30s test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 2479.514ms, rate sampling interval: 9650ms
  Thread calibration: mean lat.: 2422.875ms, rate sampling interval: 9273ms
  Thread calibration: mean lat.: 2418.623ms, rate sampling interval: 9043ms
  Thread calibration: mean lat.: 2810.195ms, rate sampling interval: 10231ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    11.60s     4.24s   25.15s    64.11%
    Req/Sec     4.84k   363.18     5.43k    71.43%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   11.21s 
 75.000%   14.69s 
 90.000%   17.51s 
 99.000%   22.25s 
 99.900%   24.00s 
 99.990%   24.90s 
 99.999%   25.13s 
100.000%   25.17s 
  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)
    4194.303     0.000000            1         1.00
    6254.591     0.100000        37708         1.11
    7467.007     0.200000        75397         1.25
    8708.095     0.300000       112985         1.43
   10027.007     0.400000       150851         1.67
   11214.847     0.500000       188453         2.00
   11853.823     0.550000       207351         2.22
   12500.991     0.600000       226114         2.50
   13246.463     0.650000       244899         2.86
   13991.935     0.700000       263648         3.33
   14688.255     0.750000       282541         4.00
   15040.511     0.775000       291918         4.44
   15392.767     0.800000       301390         5.00
   15745.023     0.825000       310810         5.71
   16171.007     0.850000       320101         6.67
   16859.135     0.875000       329535         8.00
   17186.815     0.887500       334221         8.89
   17514.495     0.900000       339128        10.00
   17825.791     0.912500       343743        11.43
   18186.239     0.925000       348478        13.33
   18595.839     0.937500       353125        16.00
   18792.447     0.943750       355472        17.78
   18989.055     0.950000       357851        20.00
   19251.199     0.956250       360184        22.86
   19611.647     0.962500       362466        26.67
   20004.863     0.968750       364832        32.00
   20217.855     0.971875       366010        35.56
   20496.383     0.975000       367165        40.00
   20840.447     0.978125       368330        45.71
   21217.279     0.981250       369529        53.33
   21610.495     0.984375       370688        64.00
   21790.719     0.985938       371282        71.11
   21970.943     0.987500       371865        80.00
   22151.167     0.989062       372466        91.43
   22331.391     0.990625       373038       106.67
   22511.615     0.992188       373604       128.00
   22609.919     0.992969       373925       142.22
   22691.839     0.993750       374201       160.00
   22790.143     0.994531       374510       182.86
   22888.447     0.995313       374795       213.33
   23019.519     0.996094       375089       256.00
   23101.439     0.996484       375224       284.44
   23199.743     0.996875       375374       320.00
   23347.199     0.997266       375532       365.71
   23478.271     0.997656       375667       426.67
   23625.727     0.998047       375825       512.00
   23691.263     0.998242       375897       568.89
   23756.799     0.998437       375964       640.00
   23822.335     0.998633       376031       731.43
   23920.639     0.998828       376115       853.33
   24002.559     0.999023       376178      1024.00
   24084.479     0.999121       376220      1137.78
   24150.015     0.999219       376252      1280.00
   24231.935     0.999316       376293      1462.86
   24297.471     0.999414       376328      1706.67
   24379.391     0.999512       376368      2048.00
   24412.159     0.999561       376383      2275.56
   24461.311     0.999609       376405      2560.00
   24494.079     0.999658       376419      2925.71
   24543.231     0.999707       376441      3413.33
   24592.383     0.999756       376457      4096.00
   24641.535     0.999780       376464      4551.11
   24690.687     0.999805       376472      5120.00
   24756.223     0.999829       376483      5851.43
   24805.375     0.999854       376491      6826.67
   24854.527     0.999878       376500      8192.00
   24887.295     0.999890       376505      9102.22
   24920.063     0.999902       376511     10240.00
   24936.447     0.999915       376514     11702.86
   24969.215     0.999927       376519     13653.33
   25001.983     0.999939       376524     16384.00
   25018.367     0.999945       376526     18204.44
   25034.751     0.999951       376529     20480.00
   25034.751     0.999957       376529     23405.71
   25067.519     0.999963       376533     27306.67
   25083.903     0.999969       376535     32768.00
   25083.903     0.999973       376535     36408.89
   25100.287     0.999976       376538     40960.00
   25100.287     0.999979       376538     46811.43
   25116.671     0.999982       376540     54613.33
   25116.671     0.999985       376540     65536.00
   25116.671     0.999986       376540     72817.78
   25133.055     0.999988       376542     81920.00
   25133.055     0.999989       376542     93622.86
   25133.055     0.999991       376542    109226.67
   25149.439     0.999992       376543    131072.00
   25149.439     0.999993       376543    145635.56
   25149.439     0.999994       376543    163840.00
   25149.439     0.999995       376543    187245.71
   25165.823     0.999995       376545    218453.33
   25165.823     1.000000       376545          inf
#[Mean    =    11600.210, StdDeviation   =     4236.709]
#[Max     =    25149.440, Total count    =       376545]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  623839 requests in 30.00s, 40.03MB read
Requests/sec:  20795.12
Transfer/sec:      1.33MB
```

Итоги:
* обработали всего 623839 запросов
* прочитали 40.03MB данных 
* сервер обрабатывал 20795.12 запросов в секунду 

## Вывод.
Время обработки запроса и число таймаутов выросли, по сравнению с предыдущей версией. 
Это объясняется тем, что теперь для выполнения запроса,
его должны обработать 2/3 узлов, которые тоже, в свою очередь, находятся под нагрузкой.