# Нагрузочное тестирование

В работе в параметрах async-profiler использовался ключ -t, который выделяет работающие селекторы. Так-как основная система моего комплютера - Win10, профилирование я делал на виртуальной машине.
В начале мне не было понятно, почему не смотря на ключ -t имеется всего один селектор. Потом я выяснил, что не смотря на 8 ядер в физическом процессоре, на виртуальную машину выделено всего одно.
Я попробовал увеличить их количество до 4х, но мощностей для адекватной работы не хватило. Поэтому выбор я остановил на двух ядрах.


## Запрос put
### wrk

Параметры запуска

```
./wrk -t4 -c16 -d40s -R10000 -s put.lua --latency http://127.0.0.1:8080

```

Полученный результат

```
Running 40s test @ http://127.0.0.1:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 16.384ms, rate sampling interval: 99ms
  Thread calibration: mean lat.: 20.912ms, rate sampling interval: 148ms
  Thread calibration: mean lat.: 15.425ms, rate sampling interval: 108ms
  Thread calibration: mean lat.: 33.305ms, rate sampling interval: 243ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.65ms    1.20ms  30.94ms   87.26%
    Req/Sec     2.51k    45.74     2.90k    92.14%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.48ms
 75.000%    2.08ms
 90.000%    2.67ms
 99.000%    5.91ms
 99.900%   14.29ms
 99.990%   24.48ms
 99.999%   29.36ms
100.000%   30.96ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.060     0.000000            1         1.00
       0.604     0.100000        29989         1.11
       0.857     0.200000        60096         1.25
       1.070     0.300000        89958         1.43
       1.276     0.400000       119931         1.67
       1.481     0.500000       149899         2.00
       1.587     0.550000       164933         2.22
       1.699     0.600000       179909         2.50
       1.816     0.650000       194895         2.86
       1.940     0.700000       209865         3.33
       2.077     0.750000       225034         4.00
       2.151     0.775000       232467         4.44
       2.229     0.800000       239861         5.00
       2.317     0.825000       247405         5.71
       2.417     0.850000       254915         6.67
       2.531     0.875000       262404         8.00
       2.595     0.887500       266083         8.89
       2.669     0.900000       269919        10.00
       2.751     0.912500       273585        11.43
       2.849     0.925000       277371        13.33
       2.963     0.937500       281096        16.00
       3.033     0.943750       282935        17.78
       3.113     0.950000       284841        20.00
       3.203     0.956250       286695        22.86
       3.317     0.962500       288583        26.67
       3.467     0.968750       290434        32.00
       3.569     0.971875       291383        35.56
       3.691     0.975000       292308        40.00
       3.845     0.978125       293248        45.71
       4.061     0.981250       294179        53.33
       4.415     0.984375       295115        64.00
       4.711     0.985938       295584        71.11
       5.055     0.987500       296057        80.00
       5.563     0.989062       296521        91.43
       6.155     0.990625       296990       106.67
       6.955     0.992188       297456       128.00
       7.399     0.992969       297691       142.22
       7.859     0.993750       297926       160.00
       8.383     0.994531       298161       182.86
       8.863     0.995313       298395       213.33
       9.495     0.996094       298629       256.00
       9.839     0.996484       298745       284.44
      10.231     0.996875       298864       320.00
      10.671     0.997266       298980       365.71
      11.151     0.997656       299096       426.67
      11.895     0.998047       299213       512.00
      12.287     0.998242       299274       568.89
      12.695     0.998437       299331       640.00
      13.215     0.998633       299389       731.43
      13.703     0.998828       299447       853.33
      14.375     0.999023       299506      1024.00
      14.783     0.999121       299536      1137.78
      15.143     0.999219       299564      1280.00
      15.607     0.999316       299594      1462.86
      16.303     0.999414       299623      1706.67
      16.943     0.999512       299652      2048.00
      17.455     0.999561       299667      2275.56
      17.919     0.999609       299681      2560.00
      18.303     0.999658       299696      2925.71
      18.943     0.999707       299711      3413.33
      19.567     0.999756       299725      4096.00
      20.015     0.999780       299733      4551.11
      20.655     0.999805       299740      5120.00
      21.231     0.999829       299747      5851.43
      22.303     0.999854       299755      6826.67
      23.471     0.999878       299762      8192.00
      23.855     0.999890       299766      9102.22
      24.575     0.999902       299769     10240.00
      25.167     0.999915       299773     11702.86
      26.095     0.999927       299777     13653.33
      26.639     0.999939       299780     16384.00
      27.151     0.999945       299782     18204.44
      27.503     0.999951       299784     20480.00
      27.711     0.999957       299786     23405.71
      28.175     0.999963       299788     27306.67
      28.191     0.999969       299789     32768.00
      28.319     0.999973       299790     36408.89
      28.863     0.999976       299791     40960.00
      28.975     0.999979       299792     46811.43
      29.087     0.999982       299793     54613.33
      29.247     0.999985       299794     65536.00
      29.247     0.999986       299794     72817.78
      29.359     0.999988       299795     81920.00
      29.359     0.999989       299795     93622.86
      30.031     0.999991       299796    109226.67
      30.031     0.999992       299796    131072.00
      30.031     0.999993       299796    145635.56
      30.095     0.999994       299797    163840.00
      30.095     0.999995       299797    187245.71
      30.095     0.999995       299797    218453.33
      30.095     0.999996       299797    262144.00
      30.095     0.999997       299797    291271.11
      30.959     0.999997       299798    327680.00
      30.959     1.000000       299798          inf
#[Mean    =        1.647, StdDeviation   =        1.202]
#[Max     =       30.944, Total count    =       299798]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  399909 requests in 40.00s, 25.55MB read
Requests/sec:   9997.93
Transfer/sec:    654.16KB
```
### Async-profiler 
![alt text](https://raw.githubusercontent.com/IvanovAndrey/2020-highload-dht/c11c71d7ae0d161e1b7c04455b862d7568064cc4/async/put_cpu_m.svg)

Как и ожидалось - два селектора обрабатывают запросы. Большинство запросов принадлежат NIO Selector-у, который обрабатывает отправляемые PUT запросы. Процесс заканчивается помещением данных в RocksDB.

### Allocation
![alt text](https://raw.githubusercontent.com/IvanovAndrey/2020-highload-dht/c11c71d7ae0d161e1b7c04455b862d7568064cc4/async/put_alloc_m.svg)

SelectorThread.run занимает 100%. При этом на one/nio/http/HttpSession.sendResponse мы тратим 5% памяти, и 12% на парсинг запроса. На операцию put (ServiceImpl.put) тратится 12%.

Построение Flame Graph с параметром ```-e lock``` закончилось пустым графом. Блокировок потоков нет.

## Запрос get
### wrk

Параметры запуска

```
./wrk -t4 -c16 -d40s -R10000 -s get.lua --latency http://127.0.0.1:8080

```

Полученный результат

```
Running 40s test @ http://127.0.0.1:8080
  4 threads and 16 connections
  Thread calibration: mean lat.: 1.946ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.937ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.945ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.026ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.23ms    3.25ms  67.39ms   95.18%
    Req/Sec     2.67k   627.89    11.44k    86.95%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.64ms
 75.000%    2.32ms
 90.000%    3.35ms
 99.000%   15.49ms
 99.900%   48.67ms
 99.990%   57.63ms
 99.999%   66.37ms
100.000%   67.46ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.060     0.000000            2         1.00
       0.669     0.100000        30043         1.11
       0.943     0.200000        60010         1.25
       1.185     0.300000        89987         1.43
       1.415     0.400000       119922         1.67
       1.644     0.500000       149942         2.00
       1.762     0.550000       165038         2.22
       1.885     0.600000       180000         2.50
       2.017     0.650000       194921         2.86
       2.159     0.700000       209959         3.33
       2.323     0.750000       224947         4.00
       2.421     0.775000       232444         4.44
       2.535     0.800000       239952         5.00
       2.667     0.825000       247382         5.71
       2.829     0.850000       254837         6.67
       3.035     0.875000       262327         8.00
       3.171     0.887500       266076         8.89
       3.349     0.900000       269860        10.00
       3.603     0.912500       273574        11.43
       3.971     0.925000       277333        13.33
       4.503     0.937500       281067        16.00
       4.883     0.943750       282949        17.78
       5.343     0.950000       284822        20.00
       5.863     0.956250       286692        22.86
       6.523     0.962500       288560        26.67
       7.435     0.968750       290434        32.00
       8.007     0.971875       291372        35.56
       8.735     0.975000       292310        40.00
       9.639     0.978125       293243        45.71
      10.703     0.981250       294188        53.33
      12.015     0.984375       295120        64.00
      12.791     0.985938       295586        71.11
      13.671     0.987500       296053        80.00
      14.759     0.989062       296522        91.43
      16.095     0.990625       296992       106.67
      17.647     0.992188       297459       128.00
      18.767     0.992969       297693       142.22
      20.063     0.993750       297927       160.00
      21.519     0.994531       298161       182.86
      23.327     0.995313       298397       213.33
      25.727     0.996094       298630       256.00
      27.631     0.996484       298747       284.44
      29.663     0.996875       298864       320.00
      31.919     0.997266       298981       365.71
      34.335     0.997656       299099       426.67
      36.927     0.998047       299215       512.00
      38.655     0.998242       299274       568.89
      40.223     0.998437       299332       640.00
      42.463     0.998633       299391       731.43
      46.015     0.998828       299452       853.33
      48.959     0.999023       299508      1024.00
      50.271     0.999121       299537      1137.78
      51.103     0.999219       299566      1280.00
      51.871     0.999316       299597      1462.86
      52.895     0.999414       299625      1706.67
      53.663     0.999512       299654      2048.00
      54.143     0.999561       299669      2275.56
      54.431     0.999609       299683      2560.00
      54.751     0.999658       299699      2925.71
      55.103     0.999707       299713      3413.33
      55.455     0.999756       299728      4096.00
      55.743     0.999780       299735      4551.11
      55.903     0.999805       299742      5120.00
      56.159     0.999829       299751      5851.43
      56.479     0.999854       299757      6826.67
      56.799     0.999878       299764      8192.00
      57.087     0.999890       299768      9102.22
      57.631     0.999902       299771     10240.00
      59.071     0.999915       299775     11702.86
      61.119     0.999927       299779     13653.33
      62.207     0.999939       299782     16384.00
      62.431     0.999945       299784     18204.44
      62.975     0.999951       299786     20480.00
      63.231     0.999957       299788     23405.71
      64.479     0.999963       299790     27306.67
      64.831     0.999969       299791     32768.00
      64.927     0.999973       299792     36408.89
      65.183     0.999976       299793     40960.00
      65.247     0.999979       299794     46811.43
      65.983     0.999982       299795     54613.33
      66.175     0.999985       299796     65536.00
      66.175     0.999986       299796     72817.78
      66.367     0.999988       299797     81920.00
      66.367     0.999989       299797     93622.86
      66.879     0.999991       299798    109226.67
      66.879     0.999992       299798    131072.00
      66.879     0.999993       299798    145635.56
      67.263     0.999994       299799    163840.00
      67.263     0.999995       299799    187245.71
      67.263     0.999995       299799    218453.33
      67.263     0.999996       299799    262144.00
      67.263     0.999997       299799    291271.11
      67.455     0.999997       299800    327680.00
      67.455     1.000000       299800          inf
#[Mean    =        2.230, StdDeviation   =        3.255]
#[Max     =       67.392, Total count    =       299800]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  399914 requests in 40.00s, 25.51MB read
Requests/sec:   9997.35
Transfer/sec:    653.04KB
```
### Async-profiler 
![alt text](https://raw.githubusercontent.com/IvanovAndrey/2020-highload-dht/c11c71d7ae0d161e1b7c04455b862d7568064cc4/async/get_cpu_m.svg)

20 процентов уходит на работу селектора, 80 на обработку запроса. Обработка запроса сходится к вызову функции RocksDb get.

### Allocation
![alt text](https://raw.githubusercontent.com/IvanovAndrey/2020-highload-dht/c11c71d7ae0d161e1b7c04455b862d7568064cc4/async/get_alloc_m.svg)

Здесь все 100 процентов занимает SelectorThread. 12% cpu от каждого треда уходит на операцию get (ServiceImpl) , а на отправку ответов 7% (HttpSession.sendResponse).

Построение Flame Graph с параметром ```-e lock``` закончилось пустым графом. Блокировок потоков нет.
