# Нагрузочное тестирование с помощью wrk2

Параметры запуска тестов:
1. Thread - 1
2. Connection - 1
3. Requests per second - 20000
4. Duration - 60s

### 1) Тестирование PUT запросов

`wrk2 -t1 -c1 -R20000 -d60s -s wrk/put.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 0.706ms, rate sampling interval: 10ms
  
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   312.70ms  485.67ms   2.28s    83.56%
        Req/Sec    20.91k    13.87k   48.44k    60.00%
    
  Latency Distribution (HdrHistogram - Recorded Latency)
  
     50.000%    1.32ms
     75.000%  544.26ms
     90.000%    1.02s 
     99.000%    2.03s 
     99.900%    2.26s 
     99.990%    2.28s 
     99.999%    2.29s 
    100.000%    2.29s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.020     0.000000            1         1.00
       0.267     0.100000        99154         1.11
       0.496     0.200000       198304         1.25
       0.720     0.300000       296871         1.43
       0.942     0.400000       396195         1.67
       1.324     0.500000       494777         2.00
       2.287     0.550000       544196         2.22
     107.647     0.600000       593651         2.50
     259.327     0.650000       643122         2.86
     401.919     0.700000       692608         3.33
     544.255     0.750000       742078         4.00
     623.103     0.775000       766969         4.44
     699.903     0.800000       791600         5.00
     771.071     0.825000       816347         5.71
     840.191     0.850000       841014         6.67
     925.695     0.875000       865816         8.00
     971.263     0.887500       878177         8.89
    1024.511     0.900000       890488        10.00
    1084.415     0.912500       902959        11.43
    1151.999     0.925000       915225        13.33
    1246.207     0.937500       927671        16.00
    1299.455     0.943750       933866        17.78
    1353.727     0.950000       939962        20.00
    1433.599     0.956250       946183        22.86
    1505.279     0.962500       952311        26.67
    1584.127     0.968750       958489        32.00
    1615.871     0.971875       961579        35.56
    1653.759     0.975000       964694        40.00
    1726.463     0.978125       967771        45.71
    1807.359     0.981250       970857        53.33
    1885.183     0.984375       973975        64.00
    1925.119     0.985938       975527        71.11
    1965.055     0.987500       977047        80.00
    2004.991     0.989062       978588        91.43
    2045.951     0.990625       980138       106.67
    2086.911     0.992188       981696       128.00
    2107.391     0.992969       982472       142.22
    2123.775     0.993750       983231       160.00
    2144.255     0.994531       984012       182.86
    2164.735     0.995313       984796       213.33
    2185.215     0.996094       985588       256.00
    2195.455     0.996484       985977       284.44
    2205.695     0.996875       986367       320.00
    2215.935     0.997266       986757       365.71
    2226.175     0.997656       987146       426.67
    2236.415     0.998047       987538       512.00
    2240.511     0.998242       987693       568.89
    2246.655     0.998437       987927       640.00
    2250.751     0.998633       988082       731.43
    2256.895     0.998828       988317       853.33
    2260.991     0.999023       988473      1024.00
    2263.039     0.999121       988551      1137.78
    2267.135     0.999219       988707      1280.00
    2269.183     0.999316       988802      1462.86
    2271.231     0.999414       988881      1706.67
    2273.279     0.999512       988961      2048.00
    2275.327     0.999561       989043      2275.56
    2275.327     0.999609       989043      2560.00
    2277.375     0.999658       989123      2925.71
    2277.375     0.999707       989123      3413.33
    2279.423     0.999756       989204      4096.00
    2279.423     0.999780       989204      4551.11
    2281.471     0.999805       989283      5120.00
    2281.471     0.999829       989283      5851.43
    2281.471     0.999854       989283      6826.67
    2281.471     0.999878       989283      8192.00
    2283.519     0.999890       989377      9102.22
    2283.519     0.999902       989377     10240.00
    2283.519     0.999915       989377     11702.86
    2283.519     0.999927       989377     13653.33
    2283.519     0.999939       989377     16384.00
    2283.519     0.999945       989377     18204.44
    2283.519     0.999951       989377     20480.00
    2283.519     0.999957       989377     23405.71
    2283.519     0.999963       989377     27306.67
    2283.519     0.999969       989377     32768.00
    2283.519     0.999973       989377     36408.89
    2285.567     0.999976       989403     40960.00
    2285.567     1.000000       989403          inf

    [Mean    =      312.698, StdDeviation   =      485.669]
    [Max     =     2283.520, Total count    =       989403]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1189474 requests in 1.00m, 76.00MB read
  
    Requests/sec:  19822.89
    Transfer/sec:      1.27MB

#### Результаты профилирования async-profiler (CPU): 
![Результаты профилирования async-profiler (CPU)](profilingResults/cpu_put.svg)

Анализ: 
 - Обработка запроса: 80.41%
 - Запись в сокет: 19.96%
 - Чтение из сокета: 5.27%
 - Вставка в DAO: 49.06%, причем 44.26% из них - это flush на диск
 
#### Результаты профилирования async-profiler (ALLOC):
 
`wrk2 -t1 -c1 -R20000 -d60s -s wrk/put.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.062ms, rate sampling interval: 10ms
  
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   423.60ms  545.45ms   2.30s    81.40%
        Req/Sec    20.91k    14.36k   48.44k    55.47%
  Latency Distribution (HdrHistogram - Recorded Latency)
  
     50.000%   96.77ms
     75.000%  783.87ms
     90.000%    1.27s 
     99.000%    2.05s 
     99.900%    2.28s 
     99.990%    2.30s 
     99.999%    2.31s 
    100.000%    2.31s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.020     0.000000            1         1.00
       0.334     0.100000        99116         1.11
       0.627     0.200000       198232         1.25
       0.910     0.300000       297152         1.43
       1.403     0.400000       395811         1.67
      96.767     0.500000       494697         2.00
     222.975     0.550000       544205         2.22
     369.407     0.600000       593707         2.50
     512.255     0.650000       643156         2.86
     646.143     0.700000       692777         3.33
     783.871     0.750000       742093         4.00
     844.799     0.775000       766820         4.44
     916.991     0.800000       791647         5.00
    1009.663     0.825000       816302         5.71
    1091.583     0.850000       841240         6.67
    1178.623     0.875000       865857         8.00
    1225.727     0.887500       878283         8.89
    1270.783     0.900000       890545        10.00
    1315.839     0.912500       902977        11.43
    1380.351     0.925000       915265        13.33
    1453.055     0.937500       927715        16.00
    1488.895     0.943750       933830        17.78
    1523.711     0.950000       940022        20.00
    1562.623     0.956250       946153        22.86
    1612.799     0.962500       952361        26.67
    1672.191     0.968750       958500        32.00
    1709.055     0.971875       961606        35.56
    1746.943     0.975000       964707        40.00
    1784.831     0.978125       967814        45.71
    1824.767     0.981250       970867        53.33
    1902.591     0.984375       973961        64.00
    1943.551     0.985938       975497        71.11
    1984.511     0.987500       977033        80.00
    2025.471     0.989062       978571        91.43
    2066.431     0.990625       980140       106.67
    2107.391     0.992188       981713       128.00
    2125.823     0.992969       982581       142.22
    2142.207     0.993750       983220       160.00
    2162.687     0.994531       983985       182.86
    2183.167     0.995313       984773       213.33
    2203.647     0.996094       985540       256.00
    2213.887     0.996484       985921       284.44
    2224.127     0.996875       986303       320.00
    2234.367     0.997266       986684       365.71
    2244.607     0.997656       987065       426.67
    2256.895     0.998047       987526       512.00
    2260.991     0.998242       987679       568.89
    2267.135     0.998437       987907       640.00
    2271.231     0.998633       988059       731.43
    2277.375     0.998828       988289       853.33
    2281.471     0.999023       988441      1024.00
    2283.519     0.999121       988518      1137.78
    2287.615     0.999219       988671      1280.00
    2289.663     0.999316       988750      1462.86
    2291.711     0.999414       988829      1706.67
    2293.759     0.999512       988909      2048.00
    2295.807     0.999561       988991      2275.56
    2297.855     0.999609       989069      2560.00
    2297.855     0.999658       989069      2925.71
    2299.903     0.999707       989148      3413.33
    2299.903     0.999756       989148      4096.00
    2301.951     0.999780       989227      4551.11
    2301.951     0.999805       989227      5120.00
    2301.951     0.999829       989227      5851.43
    2303.999     0.999854       989307      6826.67
    2303.999     0.999878       989307      8192.00
    2303.999     0.999890       989307      9102.22
    2303.999     0.999902       989307     10240.00
    2303.999     0.999915       989307     11702.86
    2306.047     0.999927       989383     13653.33
    2306.047     1.000000       989383          inf

    [Mean    =      423.602, StdDeviation   =      545.446]
    [Max     =     2304.000, Total count    =       989383]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1189474 requests in 1.00m, 76.00MB read
  
    Requests/sec:  19822.56
    Transfer/sec:      1.27MB


#### Результаты профилирования async-profiler (ALLOC): 
![Результаты профилирования async-profiler (ALLOC)](profilingResults/alloc_put.svg)

Анализ:
 - HttpBuffer занимает - 100%
 - Dao.upsert занимает - 27.93%
 - Response - 6.79%
 
В основном память уходит на создании байтовых массивов и буфферов: для ключа и значение, при обработке запроса, 
а также для того, чтобы записать объекты на диск при flush'e


### 2) Тестирование GET запросов

`wrk2 -t1 -c1 -R2000 -d30s -s wrk/get.lua --latency  http://localhost:8080`

Running 30s test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 4467.315ms, rate sampling interval: 15523ms
  
    Thread Stats   Avg      Stdev     Max   +/- Stdev
      Latency    17.03s     4.93s   25.66s    57.52%
      Req/Sec   291.00      0.00   291.00    100.00%
 
  Latency Distribution (HdrHistogram - Recorded Latency)
    
     50.000%   16.97s 
     75.000%   21.36s 
     90.000%   23.97s 
     99.000%   25.51s 
     99.900%   25.66s 
     99.990%   25.67s 
     99.999%   25.67s 
    100.000%   25.67s 

  Detailed Percentile spectrum:
      
         Value   Percentile   TotalCount 1/(1-Percentile)
        8585.215     0.000000            1         1.00
       10289.151     0.100000          584         1.11
       11952.127     0.200000         1165         1.25
       13606.911     0.300000         1745         1.43
       15261.695     0.400000         2326         1.67
       16973.823     0.500000         2910         2.00
       17793.023     0.550000         3200         2.22
       18612.223     0.600000         3489         2.50
       19447.807     0.650000         3783         2.86
       20381.695     0.700000         4072         3.33
       21364.735     0.750000         4362         4.00
       21774.335     0.775000         4507         4.44
       22233.087     0.800000         4652         5.00
       22659.071     0.825000         4802         5.71
       23052.287     0.850000         4943         6.67
       23527.423     0.875000         5090         8.00
       23773.183     0.887500         5164         8.89
       23969.791     0.900000         5233        10.00
       24182.783     0.912500         5310        11.43
       24379.391     0.925000         5378        13.33
       24592.383     0.937500         5453        16.00
       24690.687     0.943750         5487        17.78
       24838.143     0.950000         5528        20.00
       24936.447     0.956250         5561        22.86
       25034.751     0.962500         5596        26.67
       25149.439     0.968750         5636        32.00
       25198.591     0.971875         5654        35.56
       25247.743     0.975000         5671        40.00
       25296.895     0.978125         5687        45.71
       25362.431     0.981250         5708        53.33
       25411.583     0.984375         5726        64.00
       25444.351     0.985938         5737        71.11
       25460.735     0.987500         5743        80.00
       25493.503     0.989062         5753        91.43
       25526.271     0.990625         5765       106.67
       25542.655     0.992188         5771       128.00
       25559.039     0.992969         5776       142.22
       25575.423     0.993750         5781       160.00
       25591.807     0.994531         5787       182.86
       25591.807     0.995313         5787       213.33
       25608.191     0.996094         5793       256.00
       25624.575     0.996484         5798       284.44
       25624.575     0.996875         5798       320.00
       25640.959     0.997266         5804       365.71
       25640.959     0.997656         5804       426.67
       25640.959     0.998047         5804       512.00
       25640.959     0.998242         5804       568.89
       25657.343     0.998437         5809       640.00
       25657.343     0.998633         5809       731.43
       25657.343     0.998828         5809       853.33
       25657.343     0.999023         5809      1024.00
       25657.343     0.999121         5809      1137.78
       25673.727     0.999219         5814      1280.00
       25673.727     1.000000         5814          inf
     
    [Mean    =    17033.230, StdDeviation   =     4926.968]
    [Max     =    25657.344, Total count    =         5814]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  8656 requests in 30.00s, 615.02KB read
    
    Requests/sec:    288.52
    Transfer/sec:     20.50KB

#### Результаты профилирования async-profiler (CPU): 
![Результаты профилирования async-profiler (CPU)](profilingResults/cpu_get.svg)

Анализ: 
 - Практически все время занимает чтение из DAO, что является логичным, поскольку поиск по ключу - это чтение
 из файла, для прочтения которого необходимо обратиться к памяти и выделить наиболее `свежие` данные.
 - Фактически, чтение из файла занимает - 68.91% времени.
 - 26.82% времени тратится на инициализацию merge iterator'а

#### Результаты профилирования async-profiler (ALLOC):

`wrk2 -t1 -c1 -R2000 -d30s -s wrk/get.lua --latency  http://localhost:8080`

Running 30s test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 4328.488ms, rate sampling interval: 15441ms
  
    Thread Stats   Avg      Stdev     Max   +/- Stdev
      Latency    17.11s     4.91s   25.64s    57.62%
      Req/Sec   291.00      0.00   291.00    100.00%
      
  Latency Distribution (HdrHistogram - Recorded Latency)

     50.000%   17.14s 
     75.000%   21.36s 
     90.000%   23.87s 
     99.000%   25.48s 
     99.900%   25.64s 
     99.990%   25.66s 
     99.999%   25.66s 
    100.000%   25.66s 

  Detailed Percentile spectrum:
      
          Value   Percentile   TotalCount 1/(1-Percentile)
        8568.831     0.000000            2         1.00
       10280.959     0.100000          583         1.11
       11968.511     0.200000         1164         1.25
       13713.407     0.300000         1744         1.43
       15458.303     0.400000         2325         1.67
       17137.663     0.500000         2906         2.00
       17989.631     0.550000         3199         2.22
       18841.599     0.600000         3490         2.50
       19660.799     0.650000         3776         2.86
       20529.151     0.700000         4070         3.33
       21364.735     0.750000         4359         4.00
       21790.719     0.775000         4504         4.44
       22200.319     0.800000         4648         5.00
       22642.687     0.825000         4797         5.71
       23052.287     0.850000         4941         6.67
       23461.887     0.875000         5087         8.00
       23658.495     0.887500         5157         8.89
       23871.487     0.900000         5232        10.00
       24068.095     0.912500         5302        11.43
       24297.471     0.925000         5374        13.33
       24526.847     0.937500         5448        16.00
       24657.919     0.943750         5483        17.78
       24772.607     0.950000         5523        20.00
       24887.295     0.956250         5557        22.86
       25001.983     0.962500         5593        26.67
       25100.287     0.968750         5628        32.00
       25165.823     0.971875         5650        35.56
       25214.975     0.975000         5664        40.00
       25280.511     0.978125         5684        45.71
       25329.663     0.981250         5702        53.33
       25378.815     0.984375         5720        64.00
       25411.583     0.985938         5730        71.11
       25444.351     0.987500         5742        80.00
       25460.735     0.989062         5747        91.43
       25493.503     0.990625         5757       106.67
       25526.271     0.992188         5767       128.00
       25542.655     0.992969         5772       142.22
       25559.039     0.993750         5778       160.00
       25559.039     0.994531         5778       182.86
       25575.423     0.995313         5783       213.33
       25591.807     0.996094         5789       256.00
       25591.807     0.996484         5789       284.44
       25608.191     0.996875         5794       320.00
       25608.191     0.997266         5794       365.71
       25624.575     0.997656         5800       426.67
       25624.575     0.998047         5800       512.00
       25624.575     0.998242         5800       568.89
       25624.575     0.998437         5800       640.00
       25640.959     0.998633         5806       731.43
       25640.959     0.998828         5806       853.33
       25640.959     0.999023         5806      1024.00
       25640.959     0.999121         5806      1137.78
       25640.959     0.999219         5806      1280.00
       25640.959     0.999316         5806      1462.86
       25640.959     0.999414         5806      1706.67
       25657.343     0.999512         5809      2048.00
       25657.343     1.000000         5809          inf
    
    
    [Mean    =    17107.923, StdDeviation   =     4913.839]
    [Max     =    25640.960, Total count    =         5809]
    [Buckets =           27, SubBuckets     =         2048]
  8696 requests in 30.00s, 617.87KB read
  
    Requests/sec:    289.87
    Transfer/sec:     20.60KB
#### Результаты профилирования async-profiler (ALLOC): 
![Результаты профилирования async-profiler (ALLOC)](profilingResults/alloc_get.svg)

Анализ:
 - HttpBuffer занимает - 100%
 - Dao.get занимает - 99.75%
 - Response - 0.03%
 
В основном память уходит на создании байтовых массивов и буфферов: для ключа и значение, при обработке запроса, 
а также для того, чтобы прочитать объекты из файлов.
