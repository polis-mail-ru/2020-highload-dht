# Нагрузочное тестирование с помощью wrk2



### 1) Тестирование PUT запросов

Параметры запуска тестов:
1. Thread - 4
2. Connection - 16
3. Requests per second - 40000
4. Duration - 60s

`wrk2 -t4 -c16 -R40000 -d60s -s wrk/put.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  
      Thread calibration: mean lat.: 1.299ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.233ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.272ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.252ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.16ms  826.67us  25.36ms   82.20%
        Req/Sec    10.55k     0.96k   23.78k    71.86%
  Latency Distribution (HdrHistogram - Recorded Latency)
 
     50.000%    1.09ms
     75.000%    1.55ms
     90.000%    1.90ms
     99.000%    3.45ms
     99.900%   10.36ms
     99.990%   18.83ms
     99.999%   24.14ms
    100.000%   25.38ms

  Detailed Percentile spectrum:
  
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.019     0.000000            1         1.00
       0.316     0.100000       200048         1.11
       0.563     0.200000       399886         1.25
       0.794     0.300000       600398         1.43
       0.953     0.400000       799700         1.67
       1.092     0.500000      1000890         2.00
       1.161     0.550000      1100549         2.22
       1.240     0.600000      1199745         2.50
       1.332     0.650000      1300289         2.86
       1.435     0.700000      1400180         3.33
       1.548     0.750000      1499952         4.00
       1.604     0.775000      1550192         4.44
       1.658     0.800000      1599653         5.00
       1.716     0.825000      1650101         5.71
       1.776     0.850000      1699718         6.67
       1.837     0.875000      1749529         8.00
       1.869     0.887500      1775009         8.89
       1.901     0.900000      1799802        10.00
       1.936     0.912500      1824697        11.43
       1.976     0.925000      1849538        13.33
       2.023     0.937500      1874368        16.00
       2.051     0.943750      1886968        17.78
       2.081     0.950000      1899260        20.00
       2.117     0.956250      1911908        22.86
       2.163     0.962500      1924527        26.67
       2.225     0.968750      1936779        32.00
       2.269     0.971875      1943162        35.56
       2.327     0.975000      1949349        40.00
       2.403     0.978125      1955562        45.71
       2.517     0.981250      1961718        53.33
       2.707     0.984375      1967927        64.00
       2.851     0.985938      1971054        71.11
       3.039     0.987500      1974177        80.00
       3.283     0.989062      1977307        91.43
       3.571     0.990625      1980431       106.67
       3.939     0.992188      1983557       128.00
       4.167     0.992969      1985108       142.22
       4.439     0.993750      1986682       160.00
       4.755     0.994531      1988246       182.86
       5.167     0.995313      1989803       213.33
       5.671     0.996094      1991359       256.00
       5.951     0.996484      1992135       284.44
       6.279     0.996875      1992918       320.00
       6.671     0.997266      1993698       365.71
       7.171     0.997656      1994477       426.67
       7.807     0.998047      1995259       512.00
       8.199     0.998242      1995652       568.89
       8.607     0.998437      1996042       640.00
       9.055     0.998633      1996429       731.43
       9.727     0.998828      1996825       853.33
      10.439     0.999023      1997212      1024.00
      10.767     0.999121      1997409      1137.78
      11.199     0.999219      1997602      1280.00
      11.783     0.999316      1997797      1462.86
      12.303     0.999414      1997994      1706.67
      12.935     0.999512      1998185      2048.00
      13.415     0.999561      1998285      2275.56
      13.783     0.999609      1998381      2560.00
      14.047     0.999658      1998481      2925.71
      14.543     0.999707      1998579      3413.33
      15.231     0.999756      1998673      4096.00
      15.631     0.999780      1998722      4551.11
      15.895     0.999805      1998771      5120.00
      16.343     0.999829      1998820      5851.43
      16.863     0.999854      1998869      6826.67
      17.743     0.999878      1998918      8192.00
      18.495     0.999890      1998943      9102.22
      18.959     0.999902      1998966     10240.00
      19.567     0.999915      1998991     11702.86
      20.143     0.999927      1999015     13653.33
      20.959     0.999939      1999039     16384.00
      21.375     0.999945      1999053     18204.44
      21.647     0.999951      1999065     20480.00
      21.983     0.999957      1999077     23405.71
      22.159     0.999963      1999089     27306.67
      22.527     0.999969      1999100     32768.00
      22.767     0.999973      1999107     36408.89
      23.071     0.999976      1999113     40960.00
      23.343     0.999979      1999119     46811.43
      23.535     0.999982      1999126     54613.33
      23.743     0.999985      1999131     65536.00
      23.855     0.999986      1999134     72817.78
      24.015     0.999988      1999137     81920.00
      24.111     0.999989      1999140     93622.86
      24.239     0.999991      1999143    109226.67
      24.383     0.999992      1999146    131072.00
      24.431     0.999993      1999148    145635.56
      24.447     0.999994      1999149    163840.00
      24.543     0.999995      1999152    187245.71
      24.543     0.999995      1999152    218453.33
      24.591     0.999996      1999154    262144.00
      24.735     0.999997      1999156    291271.11
      24.735     0.999997      1999156    327680.00
      24.735     0.999997      1999156    374491.43
      24.783     0.999998      1999157    436906.67
      24.863     0.999998      1999158    524288.00
      24.863     0.999998      1999158    582542.22
      24.863     0.999998      1999158    655360.00
      25.023     0.999999      1999159    748982.86
      25.023     0.999999      1999159    873813.33
      25.071     0.999999      1999160   1048576.00
      25.071     0.999999      1999160   1165084.44
      25.071     0.999999      1999160   1310720.00
      25.071     0.999999      1999160   1497965.71
      25.071     0.999999      1999160   1747626.67
      25.375     1.000000      1999161   2097152.00
      25.375     1.000000      1999161          inf

     [Mean    =        1.158, StdDeviation   =        0.827]
     [Max     =       25.360, Total count    =      1999161]
     [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2399616 requests in 1.00m, 153.33MB read
  
    Requests/sec:  39994.87
    Transfer/sec:      2.56MB

#### Результаты профилирования async-profiler (CPU): 
![Результаты профилирования async-profiler (CPU)](profilingResults/cpu_put_hw2.svg)

Анализ: 
 - Обработка запроса: 71.37%
 - Запись в сокет: 33.06%
 - Чтение из сокета: 10.04%
 - Вставка в ConcurrentSkipListMap - Memory Table в DAO занимает - 9.61%
 - Flush в 4 потока занимает - 9.61%
 
#### Результаты профилирования async-profiler (ALLOC):
 
`wrk2 -t4 -c16 -R40000 -d60s -s wrk/put.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  
      Thread calibration: mean lat.: 1.197ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.211ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.207ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.222ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.28ms    1.19ms  35.36ms   94.86%
        Req/Sec    10.55k     1.12k   25.30k    77.54%
  Latency Distribution (HdrHistogram - Recorded Latency)
  
     50.000%    1.12ms
     75.000%    1.62ms
     90.000%    2.05ms
     99.000%    5.89ms
     99.900%   14.98ms
     99.990%   23.42ms
     99.999%   32.13ms
    100.000%   35.39ms

  Detailed Percentile spectrum:
  
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.021     0.000000            1         1.00
       0.345     0.100000       200099         1.11
       0.579     0.200000       400095         1.25
       0.797     0.300000       600294         1.43
       0.972     0.400000       799681         1.67
       1.125     0.500000      1000273         2.00
       1.204     0.550000      1100242         2.22
       1.290     0.600000      1199552         2.50
       1.388     0.650000      1300357         2.86
       1.498     0.700000      1400211         3.33
       1.616     0.750000      1499748         4.00
       1.679     0.775000      1550133         4.44
       1.743     0.800000      1599479         5.00
       1.812     0.825000      1649854         5.71
       1.882     0.850000      1699681         6.67
       1.958     0.875000      1749260         8.00
       2.002     0.887500      1774378         8.89
       2.051     0.900000      1800278        10.00
       2.105     0.912500      1824995        11.43
       2.169     0.925000      1849377        13.33
       2.259     0.937500      1874645        16.00
       2.317     0.943750      1886981        17.78
       2.391     0.950000      1899369        20.00
       2.493     0.956250      1911871        22.86
       2.641     0.962500      1924242        26.67
       2.887     0.968750      1936723        32.00
       3.071     0.971875      1942950        35.56
       3.319     0.975000      1949216        40.00
       3.627     0.978125      1955411        45.71
       4.009     0.981250      1961673        53.33
       4.483     0.984375      1967933        64.00
       4.779     0.985938      1971050        71.11
       5.139     0.987500      1974166        80.00
       5.579     0.989062      1977303        91.43
       6.127     0.990625      1980412       106.67
       6.815     0.992188      1983537       128.00
       7.235     0.992969      1985095       142.22
       7.719     0.993750      1986669       160.00
       8.279     0.994531      1988213       182.86
       8.919     0.995313      1989774       213.33
       9.591     0.996094      1991338       256.00
      10.023     0.996484      1992118       284.44
      10.543     0.996875      1992908       320.00
      11.143     0.997266      1993679       365.71
      11.743     0.997656      1994458       426.67
      12.463     0.998047      1995239       512.00
      12.863     0.998242      1995633       568.89
      13.247     0.998437      1996020       640.00
      13.751     0.998633      1996411       731.43
      14.375     0.998828      1996801       853.33
      15.087     0.999023      1997189      1024.00
      15.495     0.999121      1997387      1137.78
      15.879     0.999219      1997582      1280.00
      16.463     0.999316      1997778      1462.86
      17.199     0.999414      1997973      1706.67
      17.855     0.999512      1998168      2048.00
      18.143     0.999561      1998263      2275.56
      18.623     0.999609      1998364      2560.00
      19.183     0.999658      1998458      2925.71
      19.839     0.999707      1998558      3413.33
      20.703     0.999756      1998653      4096.00
      21.311     0.999780      1998705      4551.11
      21.775     0.999805      1998751      5120.00
      22.319     0.999829      1998800      5851.43
      22.815     0.999854      1998850      6826.67
      23.135     0.999878      1998897      8192.00
      23.279     0.999890      1998922      9102.22
      23.455     0.999902      1998948     10240.00
      23.855     0.999915      1998971     11702.86
      24.207     0.999927      1998995     13653.33
      24.751     0.999939      1999019     16384.00
      25.119     0.999945      1999032     18204.44
      25.391     0.999951      1999044     20480.00
      25.583     0.999957      1999056     23405.71
      25.983     0.999963      1999068     27306.67
      27.055     0.999969      1999080     32768.00
      27.935     0.999973      1999087     36408.89
      28.543     0.999976      1999093     40960.00
      29.327     0.999979      1999099     46811.43
      30.015     0.999982      1999106     54613.33
      30.527     0.999985      1999111     65536.00
      30.911     0.999986      1999114     72817.78
      31.295     0.999988      1999117     81920.00
      31.871     0.999989      1999120     93622.86
      32.447     0.999991      1999123    109226.67
      32.927     0.999992      1999126    131072.00
      33.311     0.999993      1999128    145635.56
      33.567     0.999994      1999129    163840.00
      33.919     0.999995      1999131    187245.71
      34.111     0.999995      1999132    218453.33
      34.239     0.999996      1999134    262144.00
      34.303     0.999997      1999135    291271.11
      34.303     0.999997      1999135    327680.00
      34.527     0.999997      1999136    374491.43
      34.719     0.999998      1999137    436906.67
      34.975     0.999998      1999138    524288.00
      34.975     0.999998      1999138    582542.22
      34.975     0.999998      1999138    655360.00
      35.135     0.999999      1999139    748982.86
      35.135     0.999999      1999139    873813.33
      35.295     0.999999      1999140   1048576.00
      35.295     0.999999      1999140   1165084.44
      35.295     0.999999      1999140   1310720.00
      35.295     0.999999      1999140   1497965.71
      35.295     0.999999      1999140   1747626.67
      35.391     1.000000      1999141   2097152.00
      35.391     1.000000      1999141          inf
      
     [Mean    =        1.281, StdDeviation   =        1.188]
     [Max     =       35.360, Total count    =      1999141]
     [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  2399588 requests in 1.00m, 153.32MB read
  
    Requests/sec:  39994.51
    Transfer/sec:      2.56MB


#### Результаты профилирования async-profiler (ALLOC): 
![Результаты профилирования async-profiler (ALLOC)](profilingResults/alloc_put_hw2.svg)

Анализ:
 - HttpBuffer занимает - 94.6%
 - BasicService.upsert занимает - 31.31%
 - Dao.upsert занимает - 10.25%
 - Response - 6.92%
 - Parse Http Request - 20.6%
 - Request - 5.74%
 - Flush -2.69%
 
 
  
#### Результаты профилирования async-profiler (LOCK):
 
`wrk2 -t4 -c16 -R40000 -d60s -s wrk/put.lua --latency  http://localhost:8080`

 
 Running 1m test @ http://localhost:8080
   4 threads and 16 connections
       
       Thread calibration: mean lat.: 1.243ms, rate sampling interval: 10ms
       Thread calibration: mean lat.: 1.266ms, rate sampling interval: 10ms
       Thread calibration: mean lat.: 1.322ms, rate sampling interval: 10ms
       Thread calibration: mean lat.: 1.283ms, rate sampling interval: 10ms
       Thread Stats   Avg      Stdev     Max   +/- Stdev
         Latency     1.27ms    1.12ms  25.18ms   93.11%
         Req/Sec    10.55k     1.12k   23.20k    77.73%
   Latency Distribution (HdrHistogram - Recorded Latency)
       
      50.000%    1.13ms
      75.000%    1.61ms
      90.000%    2.04ms
      99.000%    5.75ms
      99.900%   14.09ms
      99.990%   20.85ms
      99.999%   24.54ms
     100.000%   25.20ms
 
   Detailed Percentile spectrum:
   
        Value   Percentile   TotalCount 1/(1-Percentile)
 
        0.021     0.000000            1         1.00
        0.346     0.100000       200491         1.11
        0.581     0.200000       400058         1.25
        0.800     0.300000       600083         1.43
        0.975     0.400000       799975         1.67
        1.128     0.500000      1000336         2.00
        1.205     0.550000      1100506         2.22
        1.290     0.600000      1200037         2.50
        1.386     0.650000      1299756         2.86
        1.495     0.700000      1399977         3.33
        1.612     0.750000      1499716         4.00
        1.674     0.775000      1549757         4.44
        1.739     0.800000      1599662         5.00
        1.807     0.825000      1650009         5.71
        1.876     0.850000      1699618         6.67
        1.951     0.875000      1749689         8.00
        1.992     0.887500      1774488         8.89
        2.037     0.900000      1799303        10.00
        2.089     0.912500      1824795        11.43
        2.151     0.925000      1849926        13.33
        2.229     0.937500      1874390        16.00
        2.283     0.943750      1886855        17.78
        2.353     0.950000      1899574        20.00
        2.443     0.956250      1911775        22.86
        2.577     0.962500      1924344        26.67
        2.797     0.968750      1936741        32.00
        2.967     0.971875      1942964        35.56
        3.195     0.975000      1949217        40.00
        3.497     0.978125      1955471        45.71
        3.881     0.981250      1961704        53.33
        4.379     0.984375      1967995        64.00
        4.683     0.985938      1971109        71.11
        5.039     0.987500      1974209        80.00
        5.459     0.989062      1977339        91.43
        5.959     0.990625      1980472       106.67
        6.571     0.992188      1983585       128.00
        6.951     0.992969      1985136       142.22
        7.411     0.993750      1986697       160.00
        7.907     0.994531      1988257       182.86
        8.495     0.995313      1989835       213.33
        9.119     0.996094      1991380       256.00
        9.487     0.996484      1992160       284.44
        9.831     0.996875      1992945       320.00
       10.287     0.997266      1993731       365.71
       10.831     0.997656      1994511       426.67
       11.423     0.998047      1995288       512.00
       11.823     0.998242      1995677       568.89
       12.319     0.998437      1996068       640.00
       12.927     0.998633      1996456       731.43
       13.527     0.998828      1996851       853.33
       14.167     0.999023      1997244      1024.00
       14.423     0.999121      1997432      1137.78
       14.847     0.999219      1997627      1280.00
       15.399     0.999316      1997823      1462.86
       16.087     0.999414      1998018      1706.67
       16.911     0.999512      1998217      2048.00
       17.215     0.999561      1998315      2275.56
       17.471     0.999609      1998408      2560.00
       17.807     0.999658      1998505      2925.71
       18.303     0.999707      1998605      3413.33
       18.799     0.999756      1998701      4096.00
       19.119     0.999780      1998750      4551.11
       19.583     0.999805      1998800      5120.00
       19.935     0.999829      1998848      5851.43
       20.335     0.999854      1998896      6826.67
       20.575     0.999878      1998945      8192.00
       20.687     0.999890      1998969      9102.22
       20.927     0.999902      1998994     10240.00
       21.327     0.999915      1999018     11702.86
       21.567     0.999927      1999045     13653.33
       21.679     0.999939      1999066     16384.00
       21.807     0.999945      1999079     18204.44
       21.935     0.999951      1999091     20480.00
       22.143     0.999957      1999103     23405.71
       22.527     0.999963      1999116     27306.67
       23.007     0.999969      1999127     32768.00
       23.263     0.999973      1999134     36408.89
       23.455     0.999976      1999141     40960.00
       23.823     0.999979      1999146     46811.43
       24.287     0.999982      1999154     54613.33
       24.367     0.999985      1999159     65536.00
       24.415     0.999986      1999163     72817.78
       24.431     0.999988      1999165     81920.00
       24.511     0.999989      1999167     93622.86
       24.575     0.999991      1999170    109226.67
       24.639     0.999992      1999174    131072.00
       24.671     0.999993      1999175    145635.56
       24.687     0.999994      1999176    163840.00
       24.799     0.999995      1999179    187245.71
       24.799     0.999995      1999179    218453.33
       24.895     0.999996      1999182    262144.00
       24.895     0.999997      1999182    291271.11
       24.895     0.999997      1999182    327680.00
       24.927     0.999997      1999183    374491.43
       25.007     0.999998      1999184    436906.67
       25.023     0.999998      1999185    524288.00
       25.023     0.999998      1999185    582542.22
       25.023     0.999998      1999185    655360.00
       25.103     0.999999      1999186    748982.86
       25.103     0.999999      1999186    873813.33
       25.135     0.999999      1999187   1048576.00
       25.135     0.999999      1999187   1165084.44
       25.135     0.999999      1999187   1310720.00
       25.135     0.999999      1999187   1497965.71
       25.135     0.999999      1999187   1747626.67
       25.199     1.000000      1999188   2097152.00
       25.199     1.000000      1999188          inf
 
     [Mean    =        1.270, StdDeviation   =        1.123]
     [Max     =       25.184, Total count    =      1999188]
     [Buckets =           27, SubBuckets     =         2048]
 ----------------------------------------------------------
   2399637 requests in 1.00m, 153.33MB read
       
     Requests/sec:  39994.80
     Transfer/sec:      2.56MB

#### Результаты профилирования async-profiler (LOCK): 
![Результаты профилирования async-profiler (LOCK)](profilingResults/lock_put_hw2.svg)

Анализ:
 - ReentrantLock - lock для cache в BasicService - 86.99
 - ReentrantReadWriteLock.ReadLock - 11.64%
 - ReentrantReadWriteLock.WriteLock - 1.37%

Ожидание ReentrantReadWriteLock.ReadLock, происходит при flush'e очередного `memory table` на диск.
Ожидание ReentrantReadWriteLock.WriteLock, происходит при желании записать на диск, но, когда в этот момент в `memory table` 
вставляют, удаляют, обновляют значения другие потоки.


### 2) Тестирование GET запросов

Параметры запуска тестов:
1. Thread - 4
2. Connection - 16
3. Requests per second - 2000
4. Duration - 60s

`wrk2 -t4 -c16 -R2000 -d60s -s wrk/get.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 16 connections
  
      Thread calibration: mean lat.: 4.743ms, rate sampling interval: 13ms
      Thread calibration: mean lat.: 3.646ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.738ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.470ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     3.08ms    3.02ms  52.77ms   95.58%
        Req/Sec   525.15     85.89     1.23k    78.05%
  Latency Distribution (HdrHistogram - Recorded Latency)
 
     50.000%    3.06ms
     75.000%    4.01ms
     90.000%    4.96ms
     99.000%   11.24ms
     99.900%   39.49ms
     99.990%   47.62ms
     99.999%   52.74ms
    100.000%   52.80ms

  Detailed Percentile spectrum:

       Value   Percentile   TotalCount 1/(1-Percentile)

       0.058     0.000000            1         1.00
       0.630     0.100000        10005         1.11
       0.964     0.200000        20016         1.25
       1.420     0.300000        29995         1.43
       2.605     0.400000        40012         1.67
       3.063     0.500000        50011         2.00
       3.253     0.550000        54993         2.22
       3.431     0.600000        59989         2.50
       3.613     0.650000        64984         2.86
       3.805     0.700000        70006         3.33
       4.011     0.750000        74970         4.00
       4.127     0.775000        77501         4.44
       4.251     0.800000        80027         5.00
       4.387     0.825000        82529         5.71
       4.535     0.850000        84967         6.67
       4.719     0.875000        87508         8.00
       4.827     0.887500        88718         8.89
       4.963     0.900000        89993        10.00
       5.127     0.912500        91230        11.43
       5.331     0.925000        92472        13.33
       5.595     0.937500        93722        16.00
       5.743     0.943750        94340        17.78
       5.911     0.950000        94960        20.00
       6.115     0.956250        95585        22.86
       6.347     0.962500        96214        26.67
       6.611     0.968750        96837        32.00
       6.763     0.971875        97148        35.56
       6.947     0.975000        97459        40.00
       7.183     0.978125        97773        45.71
       7.463     0.981250        98085        53.33
       7.919     0.984375        98396        64.00
       8.215     0.985938        98552        71.11
       8.759     0.987500        98708        80.00
      10.047     0.989062        98864        91.43
      12.663     0.990625        99020       106.67
      17.343     0.992188        99177       128.00
      19.535     0.992969        99255       142.22
      21.631     0.993750        99333       160.00
      23.599     0.994531        99413       182.86
      25.663     0.995313        99489       213.33
      28.095     0.996094        99567       256.00
      29.103     0.996484        99606       284.44
      30.607     0.996875        99645       320.00
      32.159     0.997266        99684       365.71
      33.439     0.997656        99723       426.67
      35.231     0.998047        99762       512.00
      36.031     0.998242        99782       568.89
      36.671     0.998437        99801       640.00
      37.567     0.998633        99821       731.43
      39.135     0.998828        99840       853.33
      39.615     0.999023        99863      1024.00
      39.839     0.999121        99870      1137.78
      40.191     0.999219        99882      1280.00
      40.895     0.999316        99889      1462.86
      42.111     0.999414        99899      1706.67
      42.879     0.999512        99910      2048.00
      43.007     0.999561        99914      2275.56
      43.743     0.999609        99919      2560.00
      44.223     0.999658        99923      2925.71
      45.119     0.999707        99928      3413.33
      45.663     0.999756        99933      4096.00
      45.887     0.999780        99936      4551.11
      46.207     0.999805        99938      5120.00
      46.623     0.999829        99940      5851.43
      47.103     0.999854        99943      6826.67
      47.391     0.999878        99945      8192.00
      47.615     0.999890        99947      9102.22
      48.703     0.999902        99948     10240.00
      49.119     0.999915        99949     11702.86
      49.919     0.999927        99950     13653.33
      50.303     0.999939        99951     16384.00
      50.815     0.999945        99952     18204.44
      50.943     0.999951        99953     20480.00
      50.943     0.999957        99953     23405.71
      51.135     0.999963        99954     27306.67
      51.135     0.999969        99954     32768.00
      52.159     0.999973        99955     36408.89
      52.159     0.999976        99955     40960.00
      52.159     0.999979        99955     46811.43
      52.735     0.999982        99956     54613.33
      52.735     0.999985        99956     65536.00
      52.735     0.999986        99956     72817.78
      52.735     0.999988        99956     81920.00
      52.735     0.999989        99956     93622.86
      52.799     0.999991        99957    109226.67
      52.799     1.000000        99957          inf
      
     [Mean    =        3.075, StdDeviation   =        3.021]
     [Max     =       52.768, Total count    =        99957]
     [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  119988 requests in 1.00m, 8.42MB read

    Requests/sec:   1999.81
    Transfer/sec:    143.73KB

#### Результаты профилирования async-profiler (CPU): 
![Результаты профилирования async-profiler (CPU)](profilingResults/cpu_get_hw2.svg)

Анализ:
 - DAO.get занимает - 97.55%
 - DAO.iterator занимает 95.14%
 - Merge различных iterator'ов занимает - 13.18%
 - 81.19% CPU тратится на то, чтобы бинарным поиском найти место в файле,
 с которого нужно читать, из которых 50.09% - это само чтение из файла

#### Результаты профилирования async-profiler (ALLOC): 

`wrk2 -t4 -c16 -R2000 -d60s -s wrk/get.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 16 connections
      
      Thread calibration: mean lat.: 6.269ms, rate sampling interval: 34ms
      Thread calibration: mean lat.: 4.930ms, rate sampling interval: 32ms
      Thread calibration: mean lat.: 4.843ms, rate sampling interval: 30ms
      Thread calibration: mean lat.: 4.597ms, rate sampling interval: 30ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     4.35ms    7.06ms 112.77ms   92.32%
        Req/Sec   507.86     81.33     1.10k    87.29%
  Latency Distribution (HdrHistogram - Recorded Latency)
      
     50.000%    2.71ms
     75.000%    4.09ms
     90.000%    7.66ms
     99.000%   39.17ms
     99.900%   61.82ms
     99.990%   95.93ms
     99.999%  111.10ms
    100.000%  112.83ms

  Detailed Percentile spectrum:
  
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.051     0.000000            1         1.00
       0.582     0.100000        10002         1.11
       0.924     0.200000        20011         1.25
       1.297     0.300000        29995         1.43
       2.133     0.400000        40001         1.67
       2.709     0.500000        49981         2.00
       2.963     0.550000        54984         2.22
       3.221     0.600000        59980         2.50
       3.487     0.650000        64985         2.86
       3.785     0.700000        69986         3.33
       4.093     0.750000        74983         4.00
       4.279     0.775000        77509         4.44
       4.499     0.800000        79978         5.00
       4.767     0.825000        82476         5.71
       5.119     0.850000        84977         6.67
       5.707     0.875000        87467         8.00
       6.459     0.887500        88716         8.89
       7.659     0.900000        89963        10.00
       9.319     0.912500        91211        11.43
      11.783     0.925000        92461        13.33
      14.335     0.937500        93713        16.00
      15.743     0.943750        94339        17.78
      17.023     0.950000        94973        20.00
      18.639     0.956250        95592        22.86
      20.751     0.962500        96209        26.67
      23.951     0.968750        96837        32.00
      25.759     0.971875        97146        35.56
      27.695     0.975000        97461        40.00
      29.743     0.978125        97772        45.71
      31.775     0.981250        98083        53.33
      34.143     0.984375        98401        64.00
      35.327     0.985938        98557        71.11
      36.575     0.987500        98711        80.00
      38.303     0.989062        98868        91.43
      39.967     0.990625        99023       106.67
      41.823     0.992188        99177       128.00
      42.975     0.992969        99258       142.22
      44.031     0.993750        99333       160.00
      45.279     0.994531        99412       182.86
      46.687     0.995313        99489       213.33
      48.415     0.996094        99567       256.00
      49.087     0.996484        99607       284.44
      50.047     0.996875        99645       320.00
      51.199     0.997266        99685       365.71
      52.575     0.997656        99723       426.67
      54.687     0.998047        99762       512.00
      55.999     0.998242        99782       568.89
      57.055     0.998437        99802       640.00
      58.655     0.998633        99821       731.43
      60.511     0.998828        99841       853.33
      62.303     0.999023        99861      1024.00
      63.135     0.999121        99870      1137.78
      63.999     0.999219        99879      1280.00
      65.727     0.999316        99889      1462.86
      67.199     0.999414        99899      1706.67
      68.863     0.999512        99909      2048.00
      70.079     0.999561        99914      2275.56
      70.399     0.999609        99918      2560.00
      71.615     0.999658        99923      2925.71
      73.791     0.999707        99928      3413.33
      77.567     0.999756        99933      4096.00
      80.447     0.999780        99936      4551.11
      82.303     0.999805        99938      5120.00
      88.575     0.999829        99940      5851.43
      92.735     0.999854        99943      6826.67
      93.311     0.999878        99945      8192.00
      95.935     0.999890        99947      9102.22
      99.199     0.999902        99949     10240.00
      99.199     0.999915        99949     11702.86
     102.911     0.999927        99950     13653.33
     103.359     0.999939        99951     16384.00
     103.423     0.999945        99952     18204.44
     107.071     0.999951        99953     20480.00
     107.071     0.999957        99953     23405.71
     107.583     0.999963        99954     27306.67
     107.583     0.999969        99954     32768.00
     109.119     0.999973        99955     36408.89
     109.119     0.999976        99955     40960.00
     109.119     0.999979        99955     46811.43
     111.103     0.999982        99956     54613.33
     111.103     0.999985        99956     65536.00
     111.103     0.999986        99956     72817.78
     111.103     0.999988        99956     81920.00
     111.103     0.999989        99956     93622.86
     112.831     0.999991        99957    109226.67
     112.831     1.000000        99957          inf
     
     [Mean    =        4.346, StdDeviation   =        7.063]
     [Max     =      112.768, Total count    =        99957]
     [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  119989 requests in 1.00m, 8.42MB read
    
    Requests/sec:   1999.85
    Transfer/sec:    143.73KB

#### Результаты профилирования async-profiler (ALLOC): 
![Результаты профилирования async-profiler (ALLOC)](profilingResults/alloc_get_hw2.svg)

Анализ:
 - HttpBuffer занимает - 99.41%
 - Merge Iterator и его Priority Queue занимают - 24.58%
 - BasicService.get занимает - 97.76%
 - Dao.get занимает - 97.42%
 - SSTable.iterator - 63.64%, при этом в основном память выделяется под байтовый буфер для 
 текущего ключа в бинарном поиске, где 52.49% выделяется под сам ключ, а 10.53% на смещение
 до него 
 - Transformed.iterator - 7.09%
 
 #### Результаты профилирования async-profiler (LOCK): 
 
 `wrk2 -t4 -c16 -R2000 -d60s -s wrk/get.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 16 connections
      
      Thread calibration: mean lat.: 3.804ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 4.328ms, rate sampling interval: 12ms
      Thread calibration: mean lat.: 3.754ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 2.527ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     3.60ms    1.26ms  23.17ms   74.81%
        Req/Sec   525.55     72.22     0.89k    61.93%
  Latency Distribution (HdrHistogram - Recorded Latency)
 
     50.000%    3.58ms
     75.000%    4.29ms
     90.000%    5.08ms
     99.000%    7.12ms
     99.900%    8.45ms
     99.990%   13.01ms
     99.999%   18.88ms
    100.000%   23.18ms

  Detailed Percentile spectrum:
  
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.044     0.000000            1         1.00
       2.087     0.100000        10012         1.11
       2.729     0.200000        19995         1.25
       3.061     0.300000        30023         1.43
       3.333     0.400000        40024         1.67
       3.583     0.500000        50003         2.00
       3.707     0.550000        54998         2.22
       3.833     0.600000        60013         2.50
       3.969     0.650000        65001         2.86
       4.119     0.700000        69997         3.33
       4.287     0.750000        75035         4.00
       4.379     0.775000        77483         4.44
       4.483     0.800000        79999         5.00
       4.595     0.825000        82491         5.71
       4.727     0.850000        85026         6.67
       4.887     0.875000        87488         8.00
       4.975     0.887500        88737         8.89
       5.079     0.900000        89963        10.00
       5.199     0.912500        91203        11.43
       5.331     0.925000        92452        13.33
       5.475     0.937500        93704        16.00
       5.567     0.943750        94325        17.78
       5.667     0.950000        94962        20.00
       5.779     0.956250        95593        22.86
       5.907     0.962500        96215        26.67
       6.059     0.968750        96833        32.00
       6.147     0.971875        97136        35.56
       6.259     0.975000        97454        40.00
       6.395     0.978125        97764        45.71
       6.543     0.981250        98075        53.33
       6.723     0.984375        98387        64.00
       6.815     0.985938        98539        71.11
       6.931     0.987500        98696        80.00
       7.055     0.989062        98856        91.43
       7.167     0.990625        99010       106.67
       7.299     0.992188        99166       128.00
       7.375     0.992969        99242       142.22
       7.435     0.993750        99322       160.00
       7.551     0.994531        99400       182.86
       7.635     0.995313        99477       213.33
       7.739     0.996094        99555       256.00
       7.803     0.996484        99593       284.44
       7.887     0.996875        99632       320.00
       7.963     0.997266        99671       365.71
       8.015     0.997656        99710       426.67
       8.103     0.998047        99750       512.00
       8.175     0.998242        99770       568.89
       8.271     0.998437        99788       640.00
       8.343     0.998633        99810       731.43
       8.407     0.998828        99829       853.33
       8.463     0.999023        99850      1024.00
       8.511     0.999121        99857      1137.78
       8.583     0.999219        99866      1280.00
       8.711     0.999316        99876      1462.86
       8.879     0.999414        99886      1706.67
       9.103     0.999512        99896      2048.00
       9.271     0.999561        99901      2275.56
       9.415     0.999609        99905      2560.00
       9.759     0.999658        99910      2925.71
      10.111     0.999707        99915      3413.33
      10.575     0.999756        99920      4096.00
      10.807     0.999780        99923      4551.11
      11.167     0.999805        99926      5120.00
      11.415     0.999829        99927      5851.43
      11.567     0.999854        99930      6826.67
      12.127     0.999878        99932      8192.00
      13.007     0.999890        99934      9102.22
      13.439     0.999902        99935     10240.00
      14.111     0.999915        99936     11702.86
      14.639     0.999927        99937     13653.33
      15.167     0.999939        99938     16384.00
      15.863     0.999945        99939     18204.44
      16.943     0.999951        99940     20480.00
      16.943     0.999957        99940     23405.71
      17.583     0.999963        99941     27306.67
      17.583     0.999969        99941     32768.00
      18.399     0.999973        99942     36408.89
      18.399     0.999976        99942     40960.00
      18.399     0.999979        99942     46811.43
      18.879     0.999982        99943     54613.33
      18.879     0.999985        99943     65536.00
      18.879     0.999986        99943     72817.78
      18.879     0.999988        99943     81920.00
      18.879     0.999989        99943     93622.86
      23.183     0.999991        99944    109226.67
      23.183     1.000000        99944          inf
      
    [Mean    =        3.596, StdDeviation   =        1.260]
    [Max     =       23.168, Total count    =        99944]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  119974 requests in 1.00m, 8.42MB read

    Requests/sec:   1999.59
    Transfer/sec:    143.71KB

#### Результаты профилирования async-profiler (LOCK): 
![Результаты профилирования async-profiler (LOCK)](profilingResults/lock_get_hw2.svg)

Анализ:
 - ReentrantLock - lock для cache в BasicService - 33.5%
 - 55.19% занимают блокировки файлов
 - MergeIterator - 8.3%, что также является блокировкой файлов
 - TransformedIterator - 2.51%, что также является блокировкой файлов
 
Из анализа видно, что большую часть занимают блокировки в файлах
 
