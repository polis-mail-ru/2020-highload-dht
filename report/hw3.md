# Нагрузочное тестирование с помощью wrk2



### 1) Тестирование PUT запросов

Параметры запуска тестов:
1. Thread - 4
2. Connection - 64
3. Requests per second - 80000
4. Duration - 60s

`wrk2 -t4 -c64 -R80000 -d60s -s wrk/put.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 64 connections
  
      Thread calibration: mean lat.: 1.315ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.322ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.352ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.317ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.38ms    0.98ms  36.80ms   82.51%
        Req/Sec    21.11k     2.36k   45.33k    77.67%
  Latency Distribution (HdrHistogram - Recorded Latency)

     50.000%    1.24ms
     75.000%    1.76ms
     90.000%    2.30ms
     99.000%    5.11ms
     99.900%    9.64ms
     99.990%   19.23ms
     99.999%   29.26ms
    100.000%   36.83ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.023     0.000000            1         1.00
       0.431     0.100000       399910         1.11
       0.671     0.200000       800111         1.25
       0.875     0.300000      1199630         1.43
       1.061     0.400000      1598150         1.67
       1.241     0.500000      1997998         2.00
       1.331     0.550000      2196683         2.22
       1.425     0.600000      2396716         2.50
       1.527     0.650000      2597630         2.86
       1.637     0.700000      2796202         3.33
       1.760     0.750000      2996378         4.00
       1.827     0.775000      3095018         4.44
       1.900     0.800000      3194939         5.00
       1.980     0.825000      3295518         5.71
       2.069     0.850000      3394713         6.67
       2.173     0.875000      3495007         8.00
       2.233     0.887500      3545128         8.89
       2.299     0.900000      3594184        10.00
       2.377     0.912500      3644328        11.43
       2.471     0.925000      3694095        13.33
       2.589     0.937500      3744614        16.00
       2.659     0.943750      3768902        17.78
       2.745     0.950000      3794222        20.00
       2.849     0.956250      3818981        22.86
       2.985     0.962500      3843875        26.67
       3.183     0.968750      3868875        32.00
       3.317     0.971875      3881321        35.56
       3.489     0.975000      3893726        40.00
       3.705     0.978125      3906226        45.71
       3.975     0.981250      3918635        53.33
       4.307     0.984375      3931169        64.00
       4.503     0.985938      3937367        71.11
       4.719     0.987500      3943592        80.00
       4.955     0.989062      3949835        91.43
       5.223     0.990625      3956132       106.67
       5.523     0.992188      3962308       128.00
       5.699     0.992969      3965440       142.22
       5.891     0.993750      3968549       160.00
       6.115     0.994531      3971656       182.86
       6.383     0.995313      3974793       213.33
       6.687     0.996094      3977895       256.00
       6.887     0.996484      3979468       284.44
       7.103     0.996875      3981013       320.00
       7.363     0.997266      3982570       365.71
       7.683     0.997656      3984133       426.67
       8.055     0.998047      3985697       512.00
       8.279     0.998242      3986480       568.89
       8.535     0.998437      3987248       640.00
       8.831     0.998633      3988029       731.43
       9.223     0.998828      3988818       853.33
       9.711     0.999023      3989594      1024.00
      10.015     0.999121      3989981      1137.78
      10.367     0.999219      3990378      1280.00
      10.767     0.999316      3990760      1462.86
      11.271     0.999414      3991155      1706.67
      11.895     0.999512      3991539      2048.00
      12.279     0.999561      3991736      2275.56
      12.663     0.999609      3991928      2560.00
      13.159     0.999658      3992124      2925.71
      13.791     0.999707      3992317      3413.33
      14.591     0.999756      3992514      4096.00
      15.151     0.999780      3992611      4551.11
      15.799     0.999805      3992707      5120.00
      16.511     0.999829      3992804      5851.43
      17.327     0.999854      3992904      6826.67
      18.207     0.999878      3993000      8192.00
      18.751     0.999890      3993049      9102.22
      19.359     0.999902      3993098     10240.00
      20.047     0.999915      3993145     11702.86
      20.703     0.999927      3993194     13653.33
      21.359     0.999939      3993243     16384.00
      21.775     0.999945      3993267     18204.44
      22.271     0.999951      3993292     20480.00
      22.735     0.999957      3993317     23405.71
      23.279     0.999963      3993340     27306.67
      23.887     0.999969      3993365     32768.00
      24.351     0.999973      3993377     36408.89
      24.831     0.999976      3993389     40960.00
      25.327     0.999979      3993401     46811.43
      25.919     0.999982      3993413     54613.33
      26.415     0.999985      3993426     65536.00
      27.023     0.999986      3993432     72817.78
      28.495     0.999988      3993438     81920.00
      29.231     0.999989      3993444     93622.86
      30.063     0.999991      3993450    109226.67
      30.639     0.999992      3993456    131072.00
      31.103     0.999993      3993459    145635.56
      31.791     0.999994      3993462    163840.00
      32.431     0.999995      3993465    187245.71
      33.375     0.999995      3993468    218453.33
      34.047     0.999996      3993471    262144.00
      34.527     0.999997      3993473    291271.11
      34.559     0.999997      3993474    327680.00
      34.815     0.999997      3993476    374491.43
      34.975     0.999998      3993477    436906.67
      35.135     0.999998      3993479    524288.00
      35.743     0.999998      3993480    582542.22
      35.743     0.999998      3993480    655360.00
      36.223     0.999999      3993481    748982.86
      36.287     0.999999      3993482    873813.33
      36.383     0.999999      3993483   1048576.00
      36.383     0.999999      3993483   1165084.44
      36.383     0.999999      3993483   1310720.00
      36.607     0.999999      3993484   1497965.71
      36.607     0.999999      3993484   1747626.67
      36.735     1.000000      3993485   2097152.00
      36.735     1.000000      3993485   2330168.89
      36.735     1.000000      3993485   2621440.00
      36.735     1.000000      3993485   2995931.43
      36.735     1.000000      3993485   3495253.33
      36.831     1.000000      3993486   4194304.00
      36.831     1.000000      3993486          inf
      
    [Mean    =        1.377, StdDeviation   =        0.984]
    [Max     =       36.800, Total count    =      3993486]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  4777530 requests in 1.00m, 305.27MB read

    Requests/sec:  79628.29
    Transfer/sec:      5.09MB

#### Результаты профилирования async-profiler (CPU): 
![Результаты профилирования async-profiler (CPU)](profilingResults/cpu_put_hw3.svg)

Анализ: 
 - Выборка запроса selector'ом: 9.52%
 - Обработка запроа - 17.46%, из которых 3.29% уходит на постановку задачи в очередь Exector Service и 7.49% на
 чтение из сокета
 - Обработка запросов в пуле потоков ExecutorService - 67.53%
 - Выборка из очереди ExecutorService занимает - 11.64%, из которых 6.67% уходит на блокировку и
 2.58% на разблокировку lock'a в очереди
 - На flush данных на диск в пуле Executor Service'ов уходит 14.22%
 - Выполнение Runnable, вытащенного из очереди Executor Service, занимает 41.01%, из которых 29.59% уходит на отправку
 Response'a(25.89% - это запись в сокета) и 8.18% на вставку в DAO(где 7.16% вставка в ConcurrentSkipListMap)
 
 #### Результаты профилирования предудыщего этапа async-profiler (CPU): 
 ![Результаты профилирования async-profiler (CPU)](profilingResults/cpu_put_hw3.svg)

 
Анализ: 
 - Обработка запроса: 71.37%
 - Запись в сокет: 33.06%
 - Чтение из сокета: 10.04%
 - Вставка в ConcurrentSkipListMap - Memory Table в DAO занимает - 9.61%
 - Flush в 4 потока занимает - 9.61%
 
 В сравнении с предыдущим этапом видно, что время обработки запроса сократилось примерно в 4 раза, 
 что позволяет намного меньше блокировать наши Selector'ы. Время, которое мы раньше затрачивали на
 обработку запроса, теперь делегировалось пулу потоков Executor Service. Чтение, запись в сокет, а также
 flush на диск примерно сохранились в том же порядке.
 
 
#### Результаты профилирования async-profiler (ALLOC):
 
`wrk2 -t4 -c64 -R80000 -d60s -s wrk/put.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 64 connections

      Thread calibration: mean lat.: 1.252ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.241ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.256ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.223ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.32ms    0.86ms  18.50ms   77.97%
        Req/Sec    21.10k     2.17k   40.56k    76.00%
  Latency Distribution (HdrHistogram - Recorded Latency)

     50.000%    1.21ms
     75.000%    1.72ms
     90.000%    2.22ms
     99.000%    4.38ms
     99.900%    8.40ms
     99.990%   12.77ms
     99.999%   16.34ms
    100.000%   18.51ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.025     0.000000            2         1.00
       0.424     0.100000       399743         1.11
       0.651     0.200000       799775         1.25
       0.848     0.300000      1198060         1.43
       1.031     0.400000      1599426         1.67
       1.208     0.500000      1998828         2.00
       1.297     0.550000      2196454         2.22
       1.390     0.600000      2396804         2.50
       1.488     0.650000      2595925         2.86
       1.596     0.700000      2796963         3.33
       1.715     0.750000      2996497         4.00
       1.780     0.775000      3095801         4.44
       1.851     0.800000      3196043         5.00
       1.927     0.825000      3295493         5.71
       2.012     0.850000      3395501         6.67
       2.109     0.875000      3495182         8.00
       2.163     0.887500      3544520         8.89
       2.225     0.900000      3595575        10.00
       2.293     0.912500      3644786        11.43
       2.373     0.925000      3694977        13.33
       2.469     0.937500      3744085        16.00
       2.529     0.943750      3769603        17.78
       2.595     0.950000      3794198        20.00
       2.675     0.956250      3819158        22.86
       2.773     0.962500      3843898        26.67
       2.903     0.968750      3868953        32.00
       2.985     0.971875      3881338        35.56
       3.087     0.975000      3893765        40.00
       3.217     0.978125      3906166        45.71
       3.395     0.981250      3918715        53.33
       3.639     0.984375      3931174        64.00
       3.799     0.985938      3937363        71.11
       3.993     0.987500      3943628        80.00
       4.219     0.989062      3949851        91.43
       4.495     0.990625      3956150       106.67
       4.815     0.992188      3962342       128.00
       5.007     0.992969      3965451       142.22
       5.219     0.993750      3968580       160.00
       5.455     0.994531      3971705       182.86
       5.723     0.995313      3974800       213.33
       6.039     0.996094      3977933       256.00
       6.219     0.996484      3979491       284.44
       6.427     0.996875      3981050       320.00
       6.659     0.997266      3982612       365.71
       6.923     0.997656      3984172       426.67
       7.243     0.998047      3985737       512.00
       7.427     0.998242      3986500       568.89
       7.631     0.998437      3987291       640.00
       7.859     0.998633      3988060       731.43
       8.131     0.998828      3988844       853.33
       8.447     0.999023      3989637      1024.00
       8.631     0.999121      3990014      1137.78
       8.847     0.999219      3990409      1280.00
       9.079     0.999316      3990795      1462.86
       9.359     0.999414      3991186      1706.67
       9.711     0.999512      3991575      2048.00
       9.903     0.999561      3991764      2275.56
      10.127     0.999609      3991959      2560.00
      10.391     0.999658      3992154      2925.71
      10.703     0.999707      3992350      3413.33
      11.071     0.999756      3992545      4096.00
      11.271     0.999780      3992641      4551.11
      11.471     0.999805      3992738      5120.00
      11.775     0.999829      3992835      5851.43
      12.039     0.999854      3992935      6826.67
      12.383     0.999878      3993030      8192.00
      12.599     0.999890      3993079      9102.22
      12.839     0.999902      3993128     10240.00
      13.031     0.999915      3993177     11702.86
      13.415     0.999927      3993225     13653.33
      13.775     0.999939      3993274     16384.00
      14.063     0.999945      3993298     18204.44
      14.311     0.999951      3993323     20480.00
      14.615     0.999957      3993347     23405.71
      14.935     0.999963      3993371     27306.67
      15.215     0.999969      3993397     32768.00
      15.359     0.999973      3993408     36408.89
      15.415     0.999976      3993420     40960.00
      15.663     0.999979      3993434     46811.43
      15.751     0.999982      3993444     54613.33
      15.975     0.999985      3993458     65536.00
      16.063     0.999986      3993463     72817.78
      16.167     0.999988      3993469     81920.00
      16.271     0.999989      3993475     93622.86
      16.431     0.999991      3993481    109226.67
      16.559     0.999992      3993487    131072.00
      16.671     0.999993      3993490    145635.56
      16.847     0.999994      3993493    163840.00
      16.911     0.999995      3993497    187245.71
      16.959     0.999995      3993499    218453.33
      17.103     0.999996      3993502    262144.00
      17.167     0.999997      3993504    291271.11
      17.279     0.999997      3993505    327680.00
      17.455     0.999997      3993507    374491.43
      17.487     0.999998      3993508    436906.67
      17.599     0.999998      3993510    524288.00
      17.727     0.999998      3993511    582542.22
      17.727     0.999998      3993511    655360.00
      17.823     0.999999      3993512    748982.86
      18.079     0.999999      3993513    873813.33
      18.095     0.999999      3993514   1048576.00
      18.095     0.999999      3993514   1165084.44
      18.095     0.999999      3993514   1310720.00
      18.127     0.999999      3993515   1497965.71
      18.127     0.999999      3993515   1747626.67
      18.399     1.000000      3993516   2097152.00
      18.399     1.000000      3993516   2330168.89
      18.399     1.000000      3993516   2621440.00
      18.399     1.000000      3993516   2995931.43
      18.399     1.000000      3993516   3495253.33
      18.511     1.000000      3993517   4194304.00
      18.511     1.000000      3993517          inf
      
    [Mean    =        1.320, StdDeviation   =        0.864]
    [Max     =       18.496, Total count    =      3993517]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  4796848 requests in 1.00m, 306.50MB read
  
    Requests/sec:  79948.16
    Transfer/sec:      5.11MB

#### Результаты профилирования async-profiler (ALLOC): 
![Результаты профилирования async-profiler (ALLOC)](profilingResults/alloc_put_hw3.svg)

Анализ:
 - NativeSelector.select занимает - 1.73%
 - HttpBuffer занимает - 46.93%
 - Request - 4.68%
 - Parse Http Request - 17.98%
 - handle request - 9.9%
 - ThreadPoolExecutor.runWorker занимает 51.34%, где:
    - sendResponse - 9.34%, а сам Response - 7.09%
    - Dao.upsert занимает - 14.25%
    - Flush -2.05%
 
#### Результаты профилирования предыдущего этапа async-profiler (ALLOC): 
![Результаты профилирования async-profiler (ALLOC)](profilingResults/alloc_put_hw2.svg)

Анализ:
 - HttpBuffer занимает - 94.6%
 - BasicService.upsert занимает - 31.31%
 - Dao.upsert занимает - 10.25%
 - Response - 6.92%
 - Parse Http Request - 20.6%
 - Request - 5.74%
 - Flush -2.69%
 
В сравенение с предыдущим этапом видно, что в целом количество выделенной памяти и ее распределение 
изменилась не сильно. Разница лишь в том, что HttpBuffer запрашивает в 2 раза меньше памяти. Но та же
память теперь аллоцируется при исполнении задачи из ExecutorService'a.
  
#### Результаты профилирования async-profiler (LOCK):
 
`wrk2 -t4 -c64 -R80000 -d60s -s wrk/put.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 64 connections
  
      Thread calibration: mean lat.: 1.290ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.283ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.310ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 1.281ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.36ms    0.92ms  24.51ms   79.75%
        Req/Sec    21.12k     2.39k   42.33k    78.38%
  Latency Distribution (HdrHistogram - Recorded Latency)

     50.000%    1.23ms
     75.000%    1.75ms
     90.000%    2.28ms
     99.000%    5.08ms
     99.900%    8.38ms
     99.990%   12.18ms
     99.999%   22.62ms
    100.000%   24.53ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.024     0.000000            2         1.00
       0.427     0.100000       399671         1.11
       0.664     0.200000       800121         1.25
       0.868     0.300000      1198573         1.43
       1.054     0.400000      1597611         1.67
       1.233     0.500000      1996797         2.00
       1.324     0.550000      2197505         2.22
       1.417     0.600000      2396216         2.50
       1.519     0.650000      2597373         2.86
       1.628     0.700000      2796190         3.33
       1.749     0.750000      2995489         4.00
       1.816     0.775000      3096005         4.44
       1.888     0.800000      3195978         5.00
       1.966     0.825000      3294753         5.71
       2.055     0.850000      3395598         6.67
       2.155     0.875000      3494528         8.00
       2.213     0.887500      3544776         8.89
       2.277     0.900000      3594261        10.00
       2.351     0.912500      3644068        11.43
       2.441     0.925000      3694804        13.33
       2.551     0.937500      3744586        16.00
       2.617     0.943750      3768944        17.78
       2.697     0.950000      3794045        20.00
       2.793     0.956250      3819192        22.86
       2.915     0.962500      3843983        26.67
       3.089     0.968750      3868811        32.00
       3.209     0.971875      3881189        35.56
       3.371     0.975000      3893764        40.00
       3.583     0.978125      3906221        45.71
       3.859     0.981250      3918664        53.33
       4.223     0.984375      3931117        64.00
       4.431     0.985938      3937345        71.11
       4.663     0.987500      3943597        80.00
       4.915     0.989062      3949855        91.43
       5.195     0.990625      3956084       106.67
       5.511     0.992188      3962315       128.00
       5.691     0.992969      3965458       142.22
       5.883     0.993750      3968549       160.00
       6.091     0.994531      3971674       182.86
       6.331     0.995313      3974806       213.33
       6.603     0.996094      3977907       256.00
       6.751     0.996484      3979443       284.44
       6.923     0.996875      3981031       320.00
       7.103     0.997266      3982586       365.71
       7.299     0.997656      3984139       426.67
       7.535     0.998047      3985695       512.00
       7.667     0.998242      3986472       568.89
       7.803     0.998437      3987246       640.00
       7.979     0.998633      3988040       731.43
       8.171     0.998828      3988804       853.33
       8.415     0.999023      3989596      1024.00
       8.543     0.999121      3989977      1137.78
       8.695     0.999219      3990382      1280.00
       8.855     0.999316      3990752      1462.86
       9.055     0.999414      3991148      1706.67
       9.279     0.999512      3991529      2048.00
       9.415     0.999561      3991726      2275.56
       9.567     0.999609      3991927      2560.00
       9.727     0.999658      3992120      2925.71
       9.927     0.999707      3992312      3413.33
      10.215     0.999756      3992507      4096.00
      10.359     0.999780      3992601      4551.11
      10.591     0.999805      3992700      5120.00
      10.815     0.999829      3992798      5851.43
      11.143     0.999854      3992897      6826.67
      11.607     0.999878      3992993      8192.00
      11.935     0.999890      3993042      9102.22
      12.239     0.999902      3993089     10240.00
      12.591     0.999915      3993139     11702.86
      12.935     0.999927      3993188     13653.33
      13.335     0.999939      3993235     16384.00
      13.599     0.999945      3993259     18204.44
      13.935     0.999951      3993284     20480.00
      14.303     0.999957      3993308     23405.71
      14.839     0.999963      3993332     27306.67
      16.007     0.999969      3993357     32768.00
      16.863     0.999973      3993369     36408.89
      17.983     0.999976      3993381     40960.00
      18.863     0.999979      3993393     46811.43
      19.855     0.999982      3993405     54613.33
      20.991     0.999985      3993418     65536.00
      21.295     0.999986      3993424     72817.78
      21.935     0.999988      3993430     81920.00
      22.543     0.999989      3993436     93622.86
      22.671     0.999991      3993442    109226.67
      23.039     0.999992      3993448    131072.00
      23.151     0.999993      3993451    145635.56
      23.247     0.999994      3993455    163840.00
      23.343     0.999995      3993457    187245.71
      23.471     0.999995      3993460    218453.33
      23.599     0.999996      3993464    262144.00
      23.711     0.999997      3993465    291271.11
      23.759     0.999997      3993466    327680.00
      23.887     0.999997      3993469    374491.43
      23.887     0.999998      3993469    436906.67
      23.935     0.999998      3993471    524288.00
      24.127     0.999998      3993472    582542.22
      24.127     0.999998      3993472    655360.00
      24.255     0.999999      3993473    748982.86
      24.383     0.999999      3993474    873813.33
      24.399     0.999999      3993475   1048576.00
      24.399     0.999999      3993475   1165084.44
      24.399     0.999999      3993475   1310720.00
      24.447     0.999999      3993476   1497965.71
      24.447     0.999999      3993476   1747626.67
      24.511     1.000000      3993477   2097152.00
      24.511     1.000000      3993477   2330168.89
      24.511     1.000000      3993477   2621440.00
      24.511     1.000000      3993477   2995931.43
      24.511     1.000000      3993477   3495253.33
      24.527     1.000000      3993478   4194304.00
      24.527     1.000000      3993478          inf
      
    [Mean    =        1.360, StdDeviation   =        0.923]
    [Max     =       24.512, Total count    =      3993478]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  4777624 requests in 1.00m, 305.27MB read
  
    Requests/sec:  79628.87
    Transfer/sec:      5.09MB


#### Результаты профилирования async-profiler (LOCK): 
![Результаты профилирования async-profiler (LOCK)](profilingResults/lock_put_hw3.svg)

Анализ:
 - 34% занимает блокировки при постановки задачи в очередь ExecutorService'a
 - Выборка из ArrayBlockingQueue ExecutorService'a занимает 64.28%
 - sendResponse - 0.42%
 - ReentrantLock - lock для cache в BasicService - 0.94%
 - ReentrantReadWriteLock - 0.03%

Видим, что большую часть времени занимают блокировки в ArrayBlockingQueue при постановки и выборки
задач в Executor Service.
Также можно заметить, что посравнению с предыдущим этам, время блокирования увеличилось на порядок(так как большую часть 
времени занимали блокировки в cache), но пропускная способность сервера увеличилась за счет того, что мы не блокируем 
наши Selector'ы.

#### Результаты профилирования предыдущего этапа async-profiler (LOCK): 
![Результаты профилирования async-profiler (LOCK)](profilingResults/lock_put_hw2.svg)


### 2) Тестирование GET запросов

Параметры запуска тестов:
1. Thread - 4
2. Connection - 64
3. Requests per second - 2500
4. Duration - 60s

`wrk2 -t4 -c64 -R2500 -d60s -s wrk/get.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 64 connections
  
      Thread calibration: mean lat.: 6.770ms, rate sampling interval: 48ms
      Thread calibration: mean lat.: 7.424ms, rate sampling interval: 49ms
      Thread calibration: mean lat.: 6.302ms, rate sampling interval: 46ms
      Thread calibration: mean lat.: 6.265ms, rate sampling interval: 47ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency    54.68ms  135.81ms 681.47ms   89.28%
        Req/Sec   623.96     79.97     0.94k    87.59%
  Latency Distribution (HdrHistogram - Recorded Latency)
  
     50.000%    3.34ms
     75.000%   11.81ms
     90.000%  221.44ms
     99.000%  604.67ms
     99.900%  644.61ms
     99.990%  666.11ms
     99.999%  680.96ms
    100.000%  681.98ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.054     0.000000            1         1.00
       0.672     0.100000        12350         1.11
       1.270     0.200000        24674         1.25
       2.537     0.300000        37017         1.43
       3.005     0.400000        49367         1.67
       3.341     0.500000        61744         2.00
       3.509     0.550000        67894         2.22
       3.687     0.600000        74058         2.50
       3.903     0.650000        80192         2.86
       4.231     0.700000        86368         3.33
      11.807     0.750000        92501         4.00
      25.263     0.775000        95584         4.44
      33.087     0.800000        98680         5.00
      41.151     0.825000       101752         5.71
      51.615     0.850000       104837         6.67
     108.351     0.875000       107919         8.00
     166.527     0.887500       109467         8.89
     221.439     0.900000       111004        10.00
     276.735     0.912500       112546        11.43
     333.311     0.925000       114086        13.33
     386.815     0.937500       115632        16.00
     413.951     0.943750       116405        17.78
     443.903     0.950000       117172        20.00
     467.455     0.956250       117944        22.86
     483.583     0.962500       118712        26.67
     509.695     0.968750       119483        32.00
     523.775     0.971875       119868        35.56
     537.599     0.975000       120251        40.00
     550.911     0.978125       120643        45.71
     565.247     0.981250       121031        53.33
     580.095     0.984375       121407        64.00
     586.751     0.985938       121602        71.11
     593.919     0.987500       121801        80.00
     600.575     0.989062       121985        91.43
     607.231     0.990625       122181       106.67
     613.375     0.992188       122381       128.00
     616.447     0.992969       122470       142.22
     620.031     0.993750       122568       160.00
     623.615     0.994531       122662       182.86
     627.199     0.995313       122766       213.33
     630.783     0.996094       122857       256.00
     632.319     0.996484       122900       284.44
     633.855     0.996875       122951       320.00
     635.903     0.997266       123007       365.71
     637.439     0.997656       123047       426.67
     639.487     0.998047       123098       512.00
     640.511     0.998242       123125       568.89
     641.535     0.998437       123146       640.00
     642.559     0.998633       123167       731.43
     643.583     0.998828       123195       853.33
     644.607     0.999023       123215      1024.00
     646.143     0.999121       123234      1137.78
     646.655     0.999219       123240      1280.00
     647.679     0.999316       123251      1462.86
     648.703     0.999414       123265      1706.67
     650.239     0.999512       123277      2048.00
     650.751     0.999561       123280      2275.56
     651.775     0.999609       123288      2560.00
     652.287     0.999658       123291      2925.71
     653.823     0.999707       123297      3413.33
     655.871     0.999756       123304      4096.00
     656.895     0.999780       123306      4551.11
     658.431     0.999805       123309      5120.00
     659.455     0.999829       123312      5851.43
     660.991     0.999854       123315      6826.67
     663.551     0.999878       123318      8192.00
     665.599     0.999890       123320      9102.22
     666.111     0.999902       123321     10240.00
     667.135     0.999915       123323     11702.86
     668.159     0.999927       123324     13653.33
     669.183     0.999939       123326     16384.00
     672.255     0.999945       123327     18204.44
     672.255     0.999951       123327     20480.00
     672.767     0.999957       123328     23405.71
     674.815     0.999963       123329     27306.67
     677.887     0.999969       123330     32768.00
     677.887     0.999973       123330     36408.89
     677.887     0.999976       123330     40960.00
     679.423     0.999979       123331     46811.43
     679.423     0.999982       123331     54613.33
     680.959     0.999985       123332     65536.00
     680.959     0.999986       123332     72817.78
     680.959     0.999988       123332     81920.00
     680.959     0.999989       123332     93622.86
     680.959     0.999991       123332    109226.67
     681.983     0.999992       123333    131072.00
     681.983     1.000000       123333          inf
     
    [Mean    =       54.684, StdDeviation   =      135.810]
    [Max     =      681.472, Total count    =       123333]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  148325 requests in 1.00m, 10.42MB read
  
    Requests/sec:   2472.06
    Transfer/sec:    177.78KB


#### Результаты профилирования async-profiler (CPU): 
![Результаты профилирования async-profiler (CPU)](profilingResults/cpu_get_hw3.svg)

Анализ:
 - DAO.get занимает - 98.44%
 - DAO.iterator занимает 97.13%
 - Merge различных iterator'ов занимает - 12.82%
 - 82.86% CPU тратится на то, чтобы бинарным поиском найти место в файле,
 с которого нужно читать, из которых 50.09% - это само чтение из файла

#### Результаты профилирования предыдущего этапа async-profiler (CPU): 
![Результаты профилирования async-profiler (CPU)](profilingResults/cpu_get_hw2.svg)

Анализ:
 - DAO.get занимает - 97.55%
 - DAO.iterator занимает 95.14%
 - Merge различных iterator'ов занимает - 13.18%
 - 81.19% CPU тратится на то, чтобы бинарным поиском найти место в файле,
 с которого нужно читать, из которых 50.09% - это само чтение из файла

Видим, что картина происходящего фактически не изменилась. Единственное, что отличается, это
место исполнение DAO.get. В нынешней версии обработка происходит в выделенном пуле потоков, в то
время как в предущем этапе обработка происходила в обработчике http запроса.

#### Результаты профилирования async-profiler (ALLOC): 

`wrk2 -t4 -c64 -R2500 -d60s -s wrk/get.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 64 connections

      Thread calibration: mean lat.: 8.230ms, rate sampling interval: 59ms
      Thread calibration: mean lat.: 7.215ms, rate sampling interval: 57ms
      Thread calibration: mean lat.: 7.313ms, rate sampling interval: 57ms
      Thread calibration: mean lat.: 6.468ms, rate sampling interval: 55ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency    58.83ms  149.20ms 775.68ms   90.60%
        Req/Sec   620.79    106.34     0.93k    79.05%
  Latency Distribution (HdrHistogram - Recorded Latency)

     50.000%    3.27ms
     75.000%   30.59ms
     90.000%  177.28ms
     99.000%  705.02ms
     99.900%  752.13ms
     99.990%  771.58ms
     99.999%  775.68ms
    100.000%  776.19ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.051     0.000000            1         1.00
       0.636     0.100000        12293         1.11
       1.076     0.200000        24615         1.25
       2.083     0.300000        36887         1.43
       2.823     0.400000        49184         1.67
       3.271     0.500000        61503         2.00
       3.517     0.550000        67655         2.22
       3.823     0.600000        73791         2.50
       4.523     0.650000        79909         2.86
      18.175     0.700000        86049         3.33
      30.591     0.750000        92205         4.00
      35.775     0.775000        95272         4.44
      41.311     0.800000        98358         5.00
      46.879     0.825000       101422         5.71
      52.767     0.850000       104488         6.67
      60.543     0.875000       107559         8.00
     112.063     0.887500       109097         8.89
     177.279     0.900000       110632        10.00
     271.103     0.912500       112169        11.43
     346.367     0.925000       113710        13.33
     410.879     0.937500       115243        16.00
     441.343     0.943750       116011        17.78
     471.807     0.950000       116779        20.00
     499.199     0.956250       117549        22.86
     531.455     0.962500       118318        26.67
     561.151     0.968750       119086        32.00
     584.191     0.971875       119472        35.56
     614.399     0.975000       119853        40.00
     632.319     0.978125       120246        45.71
     650.239     0.981250       120624        53.33
     670.719     0.984375       121004        64.00
     680.959     0.985938       121198        71.11
     690.175     0.987500       121390        80.00
     699.903     0.989062       121585        91.43
     708.095     0.990625       121772       106.67
     716.287     0.992188       121970       128.00
     720.383     0.992969       122061       142.22
     724.479     0.993750       122160       160.00
     728.575     0.994531       122258       182.86
     732.159     0.995313       122348       213.33
     736.255     0.996094       122448       256.00
     738.303     0.996484       122500       284.44
     739.839     0.996875       122542       320.00
     741.375     0.997266       122593       365.71
     743.423     0.997656       122640       426.67
     745.471     0.998047       122684       512.00
     747.007     0.998242       122717       568.89
     747.519     0.998437       122732       640.00
     749.055     0.998633       122763       731.43
     750.591     0.998828       122787       853.33
     752.127     0.999023       122804      1024.00
     753.151     0.999121       122823      1137.78
     754.175     0.999219       122832      1280.00
     755.199     0.999316       122842      1462.86
     756.223     0.999414       122857      1706.67
     757.759     0.999512       122864      2048.00
     759.295     0.999561       122874      2275.56
     759.807     0.999609       122878      2560.00
     760.831     0.999658       122882      2925.71
     762.879     0.999707       122888      3413.33
     764.415     0.999756       122894      4096.00
     765.951     0.999780       122897      4551.11
     766.975     0.999805       122901      5120.00
     768.511     0.999829       122903      5851.43
     769.535     0.999854       122906      6826.67
     771.071     0.999878       122909      8192.00
     771.583     0.999890       122912      9102.22
     771.583     0.999902       122912     10240.00
     772.095     0.999915       122915     11702.86
     772.095     0.999927       122915     13653.33
     772.607     0.999939       122917     16384.00
     773.119     0.999945       122919     18204.44
     773.119     0.999951       122919     20480.00
     773.119     0.999957       122919     23405.71
     774.143     0.999963       122920     27306.67
     774.655     0.999969       122921     32768.00
     774.655     0.999973       122921     36408.89
     774.655     0.999976       122921     40960.00
     775.167     0.999979       122922     46811.43
     775.167     0.999982       122922     54613.33
     775.679     0.999985       122923     65536.00
     775.679     0.999986       122923     72817.78
     775.679     0.999988       122923     81920.00
     775.679     0.999989       122923     93622.86
     775.679     0.999991       122923    109226.67
     776.191     0.999992       122924    131072.00
     776.191     1.000000       122924          inf
     
    [Mean    =       58.830, StdDeviation   =      149.199]
    [Max     =      775.680, Total count    =       122924]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  148060 requests in 1.00m, 10.40MB read
  
    Requests/sec:   2467.68
    Transfer/sec:    177.46KB

#### Результаты профилирования async-profiler (ALLOC): 
![Результаты профилирования async-profiler (ALLOC)](profilingResults/alloc_get_hw3.svg)

Анализ:
 - HttpBuffer занимает - 17.79%
 - Merge Iterator и его Priority Queue занимают - 21.14%
 - AsyncService.get занимает - 2.01%
 - Лямбда из очереди ExecutorService - 77.50%
 - Dao.get занимает - 76.73%
 - SSTable.iterator - 49.78%, при этом в основном память выделяется под байтовый буфер для 
 текущего ключа в бинарном поиске, где 40.88% выделяется под сам ключ, а 8.33% на смещение
 до него 
 - Transformed.iterator - 3.98%

#### Результаты профилирования предыдущего этапа async-profiler (ALLOC): 
![Результаты профилирования async-profiler (ALLOC)](profilingResults/alloc_get_hw2.svg)

Анализ:
 - HttpBuffer занимает - 99.41%
 - Merge Iterator и его Priority Queue занимают - 24.58%
 - BasicService.get занимает - 97.76%
 - Dao.get занимает - 97.42%
 - SSTable.iterator - 63.64%, при этом в основном память выделяется под байтовый буфер для 
 текущего ключа в бинарном поиске, где 52.49% выделяется под сам ключ, а 10.53% на смещение
 до него 
 - Transformed.iterator - 7.09%
 
 Видим, что по сравнении с предыдущим этапом в целом выделение памяти осталось на том же уровне.
 Основным изменением являяется то, что аллокации были пересены в пулл отдельных потоков, а не как 
 раньше они выполнялись в контексте HttpBuffer'a.
 
 #### Результаты профилирования async-profiler (LOCK): 
 
 `wrk2 -t4 -c16 -R2000 -d60s -s wrk/get.lua --latency  http://localhost:8080`

Running 1m test @ http://localhost:8080
  4 threads and 64 connections

      Thread calibration: mean lat.: 4.296ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 4.958ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 3.787ms, rate sampling interval: 10ms
      Thread calibration: mean lat.: 3.684ms, rate sampling interval: 10ms
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     5.89ms   11.21ms  88.32ms   90.98%
        Req/Sec   658.74    123.58     1.33k    81.23%
  Latency Distribution (HdrHistogram - Recorded Latency)
  
     50.000%    3.01ms
     75.000%    3.77ms
     90.000%   10.65ms
     99.000%   54.97ms
     99.900%   77.95ms
     99.990%   83.97ms
     99.999%   86.40ms
    100.000%   88.38ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.046     0.000000            1         1.00
       0.591     0.100000        12487         1.11
       0.998     0.200000        24979         1.25
       1.734     0.300000        37441         1.43
       2.633     0.400000        49921         1.67
       3.009     0.500000        62471         2.00
       3.159     0.550000        68657         2.22
       3.305     0.600000        74902         2.50
       3.451     0.650000        81186         2.86
       3.601     0.700000        87424         3.33
       3.769     0.750000        93628         4.00
       3.865     0.775000        96734         4.44
       3.973     0.800000        99839         5.00
       4.115     0.825000       103014         5.71
       4.299     0.850000       106128         6.67
       4.647     0.875000       109196         8.00
       5.155     0.887500       110756         8.89
      10.647     0.900000       112315        10.00
      18.815     0.912500       113875        11.43
      24.991     0.925000       115434        13.33
      30.175     0.937500       116998        16.00
      32.655     0.943750       117774        17.78
      35.231     0.950000       118554        20.00
      37.791     0.956250       119338        22.86
      40.703     0.962500       120114        26.67
      43.775     0.968750       120898        32.00
      45.247     0.971875       121291        35.56
      46.751     0.975000       121677        40.00
      48.319     0.978125       122071        45.71
      50.015     0.981250       122460        53.33
      51.679     0.984375       122844        64.00
      52.607     0.985938       123040        71.11
      53.503     0.987500       123238        80.00
      54.399     0.989062       123433        91.43
      55.359     0.990625       123627       106.67
      56.543     0.992188       123819       128.00
      57.215     0.992969       123918       142.22
      57.983     0.993750       124015       160.00
      58.879     0.994531       124111       182.86
      60.223     0.995313       124209       213.33
      61.599     0.996094       124306       256.00
      62.719     0.996484       124355       284.44
      63.647     0.996875       124404       320.00
      65.087     0.997266       124452       365.71
      67.327     0.997656       124501       426.67
      70.527     0.998047       124550       512.00
      71.807     0.998242       124574       568.89
      73.663     0.998437       124599       640.00
      75.199     0.998633       124624       731.43
      76.799     0.998828       124648       853.33
      78.079     0.999023       124674      1024.00
      78.911     0.999121       124684      1137.78
      79.871     0.999219       124699      1280.00
      80.127     0.999316       124708      1462.86
      80.895     0.999414       124720      1706.67
      81.791     0.999512       124734      2048.00
      81.983     0.999561       124739      2275.56
      82.175     0.999609       124746      2560.00
      82.495     0.999658       124753      2925.71
      82.687     0.999707       124757      3413.33
      83.199     0.999756       124766      4096.00
      83.199     0.999780       124766      4551.11
      83.327     0.999805       124769      5120.00
      83.455     0.999829       124772      5851.43
      83.775     0.999854       124776      6826.67
      83.839     0.999878       124779      8192.00
      83.903     0.999890       124780      9102.22
      83.967     0.999902       124783     10240.00
      83.967     0.999915       124783     11702.86
      84.031     0.999927       124784     13653.33
      84.223     0.999939       124786     16384.00
      84.415     0.999945       124787     18204.44
      84.415     0.999951       124787     20480.00
      84.479     0.999957       124788     23405.71
      84.991     0.999963       124789     27306.67
      85.055     0.999969       124790     32768.00
      85.055     0.999973       124790     36408.89
      85.055     0.999976       124790     40960.00
      85.119     0.999979       124791     46811.43
      85.119     0.999982       124791     54613.33
      86.399     0.999985       124792     65536.00
      86.399     0.999986       124792     72817.78
      86.399     0.999988       124792     81920.00
      86.399     0.999989       124792     93622.86
      86.399     0.999991       124792    109226.67
      88.383     0.999992       124793    131072.00
      88.383     1.000000       124793          inf

    [Mean    =        5.887, StdDeviation   =       11.211]
    [Max     =       88.320, Total count    =       124793]
    [Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  149929 requests in 1.00m, 10.53MB read
  
    Requests/sec:   2498.86
    Transfer/sec:    179.71KB

#### Результаты профилирования async-profiler (LOCK): 
![Результаты профилирования async-profiler (LOCK)](profilingResults/lock_get_hw3.svg)

Анализ:
 - ReentrantLock - lock для cache в BasicService - 4.84%
 - 65.52% занимают блокировки файлов
 - MergeIterator - 9.88%, что также является блокировкой файлов
 - TransformedIterator - 1.73%, что также является блокировкой файлов
 - AsyncService.get(ThreadPoolExecutor.execute) - 4.32%
 
 Из анализа видно, что большую часть занимают блокировки в файлах.
 
#### Результаты профилирования предыдущего этапа с помощью async-profiler (LOCK): 
![Результаты профилирования async-profiler (LOCK)](profilingResults/lock_get_hw2.svg)

Анализ:
 - ReentrantLock - lock для cache в BasicService - 33.5%
 - 55.19% занимают блокировки файлов
 - MergeIterator - 8.3%, что также является блокировкой файлов
 - TransformedIterator - 2.51%, что также является блокировкой файлов
 
В сравнении с предыдущим этапом видим, что появилась блокировка при постановки задачи
в очередь ExecutorService'a. Остальные параметры остались на прежнем уровне.
 
