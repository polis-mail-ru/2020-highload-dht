# PUT
## wrk

Реализация без шардирования 

./wrk  -c64 -d3m -R2000 -s put.lua --latency http://127.0.0.1:8080
Running 3m test @ http://127.0.0.1:8080
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.15ms  612.25us  81.86ms   79.01%
    Req/Sec     1.05k    89.73     3.80k    82.72%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.13ms
 75.000%    1.48ms
 90.000%    1.79ms
 99.000%    2.20ms
 99.900%    2.47ms
 99.990%   22.16ms
 99.999%   55.65ms
100.000%   81.92ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.104     0.000000            1         1.00
       0.542     0.100000        34100         1.11
       0.683     0.200000        68068         1.25
       0.850     0.300000       101976         1.43
       0.997     0.400000       135894         1.67
       1.126     0.500000       169953         2.00
       1.188     0.550000       187041         2.22
       1.251     0.600000       203895         2.50
       1.321     0.650000       220991         2.86
       1.399     0.700000       237931         3.33
       1.477     0.750000       254818         4.00
       1.519     0.775000       263369         4.44
       1.563     0.800000       271890         5.00
       1.613     0.825000       280393         5.71
       1.670     0.850000       288832         6.67
       1.733     0.875000       297297         8.00
       1.764     0.887500       301521         8.89
       1.795     0.900000       305718        10.00
       1.828     0.912500       310052        11.43
       1.859     0.925000       314267        13.33
       1.891     0.937500       318464        16.00
       1.908     0.943750       320601        17.78
       1.925     0.950000       322702        20.00
       1.944     0.956250       324850        22.86
       1.966     0.962500       327017        26.67
       1.991     0.968750       329064        32.00
       2.007     0.971875       330132        35.56
       2.026     0.975000       331207        40.00
       2.049     0.978125       332269        45.71
       2.081     0.981250       333323        53.33
       2.119     0.984375       334372        64.00
       2.143     0.985938       334909        71.11
       2.167     0.987500       335440        80.00
       2.189     0.989062       335985        91.43
       2.215     0.990625       336529       106.67
       2.239     0.992188       337029       128.00
       2.255     0.992969       337308       142.22
       2.273     0.993750       337582       160.00
       2.293     0.994531       337858       182.86
       2.313     0.995313       338092       213.33
       2.339     0.996094       338381       256.00
       2.351     0.996484       338506       284.44
       2.363     0.996875       338619       320.00
       2.381     0.997266       338753       365.71
       2.399     0.997656       338896       426.67
       2.415     0.998047       339019       512.00
       2.425     0.998242       339090       568.89
       2.437     0.998437       339161       640.00
       2.447     0.998633       339226       731.43
       2.457     0.998828       339287       853.33
       2.471     0.999023       339359      1024.00
       2.477     0.999121       339387      1137.78
       2.485     0.999219       339414      1280.00
       2.501     0.999316       339452      1462.86
       2.515     0.999414       339483      1706.67
       2.543     0.999512       339513      2048.00
       2.701     0.999561       339529      2275.56
       3.569     0.999609       339546      2560.00
       4.703     0.999658       339562      2925.71
       7.855     0.999707       339579      3413.33
      10.759     0.999756       339596      4096.00
      12.471     0.999780       339604      4551.11
      14.503     0.999805       339612      5120.00
      16.495     0.999829       339620      5851.43
      18.527     0.999854       339629      6826.67
      20.063     0.999878       339637      8192.00
      21.807     0.999890       339641      9102.22
      22.191     0.999902       339645     10240.00
      23.503     0.999915       339649     11702.86
      25.839     0.999927       339654     13653.33
      27.039     0.999939       339658     16384.00
      28.431     0.999945       339660     18204.44
      29.167     0.999951       339662     20480.00
      29.695     0.999957       339664     23405.71
      30.991     0.999963       339666     27306.67
      31.711     0.999969       339668     32768.00
      32.015     0.999973       339669     36408.89
      32.671     0.999976       339670     40960.00
      33.119     0.999979       339671     46811.43
      33.919     0.999982       339672     54613.33
      50.111     0.999985       339673     65536.00
      55.007     0.999986       339674     72817.78
      55.007     0.999988       339674     81920.00
      55.647     0.999989       339675     93622.86
      55.647     0.999991       339675    109226.67
      61.183     0.999992       339676    131072.00
      61.183     0.999993       339676    145635.56
      61.183     0.999994       339676    163840.00
      65.599     0.999995       339677    187245.71
      65.599     0.999995       339677    218453.33
      65.599     0.999996       339677    262144.00
      65.599     0.999997       339677    291271.11
      65.599     0.999997       339677    327680.00
      81.919     0.999997       339678    374491.43
      81.919     1.000000       339678          inf
[Mean    =        1.151, StdDeviation   =        0.612]
[Max     =       81.856, Total count    =       339678]
[Buckets =           27, SubBuckets     =         2048]
  359874 requests in 3.00m, 22.99MB read
Requests/sec:   1999.30
Transfer/sec:    130.81KB

Реализация c шардированием

 ./wrk  -c64 -d3m -R2000 -s put.lua --latency http://127.0.0.1:8081
Running 3m test @ http://127.0.0.1:8081
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.85ms   55.40ms   1.51s    99.62%
    Req/Sec     1.05k     1.12k   42.60k    85.27%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.75ms
 75.000%    2.23ms
 90.000%    2.77ms
 99.000%    4.06ms
 99.900%    1.14s 
 99.990%    1.48s 
 99.999%    1.51s 
100.000%    1.51s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.108     0.000000            1         1.00
       0.900     0.100000        34040         1.11
       1.156     0.200000        67961         1.25
       1.364     0.300000       101946         1.43
       1.559     0.400000       135952         1.67
       1.748     0.500000       170010         2.00
       1.840     0.550000       186949         2.22
       1.929     0.600000       203809         2.50
       2.024     0.650000       220981         2.86
       2.121     0.700000       237850         3.33
       2.229     0.750000       254793         4.00
       2.289     0.775000       263245         4.44
       2.355     0.800000       271896         5.00
       2.427     0.825000       280246         5.71
       2.509     0.850000       288725         6.67
       2.617     0.875000       297216         8.00
       2.685     0.887500       301481         8.89
       2.765     0.900000       305779        10.00
       2.859     0.912500       310021        11.43
       2.963     0.925000       314229        13.33
       3.089     0.937500       318461        16.00
       3.161     0.943750       320574        17.78
       3.239     0.950000       322707        20.00
       3.325     0.956250       324839        22.86
       3.425     0.962500       326971        26.67
       3.529     0.968750       329058        32.00
       3.587     0.971875       330134        35.56
       3.649     0.975000       331188        40.00
       3.717     0.978125       332260        45.71
       3.795     0.981250       333336        53.33
       3.875     0.984375       334374        64.00
       3.921     0.985938       334902        71.11
       3.969     0.987500       335425        80.00
       4.025     0.989062       335958        91.43
       4.093     0.990625       336487       106.67
       4.203     0.992188       337030       128.00
       4.295     0.992969       337280       142.22
       4.567     0.993750       337543       160.00
       8.655     0.994531       337808       182.86
      12.503     0.995313       338073       213.33
      29.295     0.996094       338339       256.00
     185.855     0.996484       338471       284.44
     341.503     0.996875       338604       320.00
     477.695     0.997266       338738       365.71
     630.271     0.997656       338869       426.67
     786.943     0.998047       339004       512.00
     854.527     0.998242       339068       568.89
     944.639     0.998437       339138       640.00
    1008.127     0.998633       339202       731.43
    1072.127     0.998828       339269       853.33
    1142.783     0.999023       339336      1024.00
    1179.647     0.999121       339367      1137.78
    1229.823     0.999219       339403      1280.00
    1262.591     0.999316       339438      1462.86
    1294.335     0.999414       339469      1706.67
    1330.175     0.999512       339500      2048.00
    1356.799     0.999561       339522      2275.56
    1364.991     0.999609       339535      2560.00
    1388.543     0.999658       339553      2925.71
    1419.263     0.999707       339572      3413.33
    1420.287     0.999756       339583      4096.00
    1428.479     0.999780       339591      4551.11
    1451.007     0.999805       339603      5120.00
    1452.031     0.999829       339611      5851.43
    1456.127     0.999854       339616      6826.67
    1482.751     0.999878       339638      8192.00
    1482.751     0.999890       339638      9102.22
    1482.751     0.999902       339638     10240.00
    1482.751     0.999915       339638     11702.86
    1485.823     0.999927       339641     13653.33
    1488.895     0.999939       339645     16384.00
    1491.967     0.999945       339647     18204.44
    1513.471     0.999951       339650     20480.00
    1514.495     0.999957       339665     23405.71
    1514.495     1.000000       339665          inf
[Mean    =        4.853, StdDeviation   =       55.402]
[Max     =     1513.472, Total count    =       339665]
[Buckets =           27, SubBuckets     =         2048]
  358958 requests in 3.00m, 31.13MB read
Requests/sec:   1994.10
Transfer/sec:    177.09KB

Меньше запросов в секунду обработала реализация с шардированием ,  50 % запросов обработано в 1,5 раза медленнее , около 0,1 % запросов на порядок медленнее, заняло уже секунды, что было ожидаемо, т.к. теперь время еще тратиться на проксирование.

## CPU
Реализация без шардирования
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/old%20ver/put/cpu.svg)

Реализация c шардированием
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/with%20sharding/put/cpu.svg)

Как и ожидалось на вставку в реализации с шардированием распределно больше ресурсов CPU ( на 10% примерно) , из которых 20 % уходит на proxy 

## ALLOC
Реализация без шардирования
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/old%20ver/put/alloc.svg)

Реализация c шардированием
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/with%20sharding/put/alloc.svg)

Тут достаточно большие разлилчия , в реализации без шардирования большая часть ( около 60 % ) шла на нужды селекторов ( обработка запросов ) , в новой же реализации на селекторы распределено ресурсов только около 30 %, это связано с тем, что теперь большая часть ресурсов, около 50% идет на проксирование 

## LOCK 
Реализация без шардирования
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/old%20ver/put/lock.svg)

Реализация c шардированием
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/with%20sharding/put/lock.svg)


Воркеры из ArrayBlockingQueue работают под локами , селекторы занимаются своей работой. В реализации с шардированием добавились новые локи , относящиеяся к проксированию.

# Get
## wrk

Реализация без шардирования
./wrk  -c64 -d3m -R2000 -s get.lua --latency http://127.0.0.1:8080
Running 3m test @ http://127.0.0.1:8080
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.62ms  739.86us  12.38ms   64.89%
    Req/Sec     1.05k     1.06k    3.56k    84.50%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.59ms
 75.000%    2.13ms
 90.000%    2.65ms
 99.000%    3.34ms
 99.900%    3.83ms
 99.990%    5.51ms
 99.999%   11.43ms
100.000%   12.39ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.097     0.000000            1         1.00
       0.653     0.100000        34053         1.11
       0.927     0.200000        67978         1.25
       1.143     0.300000       102061         1.43
       1.353     0.400000       135912         1.67
       1.589     0.500000       169878         2.00
       1.692     0.550000       186842         2.22
       1.791     0.600000       203824         2.50
       1.895     0.650000       220873         2.86
       2.010     0.700000       237787         3.33
       2.129     0.750000       254863         4.00
       2.195     0.775000       263313         4.44
       2.265     0.800000       271945         5.00
       2.339     0.825000       280236         5.71
       2.425     0.850000       288779         6.67
       2.531     0.875000       297250         8.00
       2.591     0.887500       301522         8.89
       2.653     0.900000       305766        10.00
       2.721     0.912500       310030        11.43
       2.791     0.925000       314203        13.33
       2.865     0.937500       318482        16.00
       2.903     0.943750       320655        17.78
       2.943     0.950000       322787        20.00
       2.983     0.956250       324859        22.86
       3.027     0.962500       326997        26.67
       3.077     0.968750       329131        32.00
       3.101     0.971875       330144        35.56
       3.131     0.975000       331189        40.00
       3.163     0.978125       332243        45.71
       3.201     0.981250       333327        53.33
       3.241     0.984375       334363        64.00
       3.267     0.985938       334921        71.11
       3.293     0.987500       335456        80.00
       3.321     0.989062       335958        91.43
       3.355     0.990625       336491       106.67
       3.393     0.992188       337016       128.00
       3.413     0.992969       337277       142.22
       3.437     0.993750       337557       160.00
       3.465     0.994531       337807       182.86
       3.495     0.995313       338074       213.33
       3.529     0.996094       338346       256.00
       3.549     0.996484       338481       284.44
       3.569     0.996875       338604       320.00
       3.595     0.997266       338741       365.71
       3.625     0.997656       338872       426.67
       3.661     0.998047       339001       512.00
       3.683     0.998242       339076       568.89
       3.705     0.998437       339133       640.00
       3.743     0.998633       339201       731.43
       3.779     0.998828       339266       853.33
       3.835     0.999023       339333      1024.00
       3.863     0.999121       339365      1137.78
       3.899     0.999219       339398      1280.00
       3.927     0.999316       339431      1462.86
       3.977     0.999414       339466      1706.67
       4.029     0.999512       339498      2048.00
       4.075     0.999561       339514      2275.56
       4.123     0.999609       339531      2560.00
       4.215     0.999658       339548      2925.71
       4.315     0.999707       339565      3413.33
       4.475     0.999756       339581      4096.00
       4.531     0.999780       339589      4551.11
       4.655     0.999805       339597      5120.00
       4.991     0.999829       339605      5851.43
       5.207     0.999854       339614      6826.67
       5.303     0.999878       339622      8192.00
       5.459     0.999890       339626      9102.22
       5.535     0.999902       339630     10240.00
       5.659     0.999915       339634     11702.86
       5.923     0.999927       339639     13653.33
       6.303     0.999939       339643     16384.00
       6.919     0.999945       339645     18204.44
       7.739     0.999951       339647     20480.00
       8.175     0.999957       339649     23405.71
       8.807     0.999963       339651     27306.67
       9.735     0.999969       339653     32768.00
       9.775     0.999973       339654     36408.89
       9.783     0.999976       339655     40960.00
      10.935     0.999979       339656     46811.43
      10.967     0.999982       339657     54613.33
      11.231     0.999985       339658     65536.00
      11.351     0.999986       339659     72817.78
      11.351     0.999988       339659     81920.00
      11.431     0.999989       339660     93622.86
      11.431     0.999991       339660    109226.67
      11.959     0.999992       339661    131072.00
      11.959     0.999993       339661    145635.56
      11.959     0.999994       339661    163840.00
      12.063     0.999995       339662    187245.71
      12.063     0.999995       339662    218453.33
      12.063     0.999996       339662    262144.00
      12.063     0.999997       339662    291271.11
      12.063     0.999997       339662    327680.00
      12.391     0.999997       339663    374491.43
      12.391     1.000000       339663          inf
[Mean    =        1.621, StdDeviation   =        0.740]
[Max     =       12.384, Total count    =       339663]
[Buckets =           27, SubBuckets     =         2048]

  358967 requests in 3.00m, 25.10MB read
Requests/sec:   1994.14
Transfer/sec:    142.80KB

Реализация с шардированием

./wrk  -c64 -d3m -R2000 -s get.lua --latency http://127.0.0.1:8081
Running 3m test @ http://127.0.0.1:8081
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.93ms    3.37ms  53.70ms   95.28%
    Req/Sec     1.05k     0.90k    3.80k    60.39%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.10ms
 75.000%    3.32ms
 90.000%    5.14ms
 99.000%   21.20ms
 99.900%   36.42ms
 99.990%   45.06ms
 99.999%   49.06ms
100.000%   53.73ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.189     0.000000            1         1.00
       1.044     0.100000        34022         1.11
       1.348     0.200000        68016         1.25
       1.595     0.300000       101994         1.43
       1.836     0.400000       135988         1.67
       2.101     0.500000       169931         2.00
       2.253     0.550000       186966         2.22
       2.425     0.600000       203804         2.50
       2.641     0.650000       220797         2.86
       2.937     0.700000       237807         3.33
       3.323     0.750000       254749         4.00
       3.551     0.775000       263256         4.44
       3.805     0.800000       271757         5.00
       4.093     0.825000       280231         5.71
       4.411     0.850000       288742         6.67
       4.759     0.875000       297293         8.00
       4.939     0.887500       301452         8.89
       5.139     0.900000       305756        10.00
       5.343     0.912500       309973        11.43
       5.575     0.925000       314228        13.33
       5.843     0.937500       318469        16.00
       6.003     0.943750       320569        17.78
       6.211     0.950000       322703        20.00
       6.455     0.956250       324827        22.86
       6.787     0.962500       326936        26.67
       7.315     0.968750       329052        32.00
       7.743     0.971875       330113        35.56
       8.527     0.975000       331183        40.00
       9.847     0.978125       332235        45.71
      11.791     0.981250       333297        53.33
      14.583     0.984375       334361        64.00
      16.143     0.985938       334890        71.11
      18.095     0.987500       335419        80.00
      19.999     0.989062       335949        91.43
      22.175     0.990625       336482       106.67
      24.399     0.992188       337013       128.00
      25.631     0.992969       337275       142.22
      26.767     0.993750       337546       160.00
      27.871     0.994531       337806       182.86
      28.991     0.995313       338072       213.33
      30.063     0.996094       338338       256.00
      30.703     0.996484       338471       284.44
      31.231     0.996875       338604       320.00
      31.935     0.997266       338735       365.71
      32.687     0.997656       338867       426.67
      33.503     0.998047       339000       512.00
      33.887     0.998242       339066       568.89
      34.527     0.998437       339133       640.00
      35.103     0.998633       339202       731.43
      35.679     0.998828       339265       853.33
      36.511     0.999023       339332      1024.00
      36.959     0.999121       339365      1137.78
      37.247     0.999219       339399      1280.00
      37.983     0.999316       339432      1462.86
      38.463     0.999414       339464      1706.67
      39.391     0.999512       339498      2048.00
      39.839     0.999561       339515      2275.56
      40.319     0.999609       339532      2560.00
      40.735     0.999658       339547      2925.71
      41.343     0.999707       339564      3413.33
      42.271     0.999756       339582      4096.00
      42.559     0.999780       339589      4551.11
      42.943     0.999805       339598      5120.00
      43.231     0.999829       339605      5851.43
      43.615     0.999854       339614      6826.67
      44.383     0.999878       339622      8192.00
      44.831     0.999890       339626      9102.22
      45.055     0.999902       339630     10240.00
      45.279     0.999915       339635     11702.86
      45.439     0.999927       339639     13653.33
      45.727     0.999939       339643     16384.00
      45.791     0.999945       339645     18204.44
      46.175     0.999951       339647     20480.00
      46.207     0.999957       339649     23405.71
      46.431     0.999963       339652     27306.67
      46.495     0.999969       339653     32768.00
      46.783     0.999973       339654     36408.89
      46.815     0.999976       339655     40960.00
      46.879     0.999979       339656     46811.43
      47.423     0.999982       339657     54613.33
      47.999     0.999985       339658     65536.00
      48.063     0.999986       339659     72817.78
      48.063     0.999988       339659     81920.00
      49.055     0.999989       339660     93622.86
      49.055     0.999991       339660    109226.67
      50.559     0.999992       339661    131072.00
      50.559     0.999993       339661    145635.56
      50.559     0.999994       339661    163840.00
      52.959     0.999995       339662    187245.71
      52.959     0.999995       339662    218453.33
      52.959     0.999996       339662    262144.00
      52.959     0.999997       339662    291271.11
      52.959     0.999997       339662    327680.00
      53.727     0.999997       339663    374491.43
      53.727     1.000000       339663          inf
[Mean    =        2.933, StdDeviation   =        3.371]
[Max     =       53.696, Total count    =       339663]
[Buckets =           27, SubBuckets     =         2048]
  358946 requests in 3.00m, 33.18MB read
Requests/sec:   1994.03
Transfer/sec:    188.75KB

50 % в 1,5 раза медленнее , среднее в 2 раза хуже.

## CPU
Реализация без шардирования
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/old%20ver/get/cpu.svg)

Реализация c шардированием
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/with%20sharding/get/cpu.svg)

Ситуация похожа на ситуацию с put, большую часть занимает проксирование (около 54 %). Из-за этого наблюдается снижение производительности, что ожидаемо. 

## ALLOC
Реализация без шардирования
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/old%20ver/get/alloc.svg)

Реализация c шардированием
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/with%20sharding/get/alloc.svg)

Ситуация похожа на ситуацию с put, операция проксирования оказалась дорогостоящей и в ресурсах процессора и в памяти , 47% ресурсов распределено на нее. 

## LOCK 
Реализация без шардирования
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/old%20ver/get/lock.svg)

Реализация c шардированием
![image](https://github.com/re1nex/2020-highload-dht/blob/hw4/profile_info/with%20sharding/get/lock.svg)


аналогично put 