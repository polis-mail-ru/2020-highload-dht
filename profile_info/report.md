# PUT
## wrk

Старая реализация

```
./wrk -t64  -c64 -d5m -R2000 -s put.lua --latency http://127.0.0.1:8081
Running 5m test @ http://127.0.0.1:8081
  64 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.57ms  266.78ms  10.10s    99.80%
    Req/Sec    14.91     37.80     4.33k    85.62%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.02ms
 75.000%    2.33ms
 90.000%    2.60ms
 99.000%    3.66ms
 99.900%    5.26s 
 99.990%    9.66s 
 99.999%   10.05s 
100.000%   10.11s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.199     0.000000            1         1.00
       1.427     0.100000        15464         1.11
       1.630     0.200000        30908         1.25
       1.778     0.300000        46359         1.43
       1.906     0.400000        61773         1.67
       2.024     0.500000        77293         2.00
       2.081     0.550000        84966         2.22
       2.139     0.600000        92693         2.50
       2.199     0.650000       100547         2.86
       2.259     0.700000       108087         3.33
       2.327     0.750000       115997         4.00
       2.361     0.775000       119744         4.44
       2.399     0.800000       123594         5.00
       2.441     0.825000       127514         5.71
       2.485     0.850000       131292         6.67
       2.535     0.875000       135151         8.00
       2.563     0.887500       137029         8.89
       2.595     0.900000       139035        10.00
       2.627     0.912500       140861        11.43
       2.667     0.925000       142843        13.33
       2.711     0.937500       144726        16.00
       2.739     0.943750       145731        17.78
       2.769     0.950000       146706        20.00
       2.805     0.956250       147621        22.86
       2.847     0.962500       148596        26.67
       2.899     0.968750       149560        32.00
       2.933     0.971875       150058        35.56
       2.969     0.975000       150519        40.00
       3.029     0.978125       150996        45.71
       3.103     0.981250       151480        53.33
       3.215     0.984375       151960        64.00
       3.291     0.985938       152204        71.11
       3.407     0.987500       152438        80.00
       3.543     0.989062       152683        91.43
       3.755     0.990625       152921       106.67
       4.143     0.992188       153165       128.00
       4.379     0.992969       153283       142.22
       4.691     0.993750       153403       160.00
       5.143     0.994531       153523       182.86
       5.899     0.995313       153644       213.33
       7.215     0.996094       153766       256.00
       7.767     0.996484       153825       284.44
       8.391     0.996875       153886       320.00
       9.895     0.997266       153945       365.71
      11.919     0.997656       154006       426.67
     595.455     0.998047       154066       512.00
    1547.263     0.998242       154096       568.89
    2500.607     0.998437       154126       640.00
    3450.879     0.998633       154156       731.43
    4435.967     0.998828       154187       853.33
    5386.239     0.999023       154217      1024.00
    5865.471     0.999121       154232      1137.78
    6340.607     0.999219       154247      1280.00
    6815.743     0.999316       154262      1462.86
    7290.879     0.999414       154277      1706.67
    7766.015     0.999512       154292      2048.00
    8019.967     0.999561       154300      2275.56
    8241.151     0.999609       154307      2560.00
    8495.103     0.999658       154315      2925.71
    8716.287     0.999707       154322      3413.33
    8970.239     0.999756       154330      4096.00
    9093.119     0.999780       154334      4551.11
    9191.423     0.999805       154337      5120.00
    9314.303     0.999829       154341      5851.43
    9437.183     0.999854       154345      6826.67
    9568.255     0.999878       154349      8192.00
    9625.599     0.999890       154351      9102.22
    9658.367     0.999902       154352     10240.00
    9723.903     0.999915       154354     11702.86
    9781.247     0.999927       154356     13653.33
    9846.783     0.999939       154358     16384.00
    9871.359     0.999945       154359     18204.44
    9904.127     0.999951       154360     20480.00
    9936.895     0.999957       154361     23405.71
    9961.471     0.999963       154362     27306.67
    9994.239     0.999969       154363     32768.00
    9994.239     0.999973       154363     36408.89
   10027.007     0.999976       154364     40960.00
   10027.007     0.999979       154364     46811.43
   10051.583     0.999982       154365     54613.33
   10051.583     0.999985       154365     65536.00
   10051.583     0.999986       154365     72817.78
   10084.351     0.999988       154366     81920.00
   10084.351     0.999989       154366     93622.86
   10084.351     0.999991       154366    109226.67
   10084.351     0.999992       154366    131072.00
   10084.351     0.999993       154366    145635.56
   10108.927     0.999994       154367    163840.00
   10108.927     1.000000       154367          inf
[Mean    =       12.570, StdDeviation   =      266.779]
[Max     =    10100.736, Total count    =       154367]
[Buckets =           27, SubBuckets     =         2048]

Requests/sec:    532.01
Transfer/sec:     34.81KB



```

Асинхронная реализация

```
/wrk -t64  -c64 -d5m -R2000 -s put.lua --latency http://127.0.0.1:8081
Running 5m test @ http://127.0.0.1:8081
  64 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.97ms  691.47us  16.02ms   77.63%
    Req/Sec    13.75     35.29   111.00     86.78%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.00ms
 75.000%    2.34ms
 90.000%    2.62ms
 99.000%    3.64ms
 99.900%    8.32ms
 99.990%   14.30ms
 99.999%   15.46ms
100.000%   16.03ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.223     0.000000            1         1.00
       1.138     0.100000        10885         1.11
       1.457     0.200000        21752         1.25
       1.685     0.300000        32632         1.43
       1.854     0.400000        43535         1.67
       1.997     0.500000        54445         2.00
       2.065     0.550000        59846         2.22
       2.131     0.600000        65267         2.50
       2.197     0.650000        70734         2.86
       2.267     0.700000        76225         3.33
       2.337     0.750000        81559         4.00
       2.377     0.775000        84409         4.44
       2.415     0.800000        87009         5.00
       2.461     0.825000        89773         5.71
       2.507     0.850000        92532         6.67
       2.559     0.875000        95219         8.00
       2.587     0.887500        96519         8.89
       2.619     0.900000        97878        10.00
       2.659     0.912500        99243        11.43
       2.705     0.925000       100634        13.33
       2.759     0.937500       101986        16.00
       2.793     0.943750       102640        17.78
       2.835     0.950000       103317        20.00
       2.887     0.956250       104000        22.86
       2.955     0.962500       104676        26.67
       3.043     0.968750       105346        32.00
       3.091     0.971875       105699        35.56
       3.153     0.975000       106028        40.00
       3.229     0.978125       106368        45.71
       3.311     0.981250       106706        53.33
       3.409     0.984375       107049        64.00
       3.465     0.985938       107215        71.11
       3.531     0.987500       107390        80.00
       3.603     0.989062       107560        91.43
       3.691     0.990625       107725       106.67
       3.809     0.992188       107895       128.00
       3.869     0.992969       107983       142.22
       3.941     0.993750       108065       160.00
       4.041     0.994531       108150       182.86
       4.187     0.995313       108237       213.33
       4.411     0.996094       108321       256.00
       4.603     0.996484       108363       284.44
       4.795     0.996875       108405       320.00
       5.107     0.997266       108447       365.71
       5.503     0.997656       108491       426.67
       5.903     0.998047       108533       512.00
       6.131     0.998242       108554       568.89
       6.523     0.998437       108576       640.00
       7.115     0.998633       108596       731.43
       7.743     0.998828       108617       853.33
       8.359     0.999023       108638      1024.00
       8.751     0.999121       108649      1137.78
       9.143     0.999219       108660      1280.00
       9.735     0.999316       108670      1462.86
      10.695     0.999414       108681      1706.67
      10.975     0.999512       108691      2048.00
      11.247     0.999561       108697      2275.56
      11.535     0.999609       108702      2560.00
      11.975     0.999658       108707      2925.71
      12.791     0.999707       108713      3413.33
      13.151     0.999756       108718      4096.00
      13.231     0.999780       108721      4551.11
      13.287     0.999805       108723      5120.00
      13.631     0.999829       108726      5851.43
      14.039     0.999854       108729      6826.67
      14.239     0.999878       108731      8192.00
      14.295     0.999890       108733      9102.22
      14.311     0.999902       108734     10240.00
      14.423     0.999915       108735     11702.86
      14.543     0.999927       108737     13653.33
      14.631     0.999939       108738     16384.00
      14.791     0.999945       108739     18204.44
      14.791     0.999951       108739     20480.00
      14.847     0.999957       108740     23405.71
      15.063     0.999963       108741     27306.67
      15.063     0.999969       108741     32768.00
      15.343     0.999973       108742     36408.89
      15.343     0.999976       108742     40960.00
      15.343     0.999979       108742     46811.43
      15.463     0.999982       108743     54613.33
      15.463     0.999985       108743     65536.00
      15.463     0.999986       108743     72817.78
      15.463     0.999988       108743     81920.00
      15.463     0.999989       108743     93622.86
      16.031     0.999991       108744    109226.67
      16.031     1.000000       108744          inf
[Mean    =        1.969, StdDeviation   =        0.691]
[Max     =       16.024, Total count    =       108744]
[Buckets =           27, SubBuckets     =         2048]

Requests/sec:    376.01
Transfer/sec:     24.61KB

```

Средние показатели близки друг к другу, возможно это связано, с накладными расхадами, связанными с дополнительными перемещениями данных между потоками и конвертацией, в новой реализации,  на результатх профилирования видны ForkJoinThreads , которые только перенаправляют потоки.
Но на >99 % новая реализация на несколько порядков обгоняет старую, возможно в этот момент очередь и переполнилась и старая реализация замедлилиась.

## CPU
Старая реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/old%20ver/put/cpu.svg)

Асинхронная реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/async/put/cpu.svg)

Количество сэмплов селекторов one.nio уменьшилось до 8%, т.к. теперь еще добавились селекторы HttpClient (10%) . 2% ушло на ForkJoinWorkerThread, внутри которого просто перенаправляются потоки Completablefuture. На пул экзекьютерова распределено на 5% больше сэмплов, внутри теперь идет распределение на Completablefuture (18%). getTask(26%) , 18% на сетевое взаимодействие нового клиента и всего 8% на разборы запросов ( родительский запрос или локальный, нахождение реплик и т.д.), что существенно отличается от предыдущего этапа.

## ALLOC
Старая реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/old%20ver/put/alloc.svg)

Асинхронная реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/async/put/alloc.svg)

По аллокациям на селекторы уходит на 13% больше,  еще 2% уходит на менеджер селекторов нового клиента, появились новые сэмплы Completablefuture(27%), сэмплов самого сервиса всего 25%.

Старая реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/old%20ver/put/heap.png)

Асинхронная реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/async/put/heap.png)

В целом количество памяти потребляемого сервисами не сильно отличается

## LOCK 
Старая реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/old%20ver/put/lock.svg)

Асинхронная реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/async/put/lock.svg)


Тут тоже достаточно координально все поменялось , количество локов селекторов one.nio сократилось до 1%, SelectorManager нового клиента занял 30%, getTask теперь занимает всего 8% , основные расходы на CompatableFuture (29%) и на новый клиент (30%).

# Get
## wrk

Старая реализация
```
./wrk -t64  -c64 -d5m -R2000 -s get.lua --latency http://127.0.0.1:8081
Running 5m test @ http://127.0.0.1:8081
  64 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.19ms    4.51ms 123.84ms   92.60%
    Req/Sec    32.35     39.32   500.00     84.50%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    3.21ms
 75.000%    5.69ms
 90.000%    7.98ms
 99.000%   23.44ms
 99.900%   48.77ms
 99.990%   71.29ms
 99.999%   91.33ms
100.000%  123.90ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.089     0.000000            1         1.00
       0.910     0.100000        58124         1.11
       1.205     0.200000       116060         1.25
       1.488     0.300000       174042         1.43
       2.165     0.400000       232035         1.67
       3.207     0.500000       290076         2.00
       3.657     0.550000       319054         2.22
       4.103     0.600000       348077         2.50
       4.567     0.650000       377074         2.86
       5.087     0.700000       406081         3.33
       5.687     0.750000       435007         4.00
       6.011     0.775000       449591         4.44
       6.343     0.800000       464032         5.00
       6.691     0.825000       478559         5.71
       7.063     0.850000       493087         6.67
       7.479     0.875000       507531         8.00
       7.719     0.887500       514816         8.89
       7.983     0.900000       522024        10.00
       8.287     0.912500       529232        11.43
       8.671     0.925000       536494        13.33
       9.183     0.937500       543781        16.00
       9.495     0.943750       547418        17.78
       9.879     0.950000       551027        20.00
      10.367     0.956250       554631        22.86
      11.039     0.962500       558256        26.67
      12.031     0.968750       561867        32.00
      12.711     0.971875       563676        35.56
      13.687     0.975000       565469        40.00
      14.975     0.978125       567291        45.71
      16.639     0.981250       569096        53.33
      18.655     0.984375       570917        64.00
      19.791     0.985938       571821        71.11
      21.087     0.987500       572727        80.00
      22.495     0.989062       573634        91.43
      24.047     0.990625       574535       106.67
      25.919     0.992188       575441       128.00
      26.991     0.992969       575896       142.22
      28.207     0.993750       576347       160.00
      29.551     0.994531       576802       182.86
      31.279     0.995313       577253       213.33
      33.439     0.996094       577705       256.00
      34.815     0.996484       577937       284.44
      36.159     0.996875       578156       320.00
      37.759     0.997266       578386       365.71
      39.615     0.997656       578612       426.67
      41.631     0.998047       578840       512.00
      42.719     0.998242       578951       568.89
      43.935     0.998437       579062       640.00
      45.343     0.998633       579176       731.43
      47.263     0.998828       579289       853.33
      49.215     0.999023       579407      1024.00
      50.399     0.999121       579460      1137.78
      51.519     0.999219       579515      1280.00
      52.831     0.999316       579573      1462.86
      54.495     0.999414       579629      1706.67
      56.095     0.999512       579685      2048.00
      56.991     0.999561       579715      2275.56
      58.015     0.999609       579742      2560.00
      59.199     0.999658       579770      2925.71
      60.639     0.999707       579800      3413.33
      62.175     0.999756       579827      4096.00
      63.071     0.999780       579841      4551.11
      64.479     0.999805       579855      5120.00
      65.311     0.999829       579870      5851.43
      66.879     0.999854       579885      6826.67
      69.375     0.999878       579898      8192.00
      70.847     0.999890       579905      9102.22
      71.423     0.999902       579912     10240.00
      72.255     0.999915       579919     11702.86
      73.279     0.999927       579926     13653.33
      74.047     0.999939       579933     16384.00
      75.263     0.999945       579938     18204.44
      75.647     0.999951       579940     20480.00
      76.991     0.999957       579944     23405.71
      78.207     0.999963       579947     27306.67
      80.767     0.999969       579951     32768.00
      83.327     0.999973       579953     36408.89
      83.583     0.999976       579954     40960.00
      84.863     0.999979       579956     46811.43
      86.527     0.999982       579958     54613.33
      87.551     0.999985       579960     65536.00
      88.575     0.999986       579961     72817.78
      88.575     0.999988       579961     81920.00
      91.327     0.999989       579962     93622.86
      92.607     0.999991       579963    109226.67
     107.263     0.999992       579964    131072.00
     108.927     0.999993       579965    145635.56
     108.927     0.999994       579965    163840.00
     108.927     0.999995       579965    187245.71
     117.247     0.999995       579966    218453.33
     117.247     0.999996       579966    262144.00
     122.559     0.999997       579967    291271.11
     122.559     0.999997       579967    327680.00
     122.559     0.999997       579967    374491.43
     122.559     0.999998       579967    436906.67
     122.559     0.999998       579967    524288.00
     123.903     0.999998       579968    582542.22
     123.903     1.000000       579968          inf
[Mean    =        4.187, StdDeviation   =        4.509]
[Max     =      123.840, Total count    =       579968]
[Buckets =           27, SubBuckets     =         2048]

Requests/sec:   2000.20
Transfer/sec:    139.50KB
```

Асинхронная реализация
```
ubuntu@ubuntu-Aspire-A715-72G:~/wrk2$ ./wrk -t64  -c64 -d5m -R2000 -s get.lua --latency http://127.0.0.1:8081
Running 5m test @ http://127.0.0.1:8081
  64 threads and 64 connections

  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.10ms    1.11ms  13.80ms   81.28%
    Req/Sec    14.01     35.59   111.00     86.54%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.04ms
 75.000%    2.52ms
 90.000%    3.00ms
 99.000%    6.80ms
 99.900%    8.86ms
 99.990%   10.76ms
 99.999%   13.07ms
100.000%   13.81ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.171     0.000000            1         1.00
       0.936     0.100000        22012         1.11
       1.254     0.200000        44007         1.25
       1.530     0.300000        65989         1.43
       1.814     0.400000        88033         1.67
       2.037     0.500000       110015         2.00
       2.135     0.550000       121026         2.22
       2.227     0.600000       132076         2.50
       2.317     0.650000       142959         2.86
       2.413     0.700000       153989         3.33
       2.517     0.750000       164944         4.00
       2.575     0.775000       170577         4.44
       2.635     0.800000       175907         5.00
       2.703     0.825000       181468         5.71
       2.781     0.850000       186932         6.67
       2.877     0.875000       192486         8.00
       2.933     0.887500       195172         8.89
       3.001     0.900000       197953        10.00
       3.079     0.912500       200708        11.43
       3.189     0.925000       203410        13.33
       3.349     0.937500       206164        16.00
       3.473     0.943750       207519        17.78
       3.653     0.950000       208892        20.00
       3.987     0.956250       210265        22.86
       4.463     0.962500       211633        26.67
       4.975     0.968750       213007        32.00
       5.235     0.971875       213702        35.56
       5.475     0.975000       214392        40.00
       5.727     0.978125       215082        45.71
       5.979     0.981250       215759        53.33
       6.247     0.984375       216448        64.00
       6.387     0.985938       216799        71.11
       6.547     0.987500       217138        80.00
       6.711     0.989062       217478        91.43
       6.875     0.990625       217822       106.67
       7.079     0.992188       218164       128.00
       7.179     0.992969       218336       142.22
       7.299     0.993750       218505       160.00
       7.443     0.994531       218680       182.86
       7.591     0.995313       218850       213.33
       7.731     0.996094       219022       256.00
       7.823     0.996484       219107       284.44
       7.915     0.996875       219194       320.00
       8.031     0.997266       219277       365.71
       8.163     0.997656       219364       426.67
       8.327     0.998047       219452       512.00
       8.423     0.998242       219497       568.89
       8.519     0.998437       219535       640.00
       8.615     0.998633       219578       731.43
       8.759     0.998828       219624       853.33
       8.887     0.999023       219665      1024.00
       8.983     0.999121       219686      1137.78
       9.063     0.999219       219707      1280.00
       9.151     0.999316       219729      1462.86
       9.263     0.999414       219753      1706.67
       9.399     0.999512       219772      2048.00
       9.463     0.999561       219782      2275.56
       9.607     0.999609       219793      2560.00
       9.743     0.999658       219803      2925.71
       9.807     0.999707       219815      3413.33
      10.007     0.999756       219825      4096.00
      10.055     0.999780       219830      4551.11
      10.135     0.999805       219836      5120.00
      10.263     0.999829       219841      5851.43
      10.367     0.999854       219846      6826.67
      10.607     0.999878       219852      8192.00
      10.703     0.999890       219854      9102.22
      10.759     0.999902       219857     10240.00
      10.943     0.999915       219860     11702.86
      11.015     0.999927       219862     13653.33
      11.103     0.999939       219865     16384.00
      11.111     0.999945       219866     18204.44
      11.247     0.999951       219868     20480.00
      11.271     0.999957       219869     23405.71
      11.943     0.999963       219870     27306.67
      12.031     0.999969       219872     32768.00
      12.031     0.999973       219872     36408.89
      12.127     0.999976       219873     40960.00
      12.319     0.999979       219874     46811.43
      12.319     0.999982       219874     54613.33
      12.479     0.999985       219875     65536.00
      12.479     0.999986       219875     72817.78
      13.071     0.999988       219876     81920.00
      13.071     0.999989       219876     93622.86
      13.071     0.999991       219876    109226.67
      13.367     0.999992       219877    131072.00
      13.367     0.999993       219877    145635.56
      13.367     0.999994       219877    163840.00
      13.367     0.999995       219877    187245.71
      13.367     0.999995       219877    218453.33
      13.807     0.999996       219878    262144.00
      13.807     1.000000       219878          inf
[Mean    =        2.099, StdDeviation   =        1.109]
[Max     =       13.800, Total count    =       219878]
[Buckets =           27, SubBuckets     =         2048]

Requests/sec:    764.91
Transfer/sec:     52.93KB

```
В среднем новая реализация обгоняет старую в 1,6 раза.
на 99% разница увеличивается до 2 раз
на 99,9% разница увеличивается до 4 раз

## CPU
Старая реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/old%20ver/get/cpu.svg)

Асинхронная реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/async/get/cpu.svg)

Распределение сэмплов на селектор one.nio и менеджер селекторов java.net на 4% больше того , сколько раньше было распеделено на селекторы. Появились новые сэмплы  ForkJoinWorker (3%) . На сам метод get количество уменьшилось до 5% . Количество сэмплов сервиса (распределение запросов, поиск нод в топологии и т.д.) уменьшилось в несколько раз. Появились новые сэмплы относящиеся к Completablefuture (23%) и к новому клиенту (21%).

## ALLOC
Старая реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/old%20ver/get/alloc.svg)

Асинхронная реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/async/get/alloc.svg)

На селекторы количество сэмплов на 13% больше. На сам запрос к dao  расход почти такой же. Добавились новые расходы на Completablefuture (31%) и новый клиент (8%) , распределение сэмплов на сервис также уменьшилось в несколько раз.

Старая реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/old%20ver/get/heap.png)

Асинхронная реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/async/get/heap.png)

Приблизительно такие же расходы.

## LOCK 
Старая реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/old%20ver/get/lock.svg)

Асинхронная реализация
![image](https://github.com/re1nex/2020-highload-dht/blob/hw6/profile_info/async/get/lock.svg)

Появились локи java.net SelectorManager(14%). Количество локов связанных c get из dao почти не изменилось. Появились дополнительные локи связанные с фьючами (31%) и новым клиентом (41%).

