# PUT
## wrk

Реализация без репликации

./wrk  -c64 -d3m -R2000 -s put.lua --latency http://127.0.0.1:8081
Running 3m test @ http://127.0.0.1:8081
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.31ms  609.39us  27.17ms   76.43%
    Req/Sec     1.05k    92.63     3.56k    83.88%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.26ms
 75.000%    1.64ms
 90.000%    1.97ms
 99.000%    2.60ms
 99.900%    5.61ms
 99.990%   14.73ms
 99.999%   26.03ms
100.000%   27.18ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.086     0.000000            1         1.00
       0.656     0.100000        34004         1.11
       0.841     0.200000        68083         1.25
       0.987     0.300000       102023         1.43
       1.123     0.400000       136019         1.67
       1.256     0.500000       170021         2.00
       1.326     0.550000       186983         2.22
       1.398     0.600000       203809         2.50
       1.472     0.650000       220916         2.86
       1.551     0.700000       237858         3.33
       1.639     0.750000       254822         4.00
       1.686     0.775000       263251         4.44
       1.735     0.800000       271752         5.00
       1.788     0.825000       280291         5.71
       1.843     0.850000       288758         6.67
       1.902     0.875000       297297         8.00
       1.935     0.887500       301549         8.89
       1.974     0.900000       305751        10.00
       2.023     0.912500       309962        11.43
       2.083     0.925000       314239        13.33
       2.155     0.937500       318467        16.00
       2.197     0.943750       320588        17.78
       2.243     0.950000       322750        20.00
       2.293     0.956250       324880        22.86
       2.345     0.962500       326995        26.67
       2.395     0.968750       329081        32.00
       2.421     0.971875       330211        35.56
       2.445     0.975000       331195        40.00
       2.475     0.978125       332321        45.71
       2.503     0.981250       333313        53.33
       2.535     0.984375       334384        64.00
       2.553     0.985938       334935        71.11
       2.569     0.987500       335437        80.00
       2.589     0.989062       335994        91.43
       2.611     0.990625       336504       106.67
       2.635     0.992188       337026       128.00
       2.649     0.992969       337309       142.22
       2.665     0.993750       337581       160.00
       2.681     0.994531       337827       182.86
       2.705     0.995313       338097       213.33
       2.729     0.996094       338355       256.00
       2.747     0.996484       338486       284.44
       2.769     0.996875       338623       320.00
       2.793     0.997266       338758       365.71
       2.823     0.997656       338884       426.67
       2.879     0.998047       339018       512.00
       2.919     0.998242       339084       568.89
       3.003     0.998437       339148       640.00
       3.213     0.998633       339214       731.43
       4.159     0.998828       339281       853.33
       5.843     0.999023       339347      1024.00
       6.627     0.999121       339380      1137.78
       7.435     0.999219       339413      1280.00
       8.311     0.999316       339446      1462.86
       9.255     0.999414       339479      1706.67
      10.471     0.999512       339513      2048.00
      11.047     0.999561       339529      2275.56
      11.511     0.999609       339546      2560.00
      11.879     0.999658       339562      2925.71
      12.351     0.999707       339580      3413.33
      12.791     0.999756       339596      4096.00
      13.159     0.999780       339604      4551.11
      13.391     0.999805       339612      5120.00
      13.815     0.999829       339620      5851.43
      13.935     0.999854       339629      6826.67
      14.311     0.999878       339637      8192.00
      14.655     0.999890       339641      9102.22
      15.103     0.999902       339645     10240.00
      15.639     0.999915       339649     11702.86
      16.655     0.999927       339654     13653.33
      18.095     0.999939       339658     16384.00
      18.367     0.999945       339660     18204.44
      20.111     0.999951       339662     20480.00
      20.639     0.999957       339664     23405.71
      21.679     0.999963       339666     27306.67
      23.199     0.999969       339668     32768.00
      23.215     0.999973       339669     36408.89
      23.807     0.999976       339670     40960.00
      23.855     0.999979       339671     46811.43
      25.487     0.999982       339672     54613.33
      25.615     0.999985       339673     65536.00
      25.679     0.999986       339674     72817.78
      25.679     0.999988       339674     81920.00
      26.031     0.999989       339675     93622.86
      26.031     0.999991       339675    109226.67
      26.063     0.999992       339676    131072.00
      26.063     0.999993       339676    145635.56
      26.063     0.999994       339676    163840.00
      26.463     0.999995       339677    187245.71
      26.463     0.999995       339677    218453.33
      26.463     0.999996       339677    262144.00
      26.463     0.999997       339677    291271.11
      26.463     0.999997       339677    327680.00
      27.183     0.999997       339678    374491.43
      27.183     1.000000       339678          inf
[Mean    =        1.308, StdDeviation   =        0.609]
[Max     =       27.168, Total count    =       339678]
[Buckets =           27, SubBuckets     =         2048]

  359876 requests in 3.00m, 27.53MB read
Requests/sec:   1999.31
Transfer/sec:    156.62KB


Реализация c репликацией

./wrk  -c64 -d3m -R2000 -s put.lua --latency http://127.0.0.1:8081
Running 3m test @ http://127.0.0.1:8081
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.69ms  798.46us  21.71ms   85.39%
    Req/Sec     1.05k   114.68     2.89k    82.46%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.61ms
 75.000%    1.98ms
 90.000%    2.49ms
 99.000%    3.00ms
 99.900%   12.83ms
 99.990%   17.14ms
 99.999%   20.06ms
100.000%   21.73ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.119     0.000000            1         1.00
       1.018     0.100000        34008         1.11
       1.170     0.200000        67939         1.25
       1.319     0.300000       102096         1.43
       1.468     0.400000       135886         1.67
       1.607     0.500000       170073         2.00
       1.672     0.550000       186832         2.22
       1.739     0.600000       203987         2.50
       1.808     0.650000       220908         2.86
       1.883     0.700000       237792         3.33
       1.976     0.750000       254912         4.00
       2.032     0.775000       263277         4.44
       2.099     0.800000       271940         5.00
       2.175     0.825000       280280         5.71
       2.267     0.850000       288836         6.67
       2.373     0.875000       297318         8.00
       2.429     0.887500       301526         8.89
       2.487     0.900000       305733        10.00
       2.545     0.912500       310004        11.43
       2.601     0.925000       314238        13.33
       2.659     0.937500       318458        16.00
       2.689     0.943750       320613        17.78
       2.719     0.950000       322713        20.00
       2.751     0.956250       324821        22.86
       2.783     0.962500       326958        26.67
       2.817     0.968750       329073        32.00
       2.835     0.971875       330157        35.56
       2.855     0.975000       331250        40.00
       2.877     0.978125       332313        45.71
       2.901     0.981250       333405        53.33
       2.927     0.984375       334383        64.00
       2.943     0.985938       334917        71.11
       2.961     0.987500       335468        80.00
       2.983     0.989062       336005        91.43
       3.007     0.990625       336525       106.67
       3.041     0.992188       337035       128.00
       3.065     0.992969       337303       142.22
       3.095     0.993750       337571       160.00
       3.149     0.994531       337821       182.86
       3.459     0.995313       338085       213.33
       4.875     0.996094       338352       256.00
       5.743     0.996484       338485       284.44
       6.679     0.996875       338616       320.00
       7.675     0.997266       338749       365.71
       8.831     0.997656       338881       426.67
      10.023     0.998047       339015       512.00
      10.679     0.998242       339081       568.89
      11.263     0.998437       339147       640.00
      11.975     0.998633       339213       731.43
      12.359     0.998828       339281       853.33
      12.919     0.999023       339346      1024.00
      13.175     0.999121       339379      1137.78
      13.591     0.999219       339412      1280.00
      14.039     0.999316       339445      1462.86
      14.439     0.999414       339479      1706.67
      14.911     0.999512       339512      2048.00
      15.135     0.999561       339528      2275.56
      15.479     0.999609       339545      2560.00
      15.719     0.999658       339561      2925.71
      15.959     0.999707       339578      3413.33
      16.175     0.999756       339595      4096.00
      16.415     0.999780       339605      4551.11
      16.559     0.999805       339612      5120.00
      16.639     0.999829       339619      5851.43
      16.815     0.999854       339628      6826.67
      16.991     0.999878       339636      8192.00
      17.055     0.999890       339640      9102.22
      17.183     0.999902       339644     10240.00
      17.407     0.999915       339649     11702.86
      17.679     0.999927       339653     13653.33
      17.951     0.999939       339657     16384.00
      17.999     0.999945       339659     18204.44
      18.239     0.999951       339661     20480.00
      18.351     0.999957       339663     23405.71
      18.399     0.999963       339665     27306.67
      18.543     0.999969       339667     32768.00
      18.687     0.999973       339668     36408.89
      18.799     0.999976       339669     40960.00
      18.943     0.999979       339670     46811.43
      18.959     0.999982       339671     54613.33
      19.359     0.999985       339672     65536.00
      19.903     0.999986       339673     72817.78
      19.903     0.999988       339673     81920.00
      20.063     0.999989       339674     93622.86
      20.063     0.999991       339674    109226.67
      20.239     0.999992       339675    131072.00
      20.239     0.999993       339675    145635.56
      20.239     0.999994       339675    163840.00
      20.319     0.999995       339676    187245.71
      20.319     0.999995       339676    218453.33
      20.319     0.999996       339676    262144.00
      20.319     0.999997       339676    291271.11
      20.319     0.999997       339676    327680.00
      21.727     0.999997       339677    374491.43
      21.727     1.000000       339677          inf
[Mean    =        1.689, StdDeviation   =        0.798]
[Max     =       21.712, Total count    =       339677]
[Buckets =           27, SubBuckets     =         2048]
  359874 requests in 3.00m, 23.00MB read
Requests/sec:   1999.30
Transfer/sec:    130.82KB

По средним показателяи новая реализация в 1,3 раза медленнее, т.к. запись происходит сразу на несколько нод , а не просто переадресация как в случае старой реализации. Но на 99.999% начинает обгонять, скорее всего в это время началась сборка мусора у старой реализации, поэтому показатели просели. 

## CPU
Реализация без репликации
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/old%20ver/put/cpu.svg)

Реализация c репликацией
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/with%20replica/put/cpu.svg)

Количество сэмплов относящихся к сервису увеличилось на 6 %. 28 % занимает управление репликами (их переадресация на другие ноды, вставка в локальное хранилище) 12 % занимают запросы от родительской ноды. Результаты показывают, что новая реализация более требовательная к ресурсам cpu, что было ожидаемо.

## ALLOC
Реализация без репликации
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/old%20ver/put/alloc.svg)

Реализация c репликацией
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/with%20replica/put/alloc.svg)

По аллокациям в новой реализации уходит больше на селекторы (на 10%), это связано с тем, что каждый запрос по сути включает в себя еще 2 дополнительных на реплики, а в случае старой реализации всего 1 запрос на нужную ноду. Уменьшился общий вклад HttpClient.invoke, т.к. появилось большое число синхронных запросов, которые тоже достаточно ресурсоемкие.

## LOCK 
Реализация без репликации
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/old%20ver/put/lock.svg)

Реализация c репликацией
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/with%20replica/put/lock.svg)


Количество сэмплов селекторов берущих задачи под локами увеличилось, что было ожидаемо, т.к. больше дополнительных запросов приходится обрабатывать

# Get
## wrk

Реализация без репликации
./wrk  -c64 -d3m -R2000 -s get.lua --latency http://127.0.0.1:8081
Running 3m test @ http://127.0.0.1:8081
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.61ms  783.46us  18.82ms   72.19%
    Req/Sec     1.06k     1.06k    3.56k    85.17%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.53ms
 75.000%    2.04ms
 90.000%    2.57ms
 99.000%    3.65ms
 99.900%    4.58ms
 99.990%   15.77ms
 99.999%   18.33ms
100.000%   18.83ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.066     0.000000            1         1.00
       0.735     0.100000        34024         1.11
       0.968     0.200000        67997         1.25
       1.170     0.300000       102060         1.43
       1.356     0.400000       135973         1.67
       1.532     0.500000       169981         2.00
       1.619     0.550000       186929         2.22
       1.709     0.600000       203901         2.50
       1.804     0.650000       220871         2.86
       1.908     0.700000       237803         3.33
       2.036     0.750000       254800         4.00
       2.111     0.775000       263305         4.44
       2.191     0.800000       271872         5.00
       2.275     0.825000       280401         5.71
       2.361     0.850000       288820         6.67
       2.457     0.875000       297328         8.00
       2.509     0.887500       301490         8.89
       2.565     0.900000       305731        10.00
       2.631     0.912500       309989        11.43
       2.709     0.925000       314230        13.33
       2.809     0.937500       318493        16.00
       2.865     0.943750       320616        17.78
       2.929     0.950000       322717        20.00
       2.999     0.956250       324864        22.86
       3.077     0.962500       326967        26.67
       3.167     0.968750       329070        32.00
       3.217     0.971875       330135        35.56
       3.271     0.975000       331181        40.00
       3.333     0.978125       332243        45.71
       3.405     0.981250       333302        53.33
       3.485     0.984375       334382        64.00
       3.525     0.985938       334886        71.11
       3.573     0.987500       335426        80.00
       3.623     0.989062       335955        91.43
       3.681     0.990625       336488       106.67
       3.747     0.992188       337011       128.00
       3.781     0.992969       337274       142.22
       3.819     0.993750       337544       160.00
       3.861     0.994531       337807       182.86
       3.911     0.995313       338076       213.33
       3.959     0.996094       338339       256.00
       3.991     0.996484       338482       284.44
       4.021     0.996875       338605       320.00
       4.053     0.997266       338735       365.71
       4.093     0.997656       338866       426.67
       4.147     0.998047       339001       512.00
       4.183     0.998242       339065       568.89
       4.227     0.998437       339136       640.00
       4.279     0.998633       339199       731.43
       4.363     0.998828       339264       853.33
       4.691     0.999023       339333      1024.00
       6.039     0.999121       339364      1137.78
       8.303     0.999219       339397      1280.00
      10.015     0.999316       339431      1462.86
      11.055     0.999414       339463      1706.67
      11.663     0.999512       339498      2048.00
      11.791     0.999561       339513      2275.56
      11.959     0.999609       339530      2560.00
      12.135     0.999658       339546      2925.71
      12.303     0.999707       339563      3413.33
      12.519     0.999756       339580      4096.00
      12.615     0.999780       339588      4551.11
      12.695     0.999805       339596      5120.00
      12.887     0.999829       339604      5851.43
      13.119     0.999854       339613      6826.67
      13.775     0.999878       339621      8192.00
      14.319     0.999890       339625      9102.22
      15.911     0.999902       339629     10240.00
      16.351     0.999915       339633     11702.86
      16.847     0.999927       339638     13653.33
      17.151     0.999939       339642     16384.00
      17.567     0.999945       339644     18204.44
      17.631     0.999951       339647     20480.00
      17.663     0.999957       339648     23405.71
      17.807     0.999963       339651     27306.67
      17.839     0.999969       339652     32768.00
      17.935     0.999973       339653     36408.89
      17.983     0.999976       339654     40960.00
      17.999     0.999979       339655     46811.43
      18.095     0.999982       339656     54613.33
      18.271     0.999985       339657     65536.00
      18.303     0.999986       339658     72817.78
      18.303     0.999988       339658     81920.00
      18.335     0.999989       339659     93622.86
      18.335     0.999991       339659    109226.67
      18.527     0.999992       339660    131072.00
      18.527     0.999993       339660    145635.56
      18.527     0.999994       339660    163840.00
      18.767     0.999995       339661    187245.71
      18.767     0.999995       339661    218453.33
      18.767     0.999996       339661    262144.00
      18.767     0.999997       339661    291271.11
      18.767     0.999997       339661    327680.00
      18.831     0.999997       339662    374491.43
      18.831     1.000000       339662          inf
[Mean    =        1.612, StdDeviation   =        0.783]
[Max     =       18.816, Total count    =       339662]
[Buckets =           27, SubBuckets     =         2048]

  358947 requests in 3.00m, 29.63MB read
Requests/sec:   1994.05
Transfer/sec:    168.58KB


Реализация с репликацией

./wrk  -c64 -d3m -R2000 -s get.lua --latency http://127.0.0.1:8081
Running 3m test @ http://127.0.0.1:8081
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.66ms  518.32us  11.94ms   70.14%
    Req/Sec     1.05k    86.56     2.00k    82.76%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.62ms
 75.000%    1.96ms
 90.000%    2.37ms
 99.000%    2.96ms
 99.900%    3.75ms
 99.990%    7.88ms
 99.999%   10.61ms
100.000%   11.94ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.115     0.000000            1         1.00
       1.057     0.100000        34064         1.11
       1.224     0.200000        68114         1.25
       1.366     0.300000       102009         1.43
       1.492     0.400000       135977         1.67
       1.616     0.500000       169986         2.00
       1.680     0.550000       187065         2.22
       1.744     0.600000       203850         2.50
       1.811     0.650000       220823         2.86
       1.883     0.700000       237998         3.33
       1.960     0.750000       254932         4.00
       2.003     0.775000       263257         4.44
       2.053     0.800000       271892         5.00
       2.109     0.825000       280323         5.71
       2.177     0.850000       288760         6.67
       2.263     0.875000       297253         8.00
       2.313     0.887500       301468         8.89
       2.367     0.900000       305758        10.00
       2.425     0.912500       310075        11.43
       2.485     0.925000       314222        13.33
       2.553     0.937500       318541        16.00
       2.589     0.943750       320678        17.78
       2.627     0.950000       322793        20.00
       2.665     0.956250       324907        22.86
       2.707     0.962500       326999        26.67
       2.753     0.968750       329108        32.00
       2.777     0.971875       330175        35.56
       2.803     0.975000       331213        40.00
       2.833     0.978125       332297        45.71
       2.863     0.981250       333333        53.33
       2.895     0.984375       334394        64.00
       2.913     0.985938       334960        71.11
       2.931     0.987500       335448        80.00
       2.953     0.989062       336001        91.43
       2.975     0.990625       336502       106.67
       3.003     0.992188       337056       128.00
       3.017     0.992969       337321       142.22
       3.031     0.993750       337581       160.00
       3.049     0.994531       337841       182.86
       3.069     0.995313       338093       213.33
       3.093     0.996094       338361       256.00
       3.107     0.996484       338490       284.44
       3.123     0.996875       338630       320.00
       3.143     0.997266       338756       365.71
       3.173     0.997656       338891       426.67
       3.209     0.998047       339023       512.00
       3.239     0.998242       339081       568.89
       3.283     0.998437       339148       640.00
       3.383     0.998633       339216       731.43
       3.547     0.998828       339280       853.33
       3.791     0.999023       339347      1024.00
       3.893     0.999121       339380      1137.78
       4.023     0.999219       339414      1280.00
       4.159     0.999316       339446      1462.86
       4.351     0.999414       339479      1706.67
       4.547     0.999512       339514      2048.00
       4.679     0.999561       339529      2275.56
       4.899     0.999609       339546      2560.00
       5.083     0.999658       339562      2925.71
       5.435     0.999707       339579      3413.33
       5.931     0.999756       339596      4096.00
       6.087     0.999780       339604      4551.11
       6.339     0.999805       339612      5120.00
       6.623     0.999829       339620      5851.43
       6.951     0.999854       339629      6826.67
       7.423     0.999878       339637      8192.00
       7.663     0.999890       339641      9102.22
       7.951     0.999902       339645     10240.00
       8.303     0.999915       339649     11702.86
       9.055     0.999927       339655     13653.33
       9.647     0.999939       339658     16384.00
       9.719     0.999945       339660     18204.44
       9.855     0.999951       339662     20480.00
       9.871     0.999957       339664     23405.71
       9.879     0.999963       339666     27306.67
      10.127     0.999969       339668     32768.00
      10.175     0.999973       339669     36408.89
      10.183     0.999976       339671     40960.00
      10.183     0.999979       339671     46811.43
      10.303     0.999982       339672     54613.33
      10.311     0.999985       339673     65536.00
      10.615     0.999986       339675     72817.78
      10.615     0.999988       339675     81920.00
      10.615     0.999989       339675     93622.86
      10.615     0.999991       339675    109226.67
      10.727     0.999992       339676    131072.00
      10.727     0.999993       339676    145635.56
      10.727     0.999994       339676    163840.00
      11.311     0.999995       339677    187245.71
      11.311     0.999995       339677    218453.33
      11.311     0.999996       339677    262144.00
      11.311     0.999997       339677    291271.11
      11.311     0.999997       339677    327680.00
      11.943     0.999997       339678    374491.43
      11.943     1.000000       339678          inf
[Mean    =        1.664, StdDeviation   =        0.518]
[Max     =       11.936, Total count    =       339678]
[Buckets =           27, SubBuckets     =         2048]

  359874 requests in 3.00m, 25.17MB read
Requests/sec:   1999.30
Transfer/sec:    143.17KB

На 50% старая реализация получилась быстрее, но >75% новая реализация начинает обгонять, возможно связано с тем, что один из запросов выполняется синхронно и с тем, что JIT компиляция обработала больше кода .

## CPU
Реализация без репликации
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/old%20ver/get/cpu.svg)

Реализация c репликацией
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/with%20replica/get/cpu.svg)

Больше кода обработано JIT компилятором. Больше сэмплов относящихся к сервису (на 10 %), что ожидаемо т.к. больше запросов нужно обрабатывать.

## ALLOC
Реализация без репликации
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/old%20ver/get/alloc.svg)

Реализация c репликацией
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/with%20replica/get/alloc.svg)

Ситуация похожа на ситуацию с put, меньше аллокаций распределилось на переадресацию, т.к. появились синхронные запросы.

## LOCK 
Реализация без репликации
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/old%20ver/get/lock.svg)

Реализация c репликацией
![image](https://github.com/re1nex/2020-highload-dht/blob/hw5/profile_info/with%20replica/get/lock.svg)


Также как и спуть количество локов у селекторов стало больше, т.к. и запросов стало больше.
