# PUT
## wrk

Реализация без шардирования 

./wrk  -c64 -d3m -R2000 -s put.lua --latency http://127.0.0.1:8080
Running 3m test @ http://127.0.0.1:8080
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.15ms  612.25us  81.86ms   79.01%
    Req/Sec     1.05k    89.73     3.80k    82.72%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.13ms
 75.000%    1.48ms
 90.000%    1.79ms
 99.000%    2.20ms
 99.900%    2.47ms
 99.990%   22.16ms
 99.999%   55.65ms
100.000%   81.92ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.104     0.000000            1         1.00
       0.542     0.100000        34100         1.11
       0.683     0.200000        68068         1.25
       0.850     0.300000       101976         1.43
       0.997     0.400000       135894         1.67
       1.126     0.500000       169953         2.00
       1.188     0.550000       187041         2.22
       1.251     0.600000       203895         2.50
       1.321     0.650000       220991         2.86
       1.399     0.700000       237931         3.33
       1.477     0.750000       254818         4.00
       1.519     0.775000       263369         4.44
       1.563     0.800000       271890         5.00
       1.613     0.825000       280393         5.71
       1.670     0.850000       288832         6.67
       1.733     0.875000       297297         8.00
       1.764     0.887500       301521         8.89
       1.795     0.900000       305718        10.00
       1.828     0.912500       310052        11.43
       1.859     0.925000       314267        13.33
       1.891     0.937500       318464        16.00
       1.908     0.943750       320601        17.78
       1.925     0.950000       322702        20.00
       1.944     0.956250       324850        22.86
       1.966     0.962500       327017        26.67
       1.991     0.968750       329064        32.00
       2.007     0.971875       330132        35.56
       2.026     0.975000       331207        40.00
       2.049     0.978125       332269        45.71
       2.081     0.981250       333323        53.33
       2.119     0.984375       334372        64.00
       2.143     0.985938       334909        71.11
       2.167     0.987500       335440        80.00
       2.189     0.989062       335985        91.43
       2.215     0.990625       336529       106.67
       2.239     0.992188       337029       128.00
       2.255     0.992969       337308       142.22
       2.273     0.993750       337582       160.00
       2.293     0.994531       337858       182.86
       2.313     0.995313       338092       213.33
       2.339     0.996094       338381       256.00
       2.351     0.996484       338506       284.44
       2.363     0.996875       338619       320.00
       2.381     0.997266       338753       365.71
       2.399     0.997656       338896       426.67
       2.415     0.998047       339019       512.00
       2.425     0.998242       339090       568.89
       2.437     0.998437       339161       640.00
       2.447     0.998633       339226       731.43
       2.457     0.998828       339287       853.33
       2.471     0.999023       339359      1024.00
       2.477     0.999121       339387      1137.78
       2.485     0.999219       339414      1280.00
       2.501     0.999316       339452      1462.86
       2.515     0.999414       339483      1706.67
       2.543     0.999512       339513      2048.00
       2.701     0.999561       339529      2275.56
       3.569     0.999609       339546      2560.00
       4.703     0.999658       339562      2925.71
       7.855     0.999707       339579      3413.33
      10.759     0.999756       339596      4096.00
      12.471     0.999780       339604      4551.11
      14.503     0.999805       339612      5120.00
      16.495     0.999829       339620      5851.43
      18.527     0.999854       339629      6826.67
      20.063     0.999878       339637      8192.00
      21.807     0.999890       339641      9102.22
      22.191     0.999902       339645     10240.00
      23.503     0.999915       339649     11702.86
      25.839     0.999927       339654     13653.33
      27.039     0.999939       339658     16384.00
      28.431     0.999945       339660     18204.44
      29.167     0.999951       339662     20480.00
      29.695     0.999957       339664     23405.71
      30.991     0.999963       339666     27306.67
      31.711     0.999969       339668     32768.00
      32.015     0.999973       339669     36408.89
      32.671     0.999976       339670     40960.00
      33.119     0.999979       339671     46811.43
      33.919     0.999982       339672     54613.33
      50.111     0.999985       339673     65536.00
      55.007     0.999986       339674     72817.78
      55.007     0.999988       339674     81920.00
      55.647     0.999989       339675     93622.86
      55.647     0.999991       339675    109226.67
      61.183     0.999992       339676    131072.00
      61.183     0.999993       339676    145635.56
      61.183     0.999994       339676    163840.00
      65.599     0.999995       339677    187245.71
      65.599     0.999995       339677    218453.33
      65.599     0.999996       339677    262144.00
      65.599     0.999997       339677    291271.11
      65.599     0.999997       339677    327680.00
      81.919     0.999997       339678    374491.43
      81.919     1.000000       339678          inf
[Mean    =        1.151, StdDeviation   =        0.612]
[Max     =       81.856, Total count    =       339678]
[Buckets =           27, SubBuckets     =         2048]
  359874 requests in 3.00m, 22.99MB read
Requests/sec:   1999.30
Transfer/sec:    130.81KB

Реализация c шардированием

./wrk  -c64 -d3m -R2000 -s put.lua --latency http://127.0.0.1:8080
Running 3m test @ http://127.0.0.1:8080
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.64ms  815.03us  43.39ms   67.75%
    Req/Sec     1.06k     1.08k    3.56k    84.58%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.58ms
 75.000%    2.21ms
 90.000%    2.67ms
 99.000%    3.29ms
 99.900%    3.87ms
 99.990%   24.01ms
 99.999%   25.69ms
100.000%   43.42ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.043     0.000000            1         1.00
       0.643     0.100000        34035         1.11
       0.939     0.200000        67980         1.25
       1.143     0.300000       101949         1.43
       1.346     0.400000       135871         1.67
       1.577     0.500000       169862         2.00
       1.705     0.550000       186826         2.22
       1.827     0.600000       203806         2.50
       1.939     0.650000       220798         2.86
       2.065     0.700000       237860         3.33
       2.211     0.750000       254919         4.00
       2.285     0.775000       263395         4.44
       2.357     0.800000       271904         5.00
       2.427     0.825000       280289         5.71
       2.501     0.850000       288723         6.67
       2.583     0.875000       297319         8.00
       2.625     0.887500       301460         8.89
       2.673     0.900000       305817        10.00
       2.723     0.912500       309990        11.43
       2.779     0.925000       314303        13.33
       2.839     0.937500       318516        16.00
       2.873     0.943750       320625        17.78
       2.909     0.950000       322740        20.00
       2.947     0.956250       324876        22.86
       2.989     0.962500       327010        26.67
       3.035     0.968750       329081        32.00
       3.061     0.971875       330140        35.56
       3.089     0.975000       331175        40.00
       3.121     0.978125       332248        45.71
       3.157     0.981250       333310        53.33
       3.199     0.984375       334363        64.00
       3.221     0.985938       334905        71.11
       3.247     0.987500       335451        80.00
       3.273     0.989062       335967        91.43
       3.301     0.990625       336499       106.67
       3.335     0.992188       337018       128.00
       3.357     0.992969       337283       142.22
       3.381     0.993750       337548       160.00
       3.409     0.994531       337818       182.86
       3.439     0.995313       338080       213.33
       3.475     0.996094       338343       256.00
       3.497     0.996484       338470       284.44
       3.523     0.996875       338604       320.00
       3.551     0.997266       338740       365.71
       3.587     0.997656       338872       426.67
       3.639     0.998047       339008       512.00
       3.669     0.998242       339067       568.89
       3.703     0.998437       339135       640.00
       3.759     0.998633       339199       731.43
       3.809     0.998828       339265       853.33
       3.875     0.999023       339334      1024.00
       3.917     0.999121       339365      1137.78
       3.981     0.999219       339398      1280.00
       4.087     0.999316       339433      1462.86
       4.183     0.999414       339464      1706.67
       4.363     0.999512       339498      2048.00
       5.143     0.999561       339514      2275.56
       7.063     0.999609       339531      2560.00
       8.711     0.999658       339547       2925.71
       9.631     0.999707       339564      3413.33
      11.199     0.999756       339581      4096.00
      12.015     0.999780       339589      4551.11
      13.719     0.999805       339597      5120.00
      15.903     0.999829       339605      5851.43
      18.639     0.999854       339614      6826.67
      22.047     0.999878       339622      8192.00
      23.743     0.999890       339626      9102.22
      24.015     0.999902       339630     10240.00
      24.175     0.999915       339634     11702.86
      24.287     0.999927       339639     13653.33
      24.415     0.999939       339643     16384.00
      24.479     0.999945       339645     18204.44
      24.511     0.999951       339647     20480.00
      24.527     0.999957       339649     23405.71
      24.655     0.999963       339651     27306.67
      24.815     0.999969       339653     32768.00
      24.831     0.999973       339654     36408.89
      24.959     0.999976       339655     40960.00
      25.007     0.999979       339656     46811.43
      25.039     0.999982       339657     54613.33
      25.263     0.999985       339658     65536.00
      25.647     0.999986       339659     72817.78
      25.647     0.999988       339659     81920.00
      25.695     0.999989       339660     93622.86
      25.695     0.999991       339660    109226.67
      25.871     0.999992       339661    131072.00
      25.871     0.999993       339661    145635.56
      25.871     0.999994       339661    163840.00
      43.359     0.999995       339662    187245.71
      43.359     0.999995       339662    218453.33
      43.359     0.999996       339662    262144.00
      43.359     0.999997       339662    291271.11
      43.359     0.999997       339662    327680.00
      43.423     0.999997       339663    374491.43
      43.423     1.000000       339663          inf
[Mean    =        1.641, StdDeviation   =        0.815]
[Max     =       43.392, Total count    =       339663]
[Buckets =           27, SubBuckets     =         2048]
  358958 requests in 3.00m, 22.94MB read
Requests/sec:   1994.12
Transfer/sec:    130.48KB

Чуть меньше запросов в секунду обработала реализация с шардированием , но в целом результаты не очень отличаются .

## CPU
Реализация без шардирования
![image](https://user-images.githubusercontent.com/48808317/96634315-fed32b80-1322-11eb-8a5a-37fd7c2f597f.png)

Реализация c шардированием
![image](https://user-images.githubusercontent.com/48808317/96634378-13172880-1323-11eb-98f0-7c3f7202c3c1.png)

Как и ожидалось отправка асинхронных запросов в реализации с шардированием занимает больше ( около 12 % против 6 ) , ну и соответственно на upsert идет меньше, но не сильно . Остальные операции не сильно отличаются .

## ALLOC
Реализация без шардирования
![image](https://user-images.githubusercontent.com/48808317/96634668-815beb00-1323-11eb-8bca-574623ec7713.png)

Реализация с шардированием
![image](https://user-images.githubusercontent.com/48808317/96634688-891b8f80-1323-11eb-804e-780937fb971b.png)

Тут достаточно большие разлилчия , в реализации без шардирования большая часть ( около 60 % ) шла на нужды селекторов ( обработка запросов ) , в новой же реализации на селекторы расходуется только около 26 % . На отправку асинхронных запросов уходит на 4 % больше , плюс добавились операции с хеш таблицей , на primaryFor уходит около 15 %

## LOCK 
Реализация без шардирования
![image](https://user-images.githubusercontent.com/48808317/96635262-4efebd80-1324-11eb-9f8e-282a7a9f96bd.png)

Реализация с шардированием
![image](https://user-images.githubusercontent.com/48808317/96635291-57ef8f00-1324-11eb-8c20-bdd4690ac7c8.png)

Воркеры из ArrayBlockingQueue работают под локами , селекторы занимаются своей работой. У асинхронных запросов меньше локов в новой реализации .

# Get
## wrk

Реализация без шардирования
[20.10.2020 21:23] Елисей Василевский: ./wrk  -c64 -d3m -R2000 -s get.lua --latency http://127.0.0.1:8080
Running 3m test @ http://127.0.0.1:8080
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.62ms  739.86us  12.38ms   64.89%
    Req/Sec     1.05k     1.06k    3.56k    84.50%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.59ms
 75.000%    2.13ms
 90.000%    2.65ms
 99.000%    3.34ms
 99.900%    3.83ms
 99.990%    5.51ms
 99.999%   11.43ms
100.000%   12.39ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.097     0.000000            1         1.00
       0.653     0.100000        34053         1.11
       0.927     0.200000        67978         1.25
       1.143     0.300000       102061         1.43
       1.353     0.400000       135912         1.67
       1.589     0.500000       169878         2.00
       1.692     0.550000       186842         2.22
       1.791     0.600000       203824         2.50
       1.895     0.650000       220873         2.86
       2.010     0.700000       237787         3.33
       2.129     0.750000       254863         4.00
       2.195     0.775000       263313         4.44
       2.265     0.800000       271945         5.00
       2.339     0.825000       280236         5.71
       2.425     0.850000       288779         6.67
       2.531     0.875000       297250         8.00
       2.591     0.887500       301522         8.89
       2.653     0.900000       305766        10.00
       2.721     0.912500       310030        11.43
       2.791     0.925000       314203        13.33
       2.865     0.937500       318482        16.00
       2.903     0.943750       320655        17.78
       2.943     0.950000       322787        20.00
       2.983     0.956250       324859        22.86
       3.027     0.962500       326997        26.67
       3.077     0.968750       329131        32.00
       3.101     0.971875       330144        35.56
       3.131     0.975000       331189        40.00
       3.163     0.978125       332243        45.71
       3.201     0.981250       333327        53.33
       3.241     0.984375       334363        64.00
       3.267     0.985938       334921        71.11
       3.293     0.987500       335456        80.00
       3.321     0.989062       335958        91.43
       3.355     0.990625       336491       106.67
       3.393     0.992188       337016       128.00
       3.413     0.992969       337277       142.22
       3.437     0.993750       337557       160.00
       3.465     0.994531       337807       182.86
       3.495     0.995313       338074       213.33
       3.529     0.996094       338346       256.00
       3.549     0.996484       338481       284.44
       3.569     0.996875       338604       320.00
       3.595     0.997266       338741       365.71
       3.625     0.997656       338872       426.67
       3.661     0.998047       339001       512.00
       3.683     0.998242       339076       568.89
       3.705     0.998437       339133       640.00
       3.743     0.998633       339201       731.43
       3.779     0.998828       339266       853.33
       3.835     0.999023       339333      1024.00
       3.863     0.999121       339365      1137.78
       3.899     0.999219       339398      1280.00
       3.927     0.999316       339431      1462.86
       3.977     0.999414       339466      1706.67
       4.029     0.999512       339498      2048.00
       4.075     0.999561       339514      2275.56
       4.123     0.999609       339531      2560.00
       4.215     0.999658       339548      2925.71
       4.315     0.999707       339565      3413.33
       4.475     0.999756       339581      4096.00
       4.531     0.999780       339589      4551.11
       4.655     0.999805       339597      5120.00
       4.991     0.999829       339605      5851.43
       5.207     0.999854       339614      6826.67
       5.303     0.999878       339622      8192.00
       5.459     0.999890       339626      9102.22
       5.535     0.999902       339630     10240.00
       5.659     0.999915       339634     11702.86
       5.923     0.999927       339639     13653.33
       6.303     0.999939       339643     16384.00
       6.919     0.999945       339645     18204.44
       7.739     0.999951       339647     20480.00
       8.175     0.999957       339649     23405.71
       8.807     0.999963       339651     27306.67
       9.735     0.999969       339653     32768.00
       9.775     0.999973       339654     36408.89
       9.783     0.999976       339655     40960.00
      10.935     0.999979       339656     46811.43
      10.967     0.999982       339657     54613.33
      11.231     0.999985       339658     65536.00
      11.351     0.999986       339659     72817.78
      11.351     0.999988       339659     81920.00
      11.431     0.999989       339660     93622.86
      11.431     0.999991       339660    109226.67
      11.959     0.999992       339661    131072.00
      11.959     0.999993       339661    145635.56
      11.959     0.999994       339661    163840.00
      12.063     0.999995       339662    187245.71
      12.063     0.999995       339662    218453.33
      12.063     0.999996       339662    262144.00
      12.063     0.999997       339662    291271.11
      12.063     0.999997       339662    327680.00
      12.391     0.999997       339663    374491.43
      12.391     1.000000       339663          inf
[Mean    =        1.621, StdDeviation   =        0.740]
[Max     =       12.384, Total count    =       339663]
[Buckets =           27, SubBuckets     =         2048]

  358967 requests in 3.00m, 25.10MB read
Requests/sec:   1994.14
Transfer/sec:    142.80KB

Реализация с шардированием

 ./wrk  -c64 -d3m -R2000 -s get.lua --latency http://127.0.0.1:8080
Running 3m test @ http://127.0.0.1:8080
  2 threads and 64 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.16ms  484.83us  22.77ms   64.11%
    Req/Sec     1.05k    83.54     3.00k    85.12%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.14ms
 75.000%    1.51ms
 90.000%    1.80ms
 99.000%    2.16ms
 99.900%    2.44ms
 99.990%    8.49ms
 99.999%   21.90ms
100.000%   22.78ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.084     0.000000            1         1.00
       0.567     0.100000        34006         1.11
       0.701     0.200000        67999         1.25
       0.850     0.300000       102013         1.43
       1.003     0.400000       135939         1.67
       1.145     0.500000       170017         2.00
       1.212     0.550000       187014         2.22
       1.281     0.600000       203985         2.50
       1.351     0.650000       220958         2.86
       1.428     0.700000       237940         3.33
       1.512     0.750000       254812         4.00
       1.558     0.775000       263423         4.44
       1.603     0.800000       271757         5.00
       1.651     0.825000       280277         5.71
       1.699     0.850000       288803         6.67
       1.751     0.875000       297366         8.00
       1.777     0.887500       301465         8.89
       1.805     0.900000       305753        10.00
       1.834     0.912500       310078        11.43
       1.863     0.925000       314263        13.33
       1.893     0.937500       318534        16.00
       1.908     0.943750       320645        17.78
       1.924     0.950000       322710        20.00
       1.942     0.956250       324881        22.86
       1.961     0.962500       326943        26.67
       1.985     0.968750       329082        32.00
       2.000     0.971875       330198        35.56
       2.016     0.975000       331204        40.00
       2.035     0.978125       332260        45.71
       2.059     0.981250       333360        53.33
       2.089     0.984375       334426        64.00
       2.107     0.985938       334950        71.11
       2.127     0.987500       335467        80.00
       2.147     0.989062       335989        91.43
       2.169     0.990625       336502       106.67
       2.197     0.992188       337053       128.00
       2.211     0.992969       337319       142.22
       2.225     0.993750       337556       160.00
       2.245     0.994531       337827       182.86
       2.271     0.995313       338099       213.33
       2.305     0.996094       338359       256.00
       2.321     0.996484       338489       284.44
       2.341     0.996875       338624       320.00
       2.357     0.997266       338752       365.71
       2.373     0.997656       338886       426.67
       2.391     0.998047       339021       512.00
       2.401     0.998242       339091       568.89
       2.409     0.998437       339150       640.00
       2.421     0.998633       339223       731.43
       2.431     0.998828       339290       853.33
       2.445     0.999023       339355      1024.00
       2.451     0.999121       339381      1137.78
       2.459     0.999219       339416      1280.00
       2.471     0.999316       339450      1462.86
       2.485     0.999414       339480      1706.67
       2.521     0.999512       339513      2048.00
       2.553     0.999561       339529      2275.56
       2.615     0.999609       339546      2560.00
       2.857     0.999658       339562     2925.71
       3.361     0.999707       339579      3413.33
       4.199     0.999756       339597      4096.00
       4.703     0.999780       339604      4551.11
       5.503     0.999805       339612      5120.00
       6.455     0.999829       339620      5851.43
       7.087     0.999854       339629      6826.67
       8.079     0.999878       339637      8192.00
       8.359     0.999890       339641      9102.22
       8.511     0.999902       339645     10240.00
       9.071     0.999915       339649     11702.86
      10.775     0.999927       339654     13653.33
      13.111     0.999939       339658     16384.00
      13.583     0.999945       339660     18204.44
      14.391     0.999951       339662     20480.00
      15.767     0.999957       339664     23405.71
      17.103     0.999963       339666     27306.67
      17.887     0.999969       339668     32768.00
      18.207     0.999973       339669     36408.89
      18.783     0.999976       339670     40960.00
      19.535     0.999979       339671     46811.43
      19.807     0.999982       339672     54613.33
      20.879     0.999985       339673     65536.00
      21.471     0.999986       339674     72817.78
      21.471     0.999988       339674     81920.00
      21.903     0.999989       339675     93622.86
      21.903     0.999991       339675    109226.67
      22.207     0.999992       339676    131072.00
      22.207     0.999993       339676    145635.56
      22.207     0.999994       339676    163840.00
      22.463     0.999995       339677    187245.71
      22.463     0.999995       339677    218453.33
      22.463     0.999996       339677    262144.00
      22.463     0.999997       339677    291271.11
      22.463     0.999997       339677    327680.00
      22.783     0.999997       339678    374491.43
      22.783     1.000000       339678          inf
[Mean    =        1.165, StdDeviation   =        0.485]
[Max     =       22.768, Total count    =       339678]
[Buckets =           27, SubBuckets     =         2048]

  359875 requests in 3.00m, 25.17MB read
Requests/sec:   1999.30
Transfer/sec:    143.17KB

Сильных различий не увидел

## CPU
Реализация без шардирования
![image](https://user-images.githubusercontent.com/48808317/96636449-fc260580-1325-11eb-9d90-03e2175f348e.png)


Реализация с шардированием
![image](https://user-images.githubusercontent.com/48808317/96636485-05af6d80-1326-11eb-9a47-ee2bbf861afc.png)

Здесь получилась ситуация немного обратная , на асинхронные запросы в старой версии уходит на 4 % больше , но это скорее всего из-за того, что данные все на одной ноде , и  их искать там дольше . В остальном разницы особо не увидел , скорее всего из-за того , что операция поиска более дорогостоящая.

## ALLOC
Реализация без шардирования
![image](https://user-images.githubusercontent.com/48808317/96636922-9e45ed80-1326-11eb-96f1-a1310aa658f7.png)

Реализация с шардированием
![image](https://user-images.githubusercontent.com/48808317/96636858-90906800-1326-11eb-829c-f4934b6f175e.png)

В новой реализации на 2% больше уходит на асинхронные запросы , и появились расходы на хеш таблицу ( около 9%)

## LOCK 
Реализация без шардирования
![image](https://user-images.githubusercontent.com/48808317/95793436-41c34c80-0cee-11eb-85ac-3c2f36e3e2cd.png)
Реализация с шардированием
![image](https://user-images.githubusercontent.com/48808317/95793447-46880080-0cee-11eb-8332-125f526f19d5.png)

Почти тоже самое , что и с put 